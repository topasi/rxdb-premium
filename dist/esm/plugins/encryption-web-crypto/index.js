import{hasEncryption as e,newRxError as a,newRxTypeError as t,b64DecodeUnicode as r,b64EncodeUnicode as s,wrapRxStorageInstance as n}from"rxdb/plugins/core";import{clone as c,ensureNotFalsy as o,flatClone as i,getProperty as m,setProperty as d}from"rxdb/plugins/utils";import{decryptString as p,encryptString as h,getCryptoKey as l,getDefaultSeed as u,MINIMUM_PASSWORD_LENGTH as w}from"./helpers.js";export*from"./helpers.js";export function wrappedKeyEncryptionWebCryptoStorage(t){var w=t.salt?t.salt:u();return Object.assign({},t.storage,{async createStorageInstance(u){var g,y;if(void 0!==u.password&&v(u.password),!e(u.schema))return await t.storage.createStorageInstance(u);var b=o(u.schema.encrypted);if(!u.password)throw a("EN3",{database:u.databaseName,collection:u.collectionName,schema:u.schema});var T=c(u.schema);delete T.encrypted,T.attachments&&(T.attachments.encrypted=!1);var E=u.password,N=E.password,P=E.algorithm,[j,S]=await Promise.all([l(N,P,w),t.storage.createStorageInstance(Object.assign({},u,{schema:T}))]);function O(){return g||(g={decToEnc:new Map,encToDec:new Map},y=setTimeout((()=>{g=void 0}),2e4)),g}function _(e){var a=O().decToEnc.get(e);return a||(a=h(j,P,e),O().decToEnc.set(e,a),a.then((()=>a=>O().encToDec.set(a,Promise.resolve(e))))),a}function x(e,a){if(!a)return p(j,P,e);var t=O().encToDec.get(e);return t||(t=p(j,P,e),O().encToDec.set(e,t),t.then((a=>O().decToEnc.set(a,Promise.resolve(e))))),t}async function D(e){if(e=f(e),await Promise.all(b.map((async a=>{var t=m(e,a);if(void 0!==t){var r=JSON.stringify(t),s=await _(r);d(e,a,s)}}))),u.schema.attachments&&u.schema.attachments.encrypted){var a={};await Promise.all(Object.entries(e._attachments).map((async([e,t])=>{var r=i(t);if(r.data){var n=r.data,c=await _(n);r.data=s(c)}a[e]=r}))),e._attachments=a}return e}async function I(e){return e=f(e),await Promise.all(b.map((async a=>{var t=m(e,a);if(void 0!==t){var r=await x(t,!0),s=JSON.parse(r);d(e,a,s)}}))),e}async function J(e){return u.schema.attachments&&u.schema.attachments.encrypted?await x(r(e),!1):e}var M=n(u.schema,S,D,I,J),C=M.remove.bind(M);M.remove=()=>(y&&clearTimeout(y),C());var K=M.close.bind(M);return M.close=()=>(y&&clearTimeout(y),K()),M}})}function f(e){var a=e._attachments;return delete(e=i(e))._attachments,(e=c(e))._attachments=a,e}function v(e){if("object"!=typeof e)throw t("EN4",{password:e});if(!e.algorithm||!e.password)throw t("EN1",{password:e});if(e.password.length<w)throw a("EN2",{minPassLength:w,password:e})}