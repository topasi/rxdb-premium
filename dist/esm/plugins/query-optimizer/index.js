import{clone as e,createRevision as r,fillWithDefaultSettings as a,getFromMapOrThrow as t,getPrimaryFieldOfPrimaryKey as n,normalizeMangoQuery as i,prepareQuery as s,randomCouchString as o,requestIdlePromise as d,shuffleArray as m}from"rxdb/plugins/core";import{averageOfTimeValues as c,getFieldsOfQuery as f,sortIndexTimes as p}from"./query-optimizer-helper.js";import*as v from"percom";export async function findBestIndex(l){var u=n(l.schema.primaryKey),x=l.maxFieldsPerIndex?l.maxFieldsPerIndex:4,h=e(a(l.schema)),w=new Map,y=new Map,I={},b={};Object.entries(l.queries).forEach((([e,r])=>{I[e]=r,b[e]=new Map;var a=Array.from(f(h,r)).filter((e=>e!==u)),t=new Map;y.set(e,t),new Array(x).fill(0).forEach(((e,r)=>{var n=r+1;a.length>=n&&v.per(a,n).forEach((e=>{var r=e.join(",");w.set(r,e),t.set(r,e)}))}))})),h.indexes=Array.from(w.values()).filter((e=>1!==e.length||e[0]!==u)),h=a(h);var _=o(10),q=await l.storage.createStorageInstance({schema:h,databaseName:"findBestIndex_"+o(6),collectionName:"findBestIndex_"+o(6),multiInstance:!1,databaseInstanceToken:_,options:l.instanceCreationOptions?l.instanceCreationOptions:{},devMode:!1});await q.bulkWrite(l.testData.map((e=>{var a=Object.assign({_rev:"",_deleted:!1,_meta:{lwt:1},_attachments:{}},e);return a._rev=r(_,a),{document:a}})),"query-optimizer");for(var j=0;j<l.runs;){for(var[O,g]of Object.entries(I)){var M=t(y,O),A=Array.from(M.entries());for(var[E,B]of A=m(A)){await d(),await d(),await d();var k=e(g);k.selector._deleted=!1,k.index=B,"_deleted"!==k.index[0]&&k.index.unshift("_deleted");var z=s(h,i(h,k));await d();var C=performance.now();await q.query(z);var F=performance.now()-C,N=b[O],P=N.has(E)?t(N,E):[];P.push(F),N.set(E,P)}}j++}var S=new Map;Object.entries(b).forEach((([e,r])=>{var a=Array.from(r.entries()).map((([e,r])=>{var a=t(w,e);return a.shift(),r=r.sort(((e,r)=>e-r)),{index:a,time:c(r,66)}}));a=p(a),S.set(e,a)})),await q.remove();var D={queries:{},indexesInSchema:h.indexes};return Object.entries(l.queries).forEach((([e,r])=>{var a=t(S,e),n=a[0];D.queries[e]={query:r,bestIndex:n,allIndexes:a}})),D}