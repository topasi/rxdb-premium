import{PassThrough as e}from"node:stream";import r from"koa";import{ensureNotFalsy as o,getFromMapOrCreate as s,getFromMapOrThrow as t}from"rxdb/plugins/core";import a from"koa-router";import n from"@koa/cors";import{bodyParser as _}from"@koa/bodyparser";export var HTTP_SERVER_BY_KOA=new WeakMap;export var ROUTER_BY_KOA=new WeakMap;export var KOA_SSR_STREAM_BY_CONTEXT=new WeakMap;export var RxServerAdapterKoa={async create(){var e=new r({});e.use(_());var o=new a;return ROUTER_BY_KOA.set(e,o),e},setCors(e,r,o){e.use(n({origin:o}))},getRequestBody:e=>e.request.body,getRequestHeaders:e=>e.request.headers,getRequestQuery:e=>e.query,onRequestClose(e,r){e.req.on("close",(()=>{r()}))},setResponseHeader(e,r,o){e.set(r,o)},responseWrite(e,r){var o=KOA_SSR_STREAM_BY_CONTEXT.get(e);o?o.write(r):e.res.write(r)},endResponseJson(e,r){e.status=200,e.body=r},endResponse(e){e.res.end()},async closeConnection(e,r,o){var s={code:r,error:!0,message:o};e.status=r,e.body=s},setSSEHeaders(r){r.status=200,r.set({"Content-Type":"text/event-stream; charset=utf-8",Connection:"keep-alive","Cache-Control":"no-cache","X-Accel-Buffering":"no"});var o=s(KOA_SSR_STREAM_BY_CONTEXT,r,(()=>new e));r.body=o},get(e,r,o){t(ROUTER_BY_KOA,e).get(r,(e=>o(e,e)))},post(e,r,o){t(ROUTER_BY_KOA,e).post(r,(e=>o(e,e)))},all(e,r,o){t(ROUTER_BY_KOA,e).all(r,(e=>o(e,e)))},async listen(e,r,s){var a=t(ROUTER_BY_KOA,e);e.use(a.routes());var n=await new Promise(((t,a)=>{var n=o(e).listen(r,s,(()=>{t(n)}))}));HTTP_SERVER_BY_KOA.set(e,n)},async close(e){var r=t(HTTP_SERVER_BY_KOA,e);await new Promise(((e,o)=>{r.close((r=>{r?o(r):e()})),setImmediate((()=>r.emit("close")))}))},async closeAllConnections(e){var r=HTTP_SERVER_BY_KOA.get(e);r&&await r.closeAllConnections()}};