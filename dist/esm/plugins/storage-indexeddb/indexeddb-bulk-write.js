import{PROMISE_RESOLVE_FALSE as t,categorizeBulkWriteRows as e,ensureNotFalsy as a,now as n,promiseWait as r,requestIdlePromiseNoQueue as o}from"rxdb/plugins/core";import{attachmentObjectId as s,ensureNotClosed as c,createTx as m,runReadTask as d,indexedDBHasAtLeastOneRow as h}from"./indexeddb-helpers.js";import{indexedDBFindByIdsInternal as i}from"./indexeddb-find-by-ids.js";export async function bulkWrite(l,u,p){var v=l.primaryPath,w=l.internals,f=l.internals.state;await f.creationPromise;var g=[w.storeNames.documentStore,w.storeNames.writeAheadStore];l.schema.attachments&&g.push(w.storeNames.attachmentsStore),c(l);var I,b=await m(l),y=b.objectStore(w.storeNames.documentStore);I=0===l.internals.minKnownDocsAmount&&u.length>30&&!await h(l,y)?new Map:await i(v,y,u);for(var D=e(l,v,I,u,p),S=D.errors,k=D.bulkInsertDocs,A=new Array(k.length),N=0;N<k.length;++N){var P=k[N].document;A[N]=P}for(var j=D.bulkUpdateDocs,x=0;x<j.length;++x){var W=j[x].document;A.push(W)}if(A.length>0){var B=b.objectStore(w.storeNames.writeAheadStore).put({i:"documents",docsData:JSON.stringify(A)});await new Promise(((t,e)=>{B.onerror=e,B.onsuccess=t})),l.handleWalIdlePromise||r(100).then((()=>o())).then((async()=>{l.handleWalIdlePromise=void 0,l.closed||await d(l,(()=>t))}))}var E=void 0;if(l.schema.attachments){var R=b.objectStore(l.internals.storeNames.attachmentsStore);D.attachmentsAdd.forEach((t=>{E=R.put({docIdWithAttachmentId:s(t.documentId,t.attachmentId),length:t.attachmentData.length,type:t.attachmentData.type,data:t.attachmentData.data})})),D.attachmentsUpdate.forEach((t=>{E=R.put({docIdWithAttachmentId:s(t.documentId,t.attachmentId),length:t.attachmentData.length,type:t.attachmentData.type,data:t.attachmentData.data})})),D.attachmentsRemove.forEach((t=>{E=R.delete(s(t.documentId,t.attachmentId))}))}if(E&&await new Promise(((t,e)=>{a(E).onerror=e,a(E).onsuccess=t})),b.commit&&b.commit(),D.eventBulk.events.length>0){var U=a(D.newestRow).document;D.eventBulk.checkpoint={id:U[v],lwt:U._meta.lwt},D.eventBulk.endTime=n(),l.changes$.next(D.eventBulk)}return{error:S}}