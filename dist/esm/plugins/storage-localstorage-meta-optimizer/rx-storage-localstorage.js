import e from"@babel/runtime/helpers/readOnlyError";import{categorizeBulkWriteRows as t,ensureRxStorageInstanceParamsAreCorrect as a,getPrimaryFieldOfPrimaryKey as r,lastOfArray as s,now as n,PROMISE_RESOLVE_TRUE as o,PROMISE_RESOLVE_VOID as i,newRxError as c,getQueryMatcher as h,getSortComparator as l}from"rxdb/plugins/core";import{Subject as g}from"rxjs";import{RXDB_PREMIUM_VERSION as m}from"../shared/rxdb-premium-version.js";export var RX_STORAGE_NAME_LOCALSTORAGE="localstorage";export var RxStorageLocalstorage=function(){function e(e){this.name=RX_STORAGE_NAME_LOCALSTORAGE,this.rxdbVersion=m,this.settings=e}return e.prototype.createStorageInstance=function(e){return a(e),createLocalstorageStorageInstance(this,e,Object.assign({},this.settings,e.options))},e}();export function getRxStorageLocalstorage(e={}){return new RxStorageLocalstorage(e)}var u=new g,d=!1;export function getStorageEventStream(){return d||(d=!0,window.addEventListener("storage",(e=>{e.key&&u.next({fromStorageEvent:!0,key:e.key,newValue:e.newValue})}))),u.asObservable()}export var RxStorageInstanceLocalstorage=function(){function e(e,t,a,s,n,o,i,c){this.changes$=new g,this.storage=e,this.databaseName=t,this.collectionName=a,this.schema=s,this.internals=n,this.options=o,this.settings=i,this.databaseInstanceToken=c,this.primaryPath=r(this.schema.primaryKey),this.storageKey="rx-storage-localstorage-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changestreamStorageKey="rx-storage-localstorage-changestream-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changeStreamSub=getStorageEventStream().subscribe((e=>{if(e.key===this.changestreamStorageKey&&e.newValue&&(!e.fromStorageEvent||e.databaseInstanceToken!==this.databaseInstanceToken)){var t=JSON.parse(e.newValue);e.fromStorageEvent&&t.databaseInstanceToken===this.databaseInstanceToken||(this.changes$.next(t.eventBulk),this.internals.docsById=getStorageState(this.primaryPath,this.storageKey))}}))}var a=e.prototype;return a.bulkWrite=async function(e,a){var r={error:[]},s=t(this,this.primaryPath,this.internals.docsById,e,a);r.error=s.errors;var n=!1;if([s.bulkInsertDocs,s.bulkUpdateDocs].forEach((e=>{e.forEach((e=>{n=!0;var t=e.document[this.primaryPath];this.internals.docsById.set(t,e.document)}))})),n&&localstoragePersist(this),s.eventBulk.events.length>0){var o={databaseInstanceToken:this.databaseInstanceToken,eventBulk:s.eventBulk},i=JSON.stringify(o);localStorage.setItem(this.changestreamStorageKey,i),u.next({fromStorageEvent:!1,key:this.changestreamStorageKey,newValue:i,databaseInstanceToken:this.databaseInstanceToken})}return r},a.findDocumentsById=async function(e,t){var a=[],r=this.internals.docsById;return e.forEach((e=>{var s=r.get(e);s&&(!t&&s._deleted||a.push(s))})),a},a.query=async function(e){var t=e.query,a=t.skip?t.skip:0,r=a+(t.limit?t.limit:1/0),s=h(this.schema,t),n=Array.from(this.internals.docsById.values()).filter((e=>s(e))),o=l(this.schema,t);return{documents:n.sort(o).slice(a,r)}},a.count=async function(e){return{count:(await this.query(e)).documents.length,mode:"fast"}},a.getChangedDocumentsSince=async function(e,t){var a=Array.from(this.internals.docsById.values());t&&(a=a.filter((e=>e._meta.lwt>t.lwt||e._meta.lwt===t.lwt&&e[this.primaryPath]>t.id)));var r=a.slice(0,e),n=s(r);return{documents:r,checkpoint:n?{id:n[this.primaryPath],lwt:n._meta.lwt}:t||{id:"",lwt:0}}},a.changeStream=function(){return this.changes$.asObservable()},a.cleanup=function(e){var t=n()-e,a=!1;return Object.entries(this.internals.docsById).forEach((([e,r])=>{r._deleted&&(r._meta.lwt>t||(this.internals.docsById.delete(e),a=!0))})),a&&localstoragePersist(this),o},a.getAttachmentData=function(e,t){throw c("SNH")},a.remove=function(){return localStorage.removeItem(this.storageKey),localStorage.removeItem(this.changestreamStorageKey),i},a.close=function(){return this.closed||(this.closed=(async()=>{this.changes$.complete(),this.changeStreamSub.unsubscribe(),localStorage.removeItem(this.changestreamStorageKey)})()),this.closed},a.conflictResultionTasks=function(){return(new g).asObservable()},a.resolveConflictResultionTask=function(e){return i},e}();export function localstoragePersist(e){localStorage.setItem(e.storageKey,JSON.stringify(Array.from(e.internals.docsById.values())))}export async function createLocalstorageStorageInstance(e,t,a){var r={docsById:new Map},s=new RxStorageInstanceLocalstorage(e,t.databaseName,t.collectionName,t.schema,r,t.options,a,t.databaseInstanceToken);return r.docsById=getStorageState(s.primaryPath,s.storageKey),s}export function getStorageState(e,t){var a=localStorage.getItem(t),r=new Map;a&&JSON.parse(a).forEach((t=>{var a=t[e];r.set(a,t)}));return r}