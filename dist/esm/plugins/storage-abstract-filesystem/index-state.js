import{ensureNotFalsy as t,getIndexStringLength as e,getIndexableStringMonad as i,getPrimaryFieldOfPrimaryKey as r,getPrimaryKeyFromIndexableString as s,toArray as n}from"rxdb/plugins/core";import{CLEANUP_INDEX as a,getIndexName as o}from"../storage-indexeddb/index.js";import{compareIndexRows as h,toPaddedString as p}from"./helpers.js";import{AbstractFile as d}from"./file-abstraction.js";import{boundEQ as m}from"rxdb/plugins/storage-memory";import{pushAtSortPosition as x}from"array-push-at-sort-position";export var IndexState=function(){function n(s,n,a,h,p){this.rows=[],this.indexId=s,this.index=n,this.schema=h,this.jsonPositionSize=p,this.name=o(this.index),this.fileHandle=a.then((t=>t.getFileHandle(getIndexFileName(s),{create:!0}))),this.getIndexableString=i(this.schema,this.index),this.indexableStringLength=e(this.schema,this.index),this.primaryPath=r(this.schema.primaryKey),this.primaryKeyLength=t(this.schema.properties[this.primaryPath].maxLength),this.metaIdMap=0===s?new Map:void 0,this.indexFile=new d(this.fileHandle,0,[{type:"string",length:this.indexableStringLength},{type:"number",length:p},{type:"number",length:p}])}var a=n.prototype;return a.initRead=async function(t){this.metaIdMap&&this.metaIdMap.clear(),await this.indexFile.readRows(t,0,(t=>{var[e,i,r]=t,n=s(e,this.primaryKeyLength).trim(),a=[e,n,i,r];this.metaIdMap&&this.metaIdMap.set(n,a),this.rows.push(a)}))},a.runChangelogOperation=function(t){var e=t[1],i=t[3],r=i[1];if("A"===t[2])this.rows.splice(e,0,i),this.metaIdMap&&this.metaIdMap.set(r,i);else if("D"===t[2])this.rows.splice(e,1),this.metaIdMap&&this.metaIdMap.delete(r);else{if("R"!==t[2])throw new Error("unknown operation key "+t[2]);this.rows[e]=i,this.metaIdMap&&this.metaIdMap.set(r,i)}},a.appendWriteOperations=function(e,i,r){for(var s=[],n=e.length,a=0;a<n;a++){var o=e[a],p=i[a],d=o.documentId,u=this.getIndexableString(o.documentData),l=o.previousDocumentData?this.getIndexableString(o.previousDocumentData):null,I=l?m(this.rows,[l],h):-1,g=[u,d,p[0],p[1]];this.metaIdMap&&this.metaIdMap.set(d,g),u===l?(this.rows[I]=g,r.push([this.indexId,I,"R",[u,d,p[0],p[1]]])):(o.previousDocumentData&&(this.rows.splice(I,1),r.push([this.indexId,I,"D",[t(l),d,p[0],p[1]]])),s.push(g))}for(var c=0,f=(s=s.sort(sortByIndexStringComparator)).length,y=0;y<f;y++){var w=s[y];c=x(this.rows,w,sortByIndexStringComparator,c),r.push([this.indexId,c,"A",w])}return r},a.changeDocumentPosition=function(t,e){var i=this.getIndexableString(t),r=m(this.rows,[i],h),s=[i,t[this.primaryPath],e[0],e[1]];return this.rows[r]=s,[this.indexId,r,"R",s]},n}();export function sortByIndexStringComparator(t,e){return t[0]<e[0]?-1:1}export var INDEX_ROW_ID_LENGTH=8;export var INDEX_ID_LENGTH=5;export function getIndexFileName(t){return"index-"+p(t,5)+".txt"}export function getIndexesFromSchema(t){var e=r(t.primaryKey),i=n(t.indexes?t.indexes:[]);(i=(i=sortIndexes(i)).map((t=>t.slice(0)))).push(["_meta.lwt",e]),i.push(a);var s=new Set,h=i.slice();return i=h.filter((t=>{var e=o(t);return!s.has(e)&&(s.add(e),!0)}))}export function sortIndexes(t){return t.map((t=>({index:t,str:t.join(",")}))).sort(((t,e)=>t.str>e.str?1:t.str<e.str?-1:0)).map((t=>t.index))}