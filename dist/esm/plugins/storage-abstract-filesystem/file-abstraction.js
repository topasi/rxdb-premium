import{sumNumberArray as e}from"rxdb/plugins/core";import{getAccessHandle as t}from"./task-queue.js";import{iterateStringCells as a,readFileContent as r}from"./file-helpers.js";import{toPaddedString as i}from"./helpers.js";var n=new TextDecoder,s=new TextEncoder;export var AbstractFile=function(){function h(t,a,r){this.fileHandle=t,this.headerSize=a,this.cells=r,this.cellSizes=r.map((e=>e.length)),this.rowLength=e(this.cellSizes)}var c=h.prototype;return c.getAccessHandle=function(e){return this.fileHandle.then((a=>t(a,e)))},c.readHeader=async function(e){var t=await this.getAccessHandle(e),a=await t.read(0,this.headerSize);if(a.find((e=>0!==e))){var r=n.decode(a).trim();return JSON.parse(r)}},c.writeHeader=async function(e,t){var a=s.encode(JSON.stringify(t).padStart(this.headerSize," ")),r=await this.getAccessHandle(e),i=await r.getWritable();await i.write(a,{at:0})},c.readRows=async function(e,t,i){var n=await this.getAccessHandle(e),s=this.headerSize+t*this.rowLength,h=await r(n,s);a(h,this.cellSizes,(e=>{var t=this.cells.map(((t,a)=>{var r=e[a];if("number"===t.type)return parseInt(r,10);if("string"===t.type)return r;throw new Error("unknown type "+t.type)}));i(t)}))},c.getRowString=function(e){for(var t="",a=this.cells,r=a.length,n=0;n<r;n++){var s=a[n],h=e[n];"number"===s.type?t+=i(h,a[n].length):t+=h}return t},c.appendRows=async function(e,t){var a=await this.getAccessHandle(e),r=await a.getSize();r<this.headerSize&&(r=this.headerSize);for(var i="",n=this.rowLength,h=t.length,c=0;c<h;c++){var o=t[c],l=this.getRowString(o);if(l.length!==n)throw new Error("rowString has wrong length ("+l.length+")");i+=l}var w=s.encode(i),d=await a.getWritable();return await d.write(w,{at:r}),{startPosition:r}},c.replaceContent=async function(e,t){var a=await this.getAccessHandle(e),r=t.map((e=>this.getRowString(e))).join(""),i=s.encode(r),n=await a.getWritable();await n.write(i,{at:this.headerSize});var h=this.headerSize+r.length;await a.truncate(h)},c.empty=async function(e){var t=await this.getAccessHandle(e);await t.truncate(this.headerSize)},h}();