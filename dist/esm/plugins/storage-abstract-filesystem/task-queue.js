import{PROMISE_RESOLVE_VOID as e}from"rxdb/plugins/core";export var TaskQueue=function(){function t(t,a){this.queue=e,this.readTasks=[],this.beforeTaskReadOrWrite=[],this.lockId=t,this.abstractLock=a}var a=t.prototype;return a.runRead=function(e){return new Promise(((t,a)=>{this.readTasks.push((s=>e(s).then((e=>t(e))).catch((e=>a(e))))),this.triggerReadTasks()}))},a.triggerReadTasks=function(){this.queue=this.queue.then((()=>{if(0!==this.readTasks.length)return this.abstractLock.request(this.lockId,(async()=>{var e=this.readTasks;this.readTasks=[];var t={type:"READ",taskAmount:e.length,accessHandlers:new Map,awaitBeforeFinish:[]};return await Promise.all(this.beforeTaskReadOrWrite.map((e=>e(t)))),Promise.all(e.map((e=>e(t)))).then((()=>this.cleanupAfterRun(t)))}))})).catch((e=>{console.log("ERROR TaskQueue.triggerReadTasks.queue errored:"),console.log(e)}))},a.runWrite=function(e){return new Promise(((t,a)=>{this.queue=this.queue.then((()=>this.abstractLock.request(this.lockId,(async()=>{var s={type:"WRITE",taskAmount:1,accessHandlers:new Map,awaitBeforeFinish:[]};return await Promise.all(this.beforeTaskReadOrWrite.map((e=>e(s)))),e(s).then((e=>{t(e)})).catch((e=>a(e))).then((()=>this.cleanupAfterRun(s)))}))))}))},a.runInit=function(e){return new Promise(((t,a)=>{this.queue=this.queue.then((()=>this.abstractLock.request(this.lockId,(async()=>{var s={type:"INIT",taskAmount:1,accessHandlers:new Map,awaitBeforeFinish:[]};return e(s).then((e=>t(e))).catch((e=>a(e))).then((()=>this.cleanupAfterRun(s)))}))))}))},a.cleanupAfterRun=async function(e){await Promise.all(e.awaitBeforeFinish.map((e=>e()))),await Promise.all(Array.from(e.accessHandlers.values()).map((e=>e.then((e=>e.close())).catch((e=>{})))))},a.awaitIdle=async function(){for(;;){var e=this.queue;if(await this.queue,this.queue===e)return}},t}();export function getAccessHandle(e,t){var a=t.accessHandlers.get(e);return a||(a=e.createAccessHandle(),t.accessHandlers.set(e,a)),a}export function getLockId(e){return["rxdb","abstract-filesystem","task-queue-lock",e.databaseName,e.collectionName,e.schema.version].join("||")}