import{ensureNotFalsy as e,getPrimaryFieldOfPrimaryKey as a,maxOfNumbers as t}from"rxdb/plugins/core";import{getAccessHandle as n}from"./task-queue.js";import{getChangelogFile as r,getChangelogOperations as o}from"./changelog.js";import{IndexState as i,getIndexesFromSchema as s}from"./index-state.js";import{Subject as c}from"rxjs";export async function getStorageInstanceInternalState(m,l,d,g){var h=m.getDirectory(),p=getDirectoryPath({databaseName:l.databaseName,collectionName:l.collectionName,schemaVersion:l.schema.version}),u=h.then((e=>e.getDirectoryHandle(p,{create:!0}))),f=u.then((e=>e.getFileHandle("documents.json",{create:!0})));return d.runInit((async m=>{var p=f.then((e=>n(e,m))),x=u.then((e=>e.getFileHandle("changes.json",{create:!0}))),b=a(l.schema.primaryKey),y=e(l.schema.properties[b].maxLength),v=s(l.schema).map(((e,a)=>new i(a,e,u,l.schema,g))),w=t(v.map((e=>e.indexableStringLength))),I=r(u,w,g),S=await p;if(await S.getSize()>0){var[C,N]=await Promise.all([Promise.all(v.map((e=>e.initRead(m)))),o(m,I,v,0)]);Array.from(N.operationsByIndexId.entries()).map((([e,a])=>{var t=v[e];a.forEach((e=>t.runChangelogOperation(e)))}))}var j=l.multiInstance?new BroadcastChannel(d.lockId):void 0;j&&j.unref&&j.unref();var D=new c;return j&&(j.onmessage=e=>{var a=e.data;D.next(a)}),{params:l,taskQueue:d,indexStates:v,primaryPath:b,primaryKeyLength:y,root:await h,dirHandle:await u,changesFileHandle:await x,documentFileHandle:await f,changelogFile:I,maxIndexableStringLength:w,broadcastChannel:j,broadcastChannelMessages$:D,mightHaveUnprocessedChanges:!1}}))}export function toPaddedString(e,a){return(e+"").padStart(a,"number"==typeof e?"0":" ")}export var DEFAULT_DOC_JSON_POSITION_SIZE=8;function m(e){return e.replace(/\//g,"__")}export function getDirectoryPath(e){return["rxdb",m(e.databaseName),m(e.collectionName),e.schemaVersion].join("-")}export function getTotalDocumentCount(a){return e(a.indexStates[0]).rows.length}export function compareIndexRows(e,a){return e[0]<a[0]?-1:e[0]===a[0]?0:1}export function broadcastChangelogOperations(e,a,t,n){if(a.broadcastChannel){var r={type:"event",eventBulk:n,changelogOperations:t,info:{db:e.databaseName,col:e.collectionName}};a.broadcastChannel.postMessage(r)}}