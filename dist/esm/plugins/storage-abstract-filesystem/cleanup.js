import{ensureNotFalsy as e,getStartIndexStringFromLowerBound as a,getStartIndexStringFromUpperBound as t,lastOfArray as n,now as r}from"rxdb/plugins/core";import{CLEANUP_INDEX as i,getIndexName as o}from"../storage-indexeddb/index.js";import{getAccessHandle as s}from"./task-queue.js";import{boundLT as l,boundEQ as g,boundGT as c}from"rxdb/plugins/storage-memory";import{ENCODER as d,getDocumentsJson as m}from"./documents-file.js";import{addChangelogOperations as p,getChangelogOperations as u}from"./changelog.js";import{broadcastChangelogOperations as w,compareIndexRows as f}from"./helpers.js";var h=o(i);export async function cleanup(e,a,t){return!((await cleanupDeletedDocuments(e,a,t)).length>0)&&(!((await cleanupChangelogOperations(e,a)).length>0)&&!(await cleanupDocumentJsonFile(e,a)>0))}export async function cleanupDeletedDocuments(n,o,d){var u=await n.internals.statePromise,w=e(u.indexStates.find((e=>e.name===h))),x=r()-d,v=a(n.schema,i,[!0,1]),S=t(n.schema,i,[!0,x]),b=c(w.rows,[v],f),F=l(w.rows,[S],f);if(-1===b)return[];var y=w.rows.slice(b,F+1),D=[],I=await s(u.documentFileHandle,o);for(var C of y){var j=C[1];D.push(j);var P=(await m(u,I,o,[C]))[0],O=[];for(var H of u.indexStates){var J=H.getIndexableString(P),L=g(H.rows,[J],f),W=[H.indexId,L,"D",H.rows[L]];O.push(W),H.runChangelogOperation(W)}await p(o,u.changelogFile,O,u.maxIndexableStringLength)}return D}export async function cleanupChangelogOperations(e,a){var t=await e.internals.statePromise,n=await u(a,t.changelogFile,t.indexStates,0),r=t.indexStates.filter((e=>{var a=n.operationsByIndexId.get(e.indexId);return!(!a||0===a.length)}));for(var i of r)await i.indexFile.replaceContent(a,i.rows.map((e=>[e[0],e[2],e[3]])));return r.length>0&&await t.changelogFile.empty(a),r}export async function cleanupDocumentJsonFile(a,t){var r=await a.internals.statePromise,i=e(r.indexStates.find((e=>"_meta.lwt"===e.index[0])));if(!n(i.rows))return 0;var o=await s(r.documentFileHandle,t),l=await o.getSize();r.broadcastChannel&&r.broadcastChannel.postMessage({type:"pre-write",mightHaveUnprocessedChanges:!0});for(var g=50,c=0,u=0,f=0;;){if(u>=g)return u;var h=i.rows[f];if(f+=1,!h)return c<l&&await o.truncate(c),u;var x=h[2],v=h[3];if(x===c)c=v;else{u+=1;var S=(await m(r,o,t,[h]))[0],b=c,F=x-b,y=d.encode(" ".repeat(F)),D=await o.getWritable();await D.write(y,{at:b});var I=[];for(var C of r.indexStates){var j=C.changeDocumentPosition(S,[b,v]);I.push(j)}await p(t,r.changelogFile,I,r.maxIndexableStringLength),w(a,r,I);var P=JSON.stringify(S),O=P.length,H=d.encode(P+" ".repeat(F-O));D=await o.getWritable(),await D.write(H,{at:b});var J=b+O,L=[];for(var W of r.indexStates){var k=W.changeDocumentPosition(S,[b,J]);L.push(k)}await p(t,r.changelogFile,L,r.maxIndexableStringLength),w(a,r,L),c+=O}}}