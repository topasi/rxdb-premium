import{getPrimaryFieldOfPrimaryKey as r,getSchemaByObjectPath as e,randomCouchString as t}from"rxdb/plugins/core";import{getJsonExtract as n,isPlainObject as o,PARAM_KEY as a}from"./sqlite-helpers.js";var u=["$or","$and"];export function mangoQuerySelectorToSQL(s,p,i,l){var c=r(s.primaryKey);return"("+Object.entries(p).map((([r,p])=>{if(!r.startsWith("$"))return o(p)?mangoQuerySelectorToSQL(s,p,i,r):(i.push(p),n(c,r)+"="+a);if(u.includes(r)){var h=" "+r.substring(1).toUpperCase()+" ",m=p.map((r=>mangoQuerySelectorToSQL(s,r,i,l)));return m.length>1?"("+m.join(h)+")":m.join(h)}if(!l)throw new Error("cannot have selector operator on the top level "+r);switch(r){case"$eq":return null===p?n(c,l)+" IS NULL":(i.push(p),n(c,l)+"="+a);case"$ne":if(null===p)return n(c,l)+" IS NOT NULL";i.push(p);var S=n(c,l)+"!="+a;return null===p?S:"("+S+" OR ("+n(c,l)+" IS NULL))";case"$gt":return i.push(p),n(c,l)+">"+a;case"$gte":return i.push(p),n(c,l)+">="+a;case"$lt":return i.push(p),n(c,l)+"<"+a;case"$lte":return i.push(p),n(c,l)+"<="+a;case"$exists":return p?(i.push("rand-"+t(10)),n(c,l)+"!="+a):n(c,l)+" IS NULL";case"$in":p.forEach((r=>i.push(r)));var L=e(s,l);return L&&"array"===L.type?"EXISTS (SELECT 1 FROM json_each("+n(c,l)+") WHERE value IN ("+new Array(p.length).fill(a).join(",")+"))":n(c,l)+" IN ("+new Array(p.length).fill(a).join(",")+")";case"$nin":return i.push(p),n(c,l)+" NOT IN ("+a+")";default:var f=new Error("operator "+r+" not implemented");throw f.operator=r,f.isNonImplementedOperatorError=!0,f}})).join(" AND ")+")"}export function mangoQuerySortToSQL(r,e){return"ORDER BY "+e.map((e=>{var[t,o]=Object.entries(e)[0];return n(r,t)+" "+o.toUpperCase()})).join(", ")}