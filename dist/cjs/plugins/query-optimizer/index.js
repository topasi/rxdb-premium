Object.defineProperty(exports,"__esModule",{value:!0}),exports.findBestIndex=i;var e=require("rxdb/plugins/core"),r=require("./query-optimizer-helper.js"),t=n(require("percom"));function a(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(a=function(e){return e?t:r})(e)}function n(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=a(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&{}.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,t&&t.set(e,n),n}async function i(a){var n=(0,e.getPrimaryFieldOfPrimaryKey)(a.schema.primaryKey),i=a.maxFieldsPerIndex?a.maxFieldsPerIndex:4,o=(0,e.clone)((0,e.fillWithDefaultSettings)(a.schema)),s=new Map,u=new Map,l={},f={};Object.entries(a.queries).forEach((([e,a])=>{l[e]=a,f[e]=new Map;var c=Array.from((0,r.getFieldsOfQuery)(o,a)).filter((e=>e!==n)),d=new Map;u.set(e,d),new Array(i).fill(0).forEach(((e,r)=>{var a=r+1;c.length>=a&&t.per(c,a).forEach((e=>{var r=e.join(",");s.set(r,e),d.set(r,e)}))}))})),o.indexes=Array.from(s.values()).filter((e=>1!==e.length||e[0]!==n)),o=(0,e.fillWithDefaultSettings)(o);var c=(0,e.randomCouchString)(10),d=await a.storage.createStorageInstance({schema:o,databaseName:"findBestIndex_"+(0,e.randomCouchString)(6),collectionName:"findBestIndex_"+(0,e.randomCouchString)(6),multiInstance:!1,databaseInstanceToken:c,options:a.instanceCreationOptions?a.instanceCreationOptions:{},devMode:!1});await d.bulkWrite(a.testData.map((r=>{var t=Object.assign({_rev:"",_deleted:!1,_meta:{lwt:1},_attachments:{}},r);return t._rev=(0,e.createRevision)(c,t),{document:t}})),"query-optimizer");for(var p=0;p<a.runs;){for(var[m,v]of Object.entries(l)){var h=(0,e.getFromMapOrThrow)(u,m),y=Array.from(h.entries());for(var[w,g]of y=(0,e.shuffleArray)(y)){await(0,e.requestIdlePromise)(),await(0,e.requestIdlePromise)(),await(0,e.requestIdlePromise)();var O=(0,e.clone)(v);O.selector._deleted=!1,O.index=g,"_deleted"!==O.index[0]&&O.index.unshift("_deleted");var x=(0,e.prepareQuery)(o,(0,e.normalizeMangoQuery)(o,O));await(0,e.requestIdlePromise)();var _=performance.now();await d.query(x);var b=performance.now()-_,I=f[m],M=I.has(w)?(0,e.getFromMapOrThrow)(I,w):[];M.push(b),I.set(w,M)}}p++}var q=new Map;Object.entries(f).forEach((([t,a])=>{var n=Array.from(a.entries()).map((([t,a])=>{var n=(0,e.getFromMapOrThrow)(s,t);return n.shift(),a=a.sort(((e,r)=>e-r)),{index:n,time:(0,r.averageOfTimeValues)(a,66)}}));n=(0,r.sortIndexTimes)(n),q.set(t,n)})),await d.remove();var P={queries:{},indexesInSchema:o.indexes};return Object.entries(a.queries).forEach((([r,t])=>{var a=(0,e.getFromMapOrThrow)(q,r),n=a[0];P.queries[r]={query:t,bestIndex:n,allIndexes:a}})),P}