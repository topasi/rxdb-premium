Object.defineProperty(exports,"__esModule",{value:!0}),exports.appendAttachmentFiles=n,exports.clearDeletedAttachments=c,exports.getAttachmentData=i,exports.getAttachmentFilename=s;var t=require("rxdb/plugins/core"),a=require("./task-queue.js"),e=require("./documents-file.js");async function n(n,c,i,r){if(c.schema.attachments){var d=i.attachmentsAdd.concat(i.attachmentsUpdate);0!==d.length&&await Promise.all(d.map((async c=>{var i=await s(c.documentId,c.attachmentId,(0,t.attachmentWriteDataToNormalData)(c.attachmentData).digest),d=await r.dirHandle.getFileHandle(i,{create:!0}),m=await(0,a.getAccessHandle)(d,n);await m.truncate(0);var o=e.ENCODER.encode(c.attachmentData.data),l=await m.getWritable();await l.write(o,{at:0}),l.flush&&await l.flush(),await l.close()})))}}async function c(a,e,n,c){if(e.schema.attachments){var i=[];c.events.forEach((a=>{a.previousDocumentData&&Object.keys(a.previousDocumentData._attachments).forEach((e=>{a.documentData._attachments[e]&&!a.documentData._deleted||i.push({documentId:a.documentId,attachmentId:e,digest:(0,t.ensureNotFalsy)(a.previousDocumentData)._attachments[e].digest})}))})),0!==i.length&&await Promise.all(i.map((async t=>{var a=await s(t.documentId,t.attachmentId,t.digest),e=await n.dirHandle.getFileHandle(a,{create:!0});await n.dirHandle.removeEntry(e.name)})))}}async function i(t,n,c,i,r){var d=await n.internals.statePromise,m=await s(c,i,r),o=await d.dirHandle.getFileHandle(m,{create:!1}),l=await(0,a.getAccessHandle)(o,t),u=await l.read(0);return e.DECODER.decode(u)}async function s(a,e,n){return"z-attachment-"+(await(0,t.defaultHashSha256)(a+"||"+e)).slice(0,20)+"-"+n.slice(0,20)+".txt"}