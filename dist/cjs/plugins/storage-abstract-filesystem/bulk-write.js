Object.defineProperty(exports,"__esModule",{value:!0}),exports.bulkWrite=o,exports.processChangesFileIfRequired=c;var e=require("rxdb/plugins/core"),a=require("./helpers.js"),t=require("./task-queue.js"),n=require("./documents-file.js"),s=require("./find-by-ids.js"),r=require("./changelog.js"),i=require("./attachments.js");async function o(r,o,l,d){var h=o.primaryPath,g=!!o.schema.attachments,u=await o.internals.statePromise,p=[],w=(0,t.getAccessHandle)(u.changesFileHandle,r).then((e=>e.getWritable())),m=l.map((e=>e.document[h])),v=(0,a.getTotalDocumentCount)(u)>0?await(0,s.findDocumentsByIdsInternal)(o,m,r):new Map,C=(0,e.categorizeBulkWriteRows)(o,h,v,l,d),f=C.eventBulk.events;if(p=C.errors,f.length>0){var H=(0,e.ensureNotFalsy)(C.newestRow).document;(0,e.ensureNotFalsy)(H),C.eventBulk.checkpoint={id:H[h],lwt:H._meta.lwt},u.mightHaveUnprocessedChanges=!0,u.broadcastChannel&&u.broadcastChannel.postMessage({type:"pre-write",mightHaveUnprocessedChanges:!0}),g&&await(0,i.appendAttachmentFiles)(r,o,C,u),C.eventBulk.endTime=(0,e.now)();var b=JSON.stringify(C.eventBulk),y=n.ENCODER.encode(b),x=await w,F=x.write(y,{at:0});o.changes$.next(b),r.awaitBeforeFinish.push((()=>c(r,u,o,!0))),await F,x.flush&&await x.flush()}return{error:p}}async function c(e,s,o,c=!1){if(s.mightHaveUnprocessedChanges){var l=await(0,t.getAccessHandle)(s.changesFileHandle,e),d=await l.getSize();if(0!==d){var h=await l.read(0,d),g=n.DECODER.decode(h),u=JSON.parse(g),p=u.events,w=await(0,t.getAccessHandle)(s.documentFileHandle,e),m=await(0,n.writeDocumentRows)(e,s.documentFileHandle,p);await w.close(),await(0,i.clearDeletedAttachments)(e,o,s,u),c||o.changes$.next(u);for(var v=[],C=0;C<s.indexStates.length;C++){s.indexStates[C].appendWriteOperations(p,m,v)}await(0,r.addChangelogOperations)(e,s.changelogFile,v,s.maxIndexableStringLength),(0,a.broadcastChangelogOperations)(o,s,v,u),await l.truncate(0),s.mightHaveUnprocessedChanges=!1,s.broadcastChannel&&s.broadcastChannel.postMessage({type:"pre-write",mightHaveUnprocessedChanges:!1})}else s.mightHaveUnprocessedChanges=!1}}