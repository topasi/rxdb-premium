Object.defineProperty(exports,"__esModule",{value:!0}),exports.ENCODER=exports.DECODER=exports.COMMA_AS_UINT8=void 0,exports.batchIndexRowReads=p,exports.getAverageDocSize=g,exports.getDocumentsJson=s,exports.getDocumentsJsonString=c,exports.sortCompareIndexRowsByPosition=h,exports.writeDocumentRows=o;var e=require("rxdb/plugins/core"),t=require("./task-queue.js"),r=require("./helpers.js"),a=exports.DECODER=new TextDecoder,n=exports.ENCODER=new TextEncoder;async function o(e,r,a){for(var o=[],s=await(0,t.getAccessHandle)(r,e),i=await s.getSize(),u=[],c=0,l=i,h=a.length,g=0;g<h;g++){var p=a[g].documentData,v=JSON.stringify(p),f=l,w=n.encode(v);u.push(w);var y=w.byteLength;c+=y;var d=l+=y;o.push([f,d])}for(var x=new Uint8Array(c),D=0,m=0;m<u.length;m++){var A=u[m];x.set(A,D),D+=A.byteLength}var C=await s.getWritable();return await C.write(x,{at:i}),o}async function s(t,r,a,n){var o=[],s=(0,e.batchArray)(n,1e3);return await Promise.all(s.map((async n=>{var s=await c(t,r,a,n),i=JSON.parse(s);0===o.length?o=i:(0,e.appendToArray)(o,i)}))),o}async function i(e,t,a,n){if(!t.wholeDocumentsFileContent){var o=.15;if((0,r.getTotalDocumentCount)(e)*o<n&&(0,r.getTotalDocumentCount)(e)>1){var s=await a.read(0);t.wholeDocumentsFileContent=s}}}var u=exports.COMMA_AS_UINT8=n.encode(",");async function c(t,r,n,o){await i(t,n,r,o.length);var s=o.length,c=n.wholeDocumentsFileContent;if(c){for(var h="",g=0;g<s;g++){var v=o[g];h+=a.decode(c.slice(v[2],v[3])),g!==s-1&&(h+=",")}return"["+h+"]"}var f=new Map,w=p(o,25),y=s-1;await Promise.all(w.map((async e=>{var t=await l(r,e,f);y+=t})));for(var d=new Uint8Array(y),x=0,D=0;D<s;D++){var m=o[D],A=(0,e.getFromMapOrThrow)(f,m);d.set(A,x),x+=A.byteLength,D!==s-1&&(d.set(u,x),x+=u.byteLength)}return"["+a.decode(d)+"]"}async function l(t,r,a){for(var n=r[0][2],o=(0,e.ensureNotFalsy)((0,e.lastOfArray)(r))[3],s=await t.read(n,o),i=0,u=0;u<r.length;u++){var c=r[u],l=s.slice(c[2]-n,c[3]-n);i+=l.byteLength,a.set(c,l)}return i}function h(e,t){return e[2]<t[2]?-1:e[2]>t[2]?1:0}function g(e,t){var r=[];if(e.length>=t)r=e.slice();else for(;r.length<t;){var a=v(e);r.push(a)}var n=0;return r.forEach((e=>n+=e[3]-e[2])),n/r.length}function p(t,r){for(var a=t.slice(0).sort(h),n=g(t,5),o=[],s=[],i=0;i<a.length;i++){var u=a[i];if(0!==s.length){var c=(0,e.lastOfArray)(s);u[2]-c[3]<r*n?s.push(u):(o.push(s),s=[u])}else s.push(u)}return s.length>0&&o.push(s),o}function v(e){return e[Math.floor(Math.random()*e.length)]}