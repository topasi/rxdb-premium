Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEFAULT_DOC_JSON_POSITION_SIZE=void 0,exports.broadcastChangelogOperations=g,exports.compareIndexRows=d,exports.getDirectoryPath=c,exports.getStorageInstanceInternalState=o,exports.getTotalDocumentCount=l,exports.toPaddedString=s;var e=require("rxdb/plugins/core"),a=require("./task-queue.js"),t=require("./changelog.js"),n=require("./index-state.js"),r=require("rxjs");async function o(o,s,i,l){var d=o.getDirectory(),g=c({databaseName:s.databaseName,collectionName:s.collectionName,schemaVersion:s.schema.version}),m=d.then((e=>e.getDirectoryHandle(g,{create:!0}))),u=m.then((e=>e.getFileHandle("documents.json",{create:!0})));return i.runInit((async o=>{var c=u.then((e=>(0,a.getAccessHandle)(e,o))),g=m.then((e=>e.getFileHandle("changes.json",{create:!0}))),h=(0,e.getPrimaryFieldOfPrimaryKey)(s.schema.primaryKey),p=(0,e.ensureNotFalsy)(s.schema.properties[h].maxLength),x=(0,n.getIndexesFromSchema)(s.schema).map(((e,a)=>new n.IndexState(a,e,m,s.schema,l))),y=(0,e.maxOfNumbers)(x.map((e=>e.indexableStringLength))),b=(0,t.getChangelogFile)(m,y,l),f=await c;if(await f.getSize()>0){var[S,I]=await Promise.all([Promise.all(x.map((e=>e.initRead(o)))),(0,t.getChangelogOperations)(o,b,x,0)]);Array.from(I.operationsByIndexId.entries()).map((([e,a])=>{var t=x[e];a.forEach((e=>t.runChangelogOperation(e)))}))}var v=s.multiInstance?new BroadcastChannel(i.lockId):void 0;v&&v.unref&&v.unref();var N=new r.Subject;return v&&(v.onmessage=e=>{var a=e.data;N.next(a)}),{params:s,taskQueue:i,indexStates:x,primaryPath:h,primaryKeyLength:p,root:await d,dirHandle:await m,changesFileHandle:await g,documentFileHandle:await u,changelogFile:b,maxIndexableStringLength:y,broadcastChannel:v,broadcastChannelMessages$:N,mightHaveUnprocessedChanges:!1}}))}function s(e,a){return(e+"").padStart(a,"number"==typeof e?"0":" ")}exports.DEFAULT_DOC_JSON_POSITION_SIZE=8;function i(e){return e.replace(/\//g,"__")}function c(e){return["rxdb",i(e.databaseName),i(e.collectionName),e.schemaVersion].join("-")}function l(a){return(0,e.ensureNotFalsy)(a.indexStates[0]).rows.length}function d(e,a){return e[0]<a[0]?-1:e[0]===a[0]?0:1}function g(e,a,t,n){if(a.broadcastChannel){var r={type:"event",eventBulk:n,changelogOperations:t,info:{db:e.databaseName,col:e.collectionName}};a.broadcastChannel.postMessage(r)}}