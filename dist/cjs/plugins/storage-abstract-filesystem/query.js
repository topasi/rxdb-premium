Object.defineProperty(exports,"__esModule",{value:!0}),exports.abstractFilesystemQuery=o;var e=require("rxdb/plugins/core"),r=require("../storage-indexeddb/index.js"),s=require("./task-queue.js"),t=require("rxdb/plugins/storage-memory"),n=require("./documents-file.js"),a=require("./helpers.js");async function o(o,i,u){var d=await o.internals.statePromise,l=i.queryPlan.index.slice(0),c=(0,r.getIndexName)(l),m=(0,e.ensureNotFalsy)(d.indexStates.find((e=>e.name===c)));if(0===m.rows.length)return{documents:[]};var g=i.queryPlan,v=i.query,y=v.skip?v.skip:0,p=y+(v.limit?v.limit:1/0),w=!1;g.selectorSatisfiedByIndex||(w=(0,e.getQueryMatcher)(o.schema,i.query));var x=!g.sortSatisfiedByIndex,f=g.startKeys,h=(0,e.getStartIndexStringFromLowerBound)(o.schema,l,f),q=g.endKeys,b=(0,e.getStartIndexStringFromUpperBound)(o.schema,l,q),S=(g.inclusiveStart?t.boundGE:t.boundGT)(m.rows,[h],a.compareIndexRows),I=(g.inclusiveEnd?t.boundLE:t.boundLT)(m.rows,[b],a.compareIndexRows),P=await(0,s.getAccessHandle)(d.documentFileHandle,u),j=[];if(w)for(var k=!1;!k;){var F=m.rows[S];if(!F||S>I)break;var B=(await(0,n.getDocumentsJson)(d,P,u,[F]))[0];w(B)&&j.push(B),(j.length>=p&&!x||S>=m.rows.length)&&(k=!0),S++}else{for(var D=[],E=!1;!E;){var J=m.rows[S];if(!J||S>I)break;D.push(J),(j.length>=p&&!x||S>=m.rows.length)&&(E=!0),S++}if(!x){var L=(D=D.slice(y,p)).length>0?await(0,n.getDocumentsJsonString)(d,P,u,D):"[]";return Promise.resolve('{"documents": '+L+"}")}j=await(0,n.getDocumentsJson)(d,P,u,D)}if(x){var G=(0,e.getSortComparator)(o.schema,i.query);j=j.sort(G)}return j=j.slice(y,p),Promise.resolve({documents:j})}