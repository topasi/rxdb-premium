Object.defineProperty(exports,"__esModule",{value:!0}),exports.cleanup=g,exports.cleanupChangelogOperations=d,exports.cleanupDeletedDocuments=l,exports.cleanupDocumentJsonFile=u;var e=require("rxdb/plugins/core"),a=require("../storage-indexeddb/index.js"),t=require("./task-queue.js"),n=require("rxdb/plugins/storage-memory"),r=require("./documents-file.js"),o=require("./changelog.js"),i=require("./helpers.js"),s=(0,a.getIndexName)(a.CLEANUP_INDEX);async function g(e,a,t){return!((await l(e,a,t)).length>0)&&(!((await d(e,a)).length>0)&&!(await u(e,a)>0))}async function l(g,l,d){var u=await g.internals.statePromise,c=(0,e.ensureNotFalsy)(u.indexStates.find((e=>e.name===s))),p=(0,e.now)()-d,w=(0,e.getStartIndexStringFromLowerBound)(g.schema,a.CLEANUP_INDEX,[!0,1]),h=(0,e.getStartIndexStringFromUpperBound)(g.schema,a.CLEANUP_INDEX,[!0,p]),x=(0,n.boundGT)(c.rows,[w],i.compareIndexRows),m=(0,n.boundLT)(c.rows,[h],i.compareIndexRows);if(-1===x)return[];var f=c.rows.slice(x,m+1),v=[],b=await(0,t.getAccessHandle)(u.documentFileHandle,l);for(var C of f){var I=C[1];v.push(I);var S=(await(0,r.getDocumentsJson)(u,b,l,[C]))[0],y=[];for(var D of u.indexStates){var F=D.getIndexableString(S),O=(0,n.boundEQ)(D.rows,[F],i.compareIndexRows),N=[D.indexId,O,"D",D.rows[O]];y.push(N),D.runChangelogOperation(N)}await(0,o.addChangelogOperations)(l,u.changelogFile,y,u.maxIndexableStringLength)}return v}async function d(e,a){var t=await e.internals.statePromise,n=await(0,o.getChangelogOperations)(a,t.changelogFile,t.indexStates,0),r=t.indexStates.filter((e=>{var a=n.operationsByIndexId.get(e.indexId);return!(!a||0===a.length)}));for(var i of r)await i.indexFile.replaceContent(a,i.rows.map((e=>[e[0],e[2],e[3]])));return r.length>0&&await t.changelogFile.empty(a),r}async function u(a,n){var s=await a.internals.statePromise,g=(0,e.ensureNotFalsy)(s.indexStates.find((e=>"_meta.lwt"===e.index[0])));if(!(0,e.lastOfArray)(g.rows))return 0;var l=await(0,t.getAccessHandle)(s.documentFileHandle,n),d=await l.getSize();s.broadcastChannel&&s.broadcastChannel.postMessage({type:"pre-write",mightHaveUnprocessedChanges:!0});for(var u=50,c=0,p=0,w=0;;){if(p>=u)return p;var h=g.rows[w];if(w+=1,!h)return c<d&&await l.truncate(c),p;var x=h[2],m=h[3];if(x===c)c=m;else{p+=1;var f=(await(0,r.getDocumentsJson)(s,l,n,[h]))[0],v=c,b=x-v,C=r.ENCODER.encode(" ".repeat(b)),I=await l.getWritable();await I.write(C,{at:v});var S=[];for(var y of s.indexStates){var D=y.changeDocumentPosition(f,[v,m]);S.push(D)}await(0,o.addChangelogOperations)(n,s.changelogFile,S,s.maxIndexableStringLength),(0,i.broadcastChangelogOperations)(a,s,S);var F=JSON.stringify(f),O=F.length,N=r.ENCODER.encode(F+" ".repeat(b-O));I=await l.getWritable(),await I.write(N,{at:v});var E=v+O,P=[];for(var q of s.indexStates){var L=q.changeDocumentPosition(f,[v,E]);P.push(L)}await(0,o.addChangelogOperations)(n,s.changelogFile,P,s.maxIndexableStringLength),(0,i.broadcastChangelogOperations)(a,s,P),c+=O}}}