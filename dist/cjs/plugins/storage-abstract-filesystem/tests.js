Object.defineProperty(exports,"__esModule",{value:!0}),exports.getWriteData=l,exports.runBasicsTests=i;var e=require("./helpers.js"),t=require("./file-abstraction.js"),a=require("./task-queue.js"),r=require("rxdb/plugins/core"),s=require("./index.js"),o=require("async-test-util"),n=require("./documents-file.js");async function i(o,i){try{var c=new a.TaskQueue("runBasicsTests",i),u=await o.getDirectory(),m=await u.getDirectoryHandle("basics-test",{create:!0}),g=new t.AbstractFile(m.getFileHandle("check-file.txt",{create:!0}),100,[]),w=!1;if(await c.runWrite((async e=>{var t=await g.readHeader(e);t&&t.done&&(w=!0)})),w)return void console.log("dev-mode: runBasicsTests() HAS RUN ALREADY");console.log("dev-mode: runBasicsTests() START");var v=await m.getFileHandle("write-test.txt",{create:!0});console.log("dev-mode: runBasicsTests() 0.0");var E=await v.createAccessHandle();console.log("dev-mode: runBasicsTests() 0.1");var b=await E.getWritable();await b.write(n.ENCODER.encode("1234567890"),{at:0}),console.log("dev-mode: runBasicsTests() 0.2"),console.log("dev-mode: runBasicsTests() 1");var p=await E.read(2,10);if("34567890"!==n.DECODER.decode(p))throw new Error("wrong readBufferA "+n.DECODER.decode(p));console.log("dev-mode: runBasicsTests() 2"),b=await E.getWritable(),await b.write(n.ENCODER.encode("FOOBAR"),{at:4}),console.log("dev-mode: runBasicsTests() 3");var y=await E.read(0,10);if(console.log("dev-mode: runBasicsTests() 3.1"),"1234FOOBAR"!==n.DECODER.decode(y))throw new Error("wrong readBuffer "+n.DECODER.decode(y));console.log("dev-mode: runBasicsTests() 4"),await E.close(),console.log("dev-mode: runBasicsTests() 5");var S=new t.AbstractFile(m.getFileHandle("one-file.txt",{create:!0}),0,[{type:"number",length:5},{type:"string",length:1},{type:"string",length:20}]),R=[[1,"A",(0,e.toPaddedString)("foobar1",20)],[2,"B",(0,e.toPaddedString)("foobar2",20)],[3,"C",(0,e.toPaddedString)("foobar3",20)]];await c.runWrite((async e=>{await S.appendRows(e,R)})),await c.runRead((async e=>{var t=[];if(await S.readRows(e,0,(e=>t.push(e))),JSON.stringify(R)!==JSON.stringify(t))throw console.dir({writeRows:R,readRows:t}),new Error("rows not equal!")})),await c.runWrite((async e=>{await g.writeHeader(e,{done:!0})}));var f="runBasicsTests()";console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 0");var B=(0,s.getRxStorageAbstractFilesystem)({name:"test",abstractFilesystem:o,abstractLock:i,jsonPositionSize:e.DEFAULT_DOC_JSON_POSITION_SIZE});console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 1");var T=await B.createStorageInstance({databaseInstanceToken:(0,r.randomCouchString)(10),databaseName:(0,r.randomCouchString)(10),collectionName:(0,r.randomCouchString)(10),schema:(0,r.fillWithDefaultSettings)({version:0,type:"object",primaryKey:"key",properties:{key:{type:"string",maxLength:50},stringValue:{type:"string",maxLength:50},numberValue:{type:"number",minimum:0,maximum:1e3,multipleOf:1},nes:{type:"object",properties:{ted:{type:"string",maxLength:10}},required:["ted"],additionalProperties:!1},list:{type:"array",items:{type:"object",additionalProperties:!1,properties:{stringValue:{type:"string",maxLength:50},numberValue:{type:"number",minimum:0,maximum:1e3,multipleOf:1}},required:["stringValue","numberValue"]}}},required:["key","stringValue","numberValue","nes","list"],indexes:[["stringValue"],["numberValue"],["numberValue","stringValue"]],additionalProperties:!1}),multiInstance:!1,options:{},devMode:!0});console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 2"),await T.internals.statePromise,console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 3"),await T.bulkWrite(new Array(2).fill(0).map(((e,t)=>({document:l({key:"a-"+t,list:[]})}))),f);var N=l({key:"foobar"});console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 4");var O=[{document:N}],A=await T.bulkWrite(O,f);console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 4.1");var W=(0,r.getWrittenDocumentsFromBulkWriteResponse)("key",O,A),h=(0,r.clone)(W[0]);console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 5"),await T.bulkWrite(new Array(2).fill(0).map(((e,t)=>({document:l({key:"b-"+t,list:[]})}))),f),console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 6"),h._rev="2-22080c42d471e3d2625e49dcca3b8e2b",h._meta.lwt=(0,r.now)();await T.bulkWrite([{previous:N,document:h}],f);console.log("dev-mode: runBasicsTests() ENSURE CLEANUP WORKS 7");for(var C=await d(T),P=!1;!P;)P=await T.cleanup(0);if(await d(T)>=C)throw new Error("dev-mode: runBasicsTests() docs not cleaned up");await T.close()}catch(e){throw console.log("dev-mode: runBasicsTests() failed:"),console.dir(e),await(0,r.promiseWait)(1e7),e}console.log("dev-mode: runBasicsTests() DONE")}async function d(e){var t=-1;return await e.taskQueue.runRead((async r=>{var s=await e.internals.statePromise,o=await(0,a.getAccessHandle)(s.documentFileHandle,r);t=await o.getSize()})),t}function l(e={}){return Object.assign({key:(0,o.randomString)(10),stringValue:"barfoo",numberValue:(0,o.randomNumber)(1,100),nes:{ted:(0,o.randomString)(10)},list:[{stringValue:(0,o.randomString)(5),numberValue:(0,o.randomNumber)(1,100)},{stringValue:(0,o.randomString)(5),numberValue:(0,o.randomNumber)(1,100)}],_deleted:!1,_attachments:{},_meta:{lwt:(0,r.now)()},_rev:"1-12080c42d471e3d2625e49dcca3b8e1a"},e)}