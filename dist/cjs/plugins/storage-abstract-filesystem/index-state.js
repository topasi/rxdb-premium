Object.defineProperty(exports,"__esModule",{value:!0}),exports.IndexState=exports.INDEX_ROW_ID_LENGTH=exports.INDEX_ID_LENGTH=void 0,exports.getIndexFileName=o,exports.getIndexesFromSchema=h,exports.sortByIndexStringComparator=a,exports.sortIndexes=d;var e=require("rxdb/plugins/core"),t=require("../storage-indexeddb/index.js"),i=require("./helpers.js"),r=require("./file-abstraction.js"),s=require("rxdb/plugins/storage-memory"),n=require("array-push-at-sort-position");exports.IndexState=function(){function h(i,s,n,a,h){this.rows=[],this.indexId=i,this.index=s,this.schema=a,this.jsonPositionSize=h,this.name=(0,t.getIndexName)(this.index),this.fileHandle=n.then((e=>e.getFileHandle(o(i),{create:!0}))),this.getIndexableString=(0,e.getIndexableStringMonad)(this.schema,this.index),this.indexableStringLength=(0,e.getIndexStringLength)(this.schema,this.index),this.primaryPath=(0,e.getPrimaryFieldOfPrimaryKey)(this.schema.primaryKey),this.primaryKeyLength=(0,e.ensureNotFalsy)(this.schema.properties[this.primaryPath].maxLength),this.metaIdMap=0===i?new Map:void 0,this.indexFile=new r.AbstractFile(this.fileHandle,0,[{type:"string",length:this.indexableStringLength},{type:"number",length:h},{type:"number",length:h}])}var d=h.prototype;return d.initRead=async function(t){this.metaIdMap&&this.metaIdMap.clear(),await this.indexFile.readRows(t,0,(t=>{var[i,r,s]=t,n=(0,e.getPrimaryKeyFromIndexableString)(i,this.primaryKeyLength).trim(),a=[i,n,r,s];this.metaIdMap&&this.metaIdMap.set(n,a),this.rows.push(a)}))},d.runChangelogOperation=function(e){var t=e[1],i=e[3],r=i[1];if("A"===e[2])this.rows.splice(t,0,i),this.metaIdMap&&this.metaIdMap.set(r,i);else if("D"===e[2])this.rows.splice(t,1),this.metaIdMap&&this.metaIdMap.delete(r);else{if("R"!==e[2])throw new Error("unknown operation key "+e[2]);this.rows[t]=i,this.metaIdMap&&this.metaIdMap.set(r,i)}},d.appendWriteOperations=function(t,r,o){for(var h=[],d=t.length,p=0;p<d;p++){var m=t[p],u=r[p],x=m.documentId,l=this.getIndexableString(m.documentData),I=m.previousDocumentData?this.getIndexableString(m.previousDocumentData):null,g=I?(0,s.boundEQ)(this.rows,[I],i.compareIndexRows):-1,c=[l,x,u[0],u[1]];this.metaIdMap&&this.metaIdMap.set(x,c),l===I?(this.rows[g]=c,o.push([this.indexId,g,"R",[l,x,u[0],u[1]]])):(m.previousDocumentData&&(this.rows.splice(g,1),o.push([this.indexId,g,"D",[(0,e.ensureNotFalsy)(I),x,u[0],u[1]]])),h.push(c))}for(var y=0,f=(h=h.sort(a)).length,w=0;w<f;w++){var D=h[w];y=(0,n.pushAtSortPosition)(this.rows,D,a,y),o.push([this.indexId,y,"A",D])}return o},d.changeDocumentPosition=function(e,t){var r=this.getIndexableString(e),n=(0,s.boundEQ)(this.rows,[r],i.compareIndexRows),a=[r,e[this.primaryPath],t[0],t[1]];return this.rows[n]=a,[this.indexId,n,"R",a]},h}();function a(e,t){return e[0]<t[0]?-1:1}exports.INDEX_ROW_ID_LENGTH=8,exports.INDEX_ID_LENGTH=5;function o(e){return"index-"+(0,i.toPaddedString)(e,5)+".txt"}function h(i){var r=(0,e.getPrimaryFieldOfPrimaryKey)(i.primaryKey),s=(0,e.toArray)(i.indexes?i.indexes:[]);(s=(s=d(s)).map((e=>e.slice(0)))).push(["_meta.lwt",r]),s.push(t.CLEANUP_INDEX);var n=new Set,a=s.slice();return s=a.filter((e=>{var i=(0,t.getIndexName)(e);return!n.has(i)&&(n.add(i),!0)}))}function d(e){return e.map((e=>({index:e,str:e.join(",")}))).sort(((e,t)=>e.str>t.str?1:e.str<t.str?-1:0)).map((e=>e.index))}