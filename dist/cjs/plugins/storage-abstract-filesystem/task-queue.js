Object.defineProperty(exports,"__esModule",{value:!0}),exports.TaskQueue=void 0,exports.getAccessHandle=t,exports.getLockId=s;var e=require("rxdb/plugins/core");exports.TaskQueue=function(){function t(t,s){this.queue=e.PROMISE_RESOLVE_VOID,this.readTasks=[],this.beforeTaskReadOrWrite=[],this.lockId=t,this.abstractLock=s}var s=t.prototype;return s.runRead=function(e){return new Promise(((t,s)=>{this.readTasks.push((a=>e(a).then((e=>t(e))).catch((e=>s(e))))),this.triggerReadTasks()}))},s.triggerReadTasks=function(){this.queue=this.queue.then((()=>{if(0!==this.readTasks.length)return this.abstractLock.request(this.lockId,(async()=>{var e=this.readTasks;this.readTasks=[];var t={type:"READ",taskAmount:e.length,accessHandlers:new Map,awaitBeforeFinish:[]};return await Promise.all(this.beforeTaskReadOrWrite.map((e=>e(t)))),Promise.all(e.map((e=>e(t)))).then((()=>this.cleanupAfterRun(t)))}))})).catch((e=>{console.log("ERROR TaskQueue.triggerReadTasks.queue errored:"),console.log(e)}))},s.runWrite=function(e){return new Promise(((t,s)=>{this.queue=this.queue.then((()=>this.abstractLock.request(this.lockId,(async()=>{var a={type:"WRITE",taskAmount:1,accessHandlers:new Map,awaitBeforeFinish:[]};return await Promise.all(this.beforeTaskReadOrWrite.map((e=>e(a)))),e(a).then((e=>{t(e)})).catch((e=>s(e))).then((()=>this.cleanupAfterRun(a)))}))))}))},s.runInit=function(e){return new Promise(((t,s)=>{this.queue=this.queue.then((()=>this.abstractLock.request(this.lockId,(async()=>{var a={type:"INIT",taskAmount:1,accessHandlers:new Map,awaitBeforeFinish:[]};return e(a).then((e=>t(e))).catch((e=>s(e))).then((()=>this.cleanupAfterRun(a)))}))))}))},s.cleanupAfterRun=async function(e){await Promise.all(e.awaitBeforeFinish.map((e=>e()))),await Promise.all(Array.from(e.accessHandlers.values()).map((e=>e.then((e=>e.close())).catch((e=>{})))))},s.awaitIdle=async function(){for(;;){var e=this.queue;if(await this.queue,this.queue===e)return}},t}();function t(e,t){var s=t.accessHandlers.get(e);return s||(s=e.createAccessHandle(),t.accessHandlers.set(e,s)),s}function s(e){return["rxdb","abstract-filesystem","task-queue-lock",e.databaseName,e.collectionName,e.schema.version].join("||")}