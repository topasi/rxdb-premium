var e=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.RxServerAdapterKoa=exports.ROUTER_BY_KOA=exports.KOA_SSR_STREAM_BY_CONTEXT=exports.HTTP_SERVER_BY_KOA=void 0;var r=require("node:stream"),s=e(require("koa")),t=require("rxdb/plugins/core"),o=e(require("koa-router")),a=e(require("@koa/cors")),n=require("@koa/bodyparser"),u=exports.HTTP_SERVER_BY_KOA=new WeakMap,i=exports.ROUTER_BY_KOA=new WeakMap,p=exports.KOA_SSR_STREAM_BY_CONTEXT=new WeakMap;exports.RxServerAdapterKoa={async create(){var e=new s.default({});e.use((0,n.bodyParser)());var r=new o.default;return i.set(e,r),e},setCors(e,r,s){e.use((0,a.default)({origin:s}))},getRequestBody:e=>e.request.body,getRequestHeaders:e=>e.request.headers,getRequestQuery:e=>e.query,onRequestClose(e,r){e.req.on("close",(()=>{r()}))},setResponseHeader(e,r,s){e.set(r,s)},responseWrite(e,r){var s=p.get(e);s?s.write(r):e.res.write(r)},endResponseJson(e,r){e.status=200,e.body=r},endResponse(e){e.res.end()},async closeConnection(e,r,s){var t={code:r,error:!0,message:s};e.status=r,e.body=t},setSSEHeaders(e){e.status=200,e.set({"Content-Type":"text/event-stream; charset=utf-8",Connection:"keep-alive","Cache-Control":"no-cache","X-Accel-Buffering":"no"});var s=(0,t.getFromMapOrCreate)(p,e,(()=>new r.PassThrough));e.body=s},get(e,r,s){(0,t.getFromMapOrThrow)(i,e).get(r,(e=>s(e,e)))},post(e,r,s){(0,t.getFromMapOrThrow)(i,e).post(r,(e=>s(e,e)))},all(e,r,s){(0,t.getFromMapOrThrow)(i,e).all(r,(e=>s(e,e)))},async listen(e,r,s){var o=(0,t.getFromMapOrThrow)(i,e);e.use(o.routes());var a=await new Promise(((o,a)=>{var n=(0,t.ensureNotFalsy)(e).listen(r,s,(()=>{o(n)}))}));u.set(e,a)},async close(e){var r=(0,t.getFromMapOrThrow)(u,e);await new Promise(((e,s)=>{r.close((r=>{r?s(r):e()})),setImmediate((()=>r.emit("close")))}))},async closeAllConnections(e){var r=u.get(e);r&&await r.closeAllConnections()}};