var e=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.RxStorageLocalstorage=exports.RxStorageInstanceLocalstorage=exports.RX_STORAGE_NAME_LOCALSTORAGE=void 0,exports.createLocalstorageStorageInstance=g,exports.getRxStorageLocalstorage=o,exports.getStorageEventStream=h,exports.getStorageState=m,exports.localstoragePersist=u;e(require("@babel/runtime/helpers/readOnlyError"));var t=require("rxdb/plugins/core"),a=require("rxjs"),r=require("../shared/rxdb-premium-version.js"),s=exports.RX_STORAGE_NAME_LOCALSTORAGE="localstorage",n=exports.RxStorageLocalstorage=function(){function e(e){this.name=s,this.rxdbVersion=r.RXDB_PREMIUM_VERSION,this.settings=e}return e.prototype.createStorageInstance=function(e){return(0,t.ensureRxStorageInstanceParamsAreCorrect)(e),g(this,e,Object.assign({},this.settings,e.options))},e}();function o(e={}){return new n(e)}var i=new a.Subject,c=!1;function h(){return c||(c=!0,window.addEventListener("storage",(e=>{e.key&&i.next({fromStorageEvent:!0,key:e.key,newValue:e.newValue})}))),i.asObservable()}var l=exports.RxStorageInstanceLocalstorage=function(){function e(e,r,s,n,o,i,c,l){this.changes$=new a.Subject,this.storage=e,this.databaseName=r,this.collectionName=s,this.schema=n,this.internals=o,this.options=i,this.settings=c,this.databaseInstanceToken=l,this.primaryPath=(0,t.getPrimaryFieldOfPrimaryKey)(this.schema.primaryKey),this.storageKey="rx-storage-localstorage-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changestreamStorageKey="rx-storage-localstorage-changestream-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changeStreamSub=h().subscribe((e=>{if(e.key===this.changestreamStorageKey&&e.newValue&&(!e.fromStorageEvent||e.databaseInstanceToken!==this.databaseInstanceToken)){var t=JSON.parse(e.newValue);e.fromStorageEvent&&t.databaseInstanceToken===this.databaseInstanceToken||(this.changes$.next(t.eventBulk),this.internals.docsById=m(this.primaryPath,this.storageKey))}}))}var r=e.prototype;return r.bulkWrite=async function(e,a){var r={error:[]},s=(0,t.categorizeBulkWriteRows)(this,this.primaryPath,this.internals.docsById,e,a);r.error=s.errors;var n=!1;if([s.bulkInsertDocs,s.bulkUpdateDocs].forEach((e=>{e.forEach((e=>{n=!0;var t=e.document[this.primaryPath];this.internals.docsById.set(t,e.document)}))})),n&&u(this),s.eventBulk.events.length>0){var o={databaseInstanceToken:this.databaseInstanceToken,eventBulk:s.eventBulk},c=JSON.stringify(o);localStorage.setItem(this.changestreamStorageKey,c),i.next({fromStorageEvent:!1,key:this.changestreamStorageKey,newValue:c,databaseInstanceToken:this.databaseInstanceToken})}return r},r.findDocumentsById=async function(e,t){var a=[],r=this.internals.docsById;return e.forEach((e=>{var s=r.get(e);s&&(!t&&s._deleted||a.push(s))})),a},r.query=async function(e){var a=e.query,r=a.skip?a.skip:0,s=r+(a.limit?a.limit:1/0),n=(0,t.getQueryMatcher)(this.schema,a),o=Array.from(this.internals.docsById.values()).filter((e=>n(e))),i=(0,t.getSortComparator)(this.schema,a);return{documents:o.sort(i).slice(r,s)}},r.count=async function(e){return{count:(await this.query(e)).documents.length,mode:"fast"}},r.getChangedDocumentsSince=async function(e,a){var r=Array.from(this.internals.docsById.values());a&&(r=r.filter((e=>e._meta.lwt>a.lwt||e._meta.lwt===a.lwt&&e[this.primaryPath]>a.id)));var s=r.slice(0,e),n=(0,t.lastOfArray)(s);return{documents:s,checkpoint:n?{id:n[this.primaryPath],lwt:n._meta.lwt}:a||{id:"",lwt:0}}},r.changeStream=function(){return this.changes$.asObservable()},r.cleanup=function(e){var a=(0,t.now)()-e,r=!1;return Object.entries(this.internals.docsById).forEach((([e,t])=>{t._deleted&&(t._meta.lwt>a||(this.internals.docsById.delete(e),r=!0))})),r&&u(this),t.PROMISE_RESOLVE_TRUE},r.getAttachmentData=function(e,a){throw(0,t.newRxError)("SNH")},r.remove=function(){return localStorage.removeItem(this.storageKey),localStorage.removeItem(this.changestreamStorageKey),t.PROMISE_RESOLVE_VOID},r.close=function(){return this.closed||(this.closed=(async()=>{this.changes$.complete(),this.changeStreamSub.unsubscribe(),localStorage.removeItem(this.changestreamStorageKey)})()),this.closed},r.conflictResultionTasks=function(){return(new a.Subject).asObservable()},r.resolveConflictResultionTask=function(e){return t.PROMISE_RESOLVE_VOID},e}();function u(e){localStorage.setItem(e.storageKey,JSON.stringify(Array.from(e.internals.docsById.values())))}async function g(e,t,a){var r={docsById:new Map},s=new l(e,t.databaseName,t.collectionName,t.schema,r,t.options,a,t.databaseInstanceToken);return r.docsById=m(s.primaryPath,s.storageKey),s}function m(e,t){var a=localStorage.getItem(t),r=new Map;a&&JSON.parse(a).forEach((t=>{var a=t[e];r.set(a,t)}));return r}