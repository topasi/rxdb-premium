Object.defineProperty(exports,"__esModule",{value:!0}),exports.RxStorageMemoryMapped=void 0,exports.getMemoryMappedRxStorage=p,exports.loadInitialData=m;var e=require("rxdb/plugins/core"),a=require("broadcast-channel"),t=require("rxdb/plugins/storage-memory"),r=require("rxjs"),n=require("../../plugins/shared/version-check.js"),s=require("../shared/rxdb-premium-version.js"),o=require("./helper.js"),i=require("./memory-mapped-storage-instance.js"),c=require("./block-map.js"),d=(0,t.getRxStorageMemory)(),l=exports.RxStorageMemoryMapped=function(){function t(e){this.name="memory-mapped",this.rxdbVersion=s.RXDB_PREMIUM_VERSION,this.openInstances=new Map,this.settings=e}return t.prototype.createStorageInstance=async function(t){var s=[t.databaseName,t.collectionName,t.schema.version].join("-"+this.name+"-");if(this.openInstances.has(s)){var l=await(0,e.getFromMapOrThrow)(this.openInstances,s);return l.internals.refCount=l.internals.refCount+1,l}var p=void 0,h=(async()=>{if((0,n.checkVersion)(),t.devMode&&t.multiInstance){var l=s+"|"+this.settings.storage.name,h=new a.BroadcastChannel(l);if(p=(0,a.createLeaderElection)(h),await Promise.race([(0,e.promiseWait)(3e3).then((()=>!0)),p.awaitLeadership().then((()=>!1))]))throw this.openInstances.delete(s),p.die(),h.close(),new Error("The memory-mapped RxStorage cannot be instantiated multiple times. Instead either set multiInstance:false or use the storage inside of the SharedWorker RxStorage.  https://rxdb.info/rx-storage-shared-worker.html ")}var u=t.databaseInstanceToken,g=(0,e.flatClone)(t);g.schema=(0,o.getMemoryMappedPersistenceSchema)(t.schema),g.multiInstance=!1;var v=this.settings.storage.createStorageInstance(g),y=(0,e.flatClone)(t.schema);delete y.encrypted;var I={databaseName:t.databaseName,collectionName:t.collectionName+"-memory-mapped-instance"+(0,e.randomCouchString)(12),schema:y,multiInstance:!1,databaseInstanceToken:u,options:t.options,devMode:t.devMode},f=await d.createStorageInstance(I),x=new c.BlockMap,M={persistentInstancePromise:v,cacheKey:s,refCount:1,leaderElector:p,conflictResultionTasks$:new r.Subject,memoryInstance:f,blockMap:x,initDonePromise:m(await v,f,x)};return new i.MemoryMappedRxStorageInstance(this,t.databaseName,t.collectionName,u,t.schema,M,t.options,t.devMode)})().catch((e=>{throw this.openInstances.delete(s),p&&p.broadcastChannel.close(),e}));return this.openInstances.set(s,h),h},t}();async function m(a,t,r){var n,s=(0,e.getPrimaryFieldOfPrimaryKey)(t.schema.primaryKey),i=t.internals,c=i.documents,d=Object.values(i.byIndex),l=d.length,m=d.map((e=>e.docsWithIndex)),p=d.map((e=>e.getIndexableString)),u=new Map;function g(e,a){c.set(a,e);for(var t=0;t<l;++t){var r=p[t](e);m[t].push([r,e,a])}}for(var[v,y]=await Promise.all([(async()=>{var e=await(0,o.getNonCleanedUpBlocks)(a),t=e[0];t&&(!n||t.id>n)&&(n=t.id);for(var i=new Set,c=0;c<e.length;c++)for(var d=e[c],l=d.d,m=d.id,p=0;p<l.length;p++){var h=l[p],u=h[s];i.has(u)?r.addCleanup(u,m):(g(h,u),i.add(u),r.add(u,m))}return{docsInCleanup:i,nonCleanedBlocks:e}})(),(async()=>{var t=await a.query((0,e.prepareQuery)(a.schema,(0,e.normalizeMangoQuery)(a.schema,{selector:{c:{$eq:!0},_deleted:{$eq:!1}},sort:[{id:"asc"}]}))),r=(0,e.lastOfArray)(t.documents);return r&&(!n||r.id>n)&&(n=r.id),t.documents})()]),I=v.docsInCleanup,f=0;f<y.length;f++)for(var x=y[f],M=x.d,b=x.id,w=0;w<M.length;w++){var S=M[w],C=S[s];I.has(C)?r.addCleanup(C,b):(r.add(C,b),g(S,C))}for(var k=0;k<l;++k){var q=d[k];q.docsWithIndex=q.docsWithIndex.sort(h)}return{lastBlockId:n,toCleanupByBlockId:u}}function p(e){return new l(e)}function h(e,a){return e[0]<a[0]?-1:1}