Object.defineProperty(exports,"__esModule",{value:!0}),exports.mangoQuerySelectorToSQL=n,exports.mangoQuerySortToSQL=a;var e=require("rxdb/plugins/core"),t=require("./sqlite-helpers.js"),r=["$or","$and"];function n(a,o,s,c){var u=(0,e.getPrimaryFieldOfPrimaryKey)(a.primaryKey);return"("+Object.entries(o).map((([o,i])=>{if(!o.startsWith("$"))return(0,t.isPlainObject)(i)?n(a,i,s,o):(s.push(i),(0,t.getJsonExtract)(u,o)+"="+t.PARAM_KEY);if(r.includes(o)){var E=" "+o.substring(1).toUpperCase()+" ",p=i.map((e=>n(a,e,s,c)));return p.length>1?"("+p.join(E)+")":p.join(E)}if(!c)throw new Error("cannot have selector operator on the top level "+o);switch(o){case"$eq":return null===i?(0,t.getJsonExtract)(u,c)+" IS NULL":(s.push(i),(0,t.getJsonExtract)(u,c)+"="+t.PARAM_KEY);case"$ne":if(null===i)return(0,t.getJsonExtract)(u,c)+" IS NOT NULL";s.push(i);var l=(0,t.getJsonExtract)(u,c)+"!="+t.PARAM_KEY;return null===i?l:"("+l+" OR ("+(0,t.getJsonExtract)(u,c)+" IS NULL))";case"$gt":return s.push(i),(0,t.getJsonExtract)(u,c)+">"+t.PARAM_KEY;case"$gte":return s.push(i),(0,t.getJsonExtract)(u,c)+">="+t.PARAM_KEY;case"$lt":return s.push(i),(0,t.getJsonExtract)(u,c)+"<"+t.PARAM_KEY;case"$lte":return s.push(i),(0,t.getJsonExtract)(u,c)+"<="+t.PARAM_KEY;case"$exists":return i?(s.push("rand-"+(0,e.randomCouchString)(10)),(0,t.getJsonExtract)(u,c)+"!="+t.PARAM_KEY):(0,t.getJsonExtract)(u,c)+" IS NULL";case"$in":i.forEach((e=>s.push(e)));var g=(0,e.getSchemaByObjectPath)(a,c);return g&&"array"===g.type?"EXISTS (SELECT 1 FROM json_each("+(0,t.getJsonExtract)(u,c)+") WHERE value IN ("+new Array(i.length).fill(t.PARAM_KEY).join(",")+"))":(0,t.getJsonExtract)(u,c)+" IN ("+new Array(i.length).fill(t.PARAM_KEY).join(",")+")";case"$nin":return s.push(i),(0,t.getJsonExtract)(u,c)+" NOT IN ("+t.PARAM_KEY+")";default:var h=new Error("operator "+o+" not implemented");throw h.operator=o,h.isNonImplementedOperatorError=!0,h}})).join(" AND ")+")"}function a(e,r){return"ORDER BY "+r.map((r=>{var[n,a]=Object.entries(r)[0];return(0,t.getJsonExtract)(e,n)+" "+a.toUpperCase()})).join(", ")}