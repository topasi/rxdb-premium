Object.defineProperty(exports,"__esModule",{value:!0}),exports.SQLITE_VARIABLES_LIMIT=exports.SQLITE_IN_MEMORY_DB_NAME=exports.RX_STORAGE_NAME_SQLITE=exports.PARAM_KEY=exports.NON_IMPLEMENTED_OPERATOR_QUERY_BATCH_SIZE=void 0,exports.attachmentRowKey=o,exports.boolParamsToInt=h,exports.closeDatabaseConnection=i,exports.ensureParamsCountIsCorrect=f,exports.finishSqliteTransaction=x,exports.getDataFromResultRow=l,exports.getDatabaseConnection=s,exports.getIndexId=d,exports.getJsonExtract=m,exports.getSQLiteFindByIdSQL=E,exports.getSQLiteInsertSQL=p,exports.getSQLiteUpdateSQL=u,exports.isPlainObject=I,exports.openSqliteTransaction=_,exports.prepareSQLiteQuery=g,exports.sqliteTransaction=y;var e=require("rxdb/plugins/core"),t=require("./sqlite-query.js"),r=exports.NON_IMPLEMENTED_OPERATOR_QUERY_BATCH_SIZE=50,n=new Map;exports.RX_STORAGE_NAME_SQLITE="sqlite",exports.SQLITE_VARIABLES_LIMIT=999;function o(e,t){return e+"||"+t}var a=exports.SQLITE_IN_MEMORY_DB_NAME=":memory:";function s(e,t){var r=n.get(t);if(r){if(r.sqliteBasics!==e&&t!==a)throw new Error("opened db with different creator method "+t+" "+r.sqliteBasics.debugId+" "+e.debugId);r.openConnections=r.openConnections+1}else r={database:e.open(t).then((async t=>(e.journalMode&&await e.setPragma(t,"journal_mode",e.journalMode),t))),sqliteBasics:e,openConnections:1},n.set(t,r);return r.database}async function i(e,t){var r=n.get(e);if(r&&(r.openConnections=r.openConnections-1,0===r.openConnections))return n.delete(e),r.database.then((e=>t.close(e)))}var c="_";function d(e,t,r,n){var o=n.map((e=>e.replace(/\./g,c+"dot"+c)));return"rxdb"+[e,t,r.version].join(c)+c+o.join(c)+c+"idx"}function l(e){return e?Array.isArray(e)?e[4]?e[4]:e[0]:e.data:e}function p(e,t,r){return{query:"\n        INSERT INTO "+e+"(\n            id,\n            revision,\n            deleted,\n            lastWriteTime,\n            data\n        ) VALUES (\n            ?,\n            ?,\n            ?,\n            ?,\n            json(?)\n        );\n    ",params:[r[t],r._rev,r._deleted?1:0,r._meta.lwt,JSON.stringify(r)],context:{method:"getSQLiteInsertSQL",data:{collectionName:e,primaryPath:t}}}}function u(e,t,r){var n=r.document;return{query:'\n    UPDATE "'+e+'"\n    SET \n        revision = ?,\n        deleted = ?,\n        lastWriteTime = ?,\n        data = json(?)\n    WHERE\n        id = ?\n    ',params:[n._rev,n._deleted?1:0,n._meta.lwt,JSON.stringify(n),n[t]],context:{method:"getSQLiteUpdateSQL",data:{tableName:e,primaryPath:t}}}}function m(e,t){return e===t?"id":"_meta.lwt"===t?"lastWriteTime":"JSON_EXTRACT(data, '$."+t+"')"}function E(e,t,r){var n=r?"":" AND deleted = 0";return{query:'\n        SELECT * FROM "'+e+'"\n        WHERE id IN ('+new Array(t.length).fill(T).join(", ")+")\n        "+n+";\n    ",params:t,context:{method:"getSQLiteFindByIdSQL",data:{tableName:e,docIds:t}}}}function I(e){return"object"==typeof e&&e.constructor==Object}var S=new WeakMap;async function y(t,r,n,o){var a=S.get(t);return a||(a=e.PROMISE_RESOLVE_VOID),a=a.then((async()=>{await _(t,r);var e=await n();await x(t,r,e,o)})),S.set(t,a),a}async function _(t,r){for(var n=!1;!n;)try{await r.run(t,{query:"BEGIN;",params:[],context:{method:"openSqliteTransaction",data:""}}),n=!0}catch(t){console.log("open transaction error (will retry):");var o=(0,e.errorToPlainJson)(t);if(console.log(o),console.dir(t),t.message&&(t.message.includes("Database is closed")||t.message.includes("API misuse")))throw t;await(0,e.promiseWait)(0)}}function x(e,t,r,n){return t.run(e,{query:r+";",params:[],context:{method:"finishSqliteTransaction",data:r}}).catch((e=>{throw n&&(console.error("cannot close transaction (mode: "+r+")"),console.log(JSON.stringify(n,null,4))),e}))}var T=exports.PARAM_KEY="?";function f(e){if(e.params.length!==e.query.split(T).length-1)throw new Error("ensureParamsCountIsCorrect() wrong param count: "+JSON.stringify(e))}function g(n,o){var a=(0,e.getPrimaryFieldOfPrimaryKey)(n.schema.primaryKey),s=o.limit?"LIMIT "+o.limit:"LIMIT -1",i=o.skip?"OFFSET "+o.skip:"",c=[],l="",p=void 0,u="";o.index&&(u='INDEXED BY "'+d(n.databaseName,n.collectionName,n.schema,o.index)+'"');var m=(0,t.mangoQuerySortToSQL)(a,o.sort);try{var E=(0,t.mangoQuerySelectorToSQL)(n.schema,o.selector,c);l=u+" "+(E="()"!==E?" WHERE "+E+" ":"")+m+" "+s+" "+i+" ;"}catch(e){if(!e.isNonImplementedOperatorError)throw e;c=[],p=e.operator,l=u+" "+m+" LIMIT "+r+" "}return{schema:n.schema,mangoQuery:(0,e.clone)(o),sqlQuery:{query:l,params:c,context:{method:"prepareQuery",data:{}}},queryWithoutSort:l.replace(m," "),nonImplementedOperator:p}}function h(e){return e.map((e=>"boolean"==typeof e?e?1:0:e))}