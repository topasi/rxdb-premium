Object.defineProperty(exports,"__esModule",{value:!0});var e={RxStorageMemorySynced:!0,getMemorySyncedRxStorage:!0};exports.RxStorageMemorySynced=void 0,exports.getMemorySyncedRxStorage=d;var t=require("rxdb/plugins/core"),n=require("rxdb/plugins/local-documents"),a=require("rxdb/plugins/storage-memory"),r=require("./memory-synced-storage-instance.js");Object.keys(r).forEach((function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(e,t)||t in exports&&exports[t]===r[t]||Object.defineProperty(exports,t,{enumerable:!0,get:function(){return r[t]}}))}));var s=require("rxjs"),i=require("../../plugins/shared/version-check.js"),o=require("../shared/rxdb-premium-version.js"),c=require("./memory-synced-types.js");Object.keys(c).forEach((function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(e,t)||t in exports&&exports[t]===c[t]||Object.defineProperty(exports,t,{enumerable:!0,get:function(){return c[t]}}))}));var l=(0,a.getRxStorageMemory)(),m=exports.RxStorageMemorySynced=function(){function e(e){this.name="memory-synced",this.rxdbVersion=o.RXDB_PREMIUM_VERSION,this.firstInstanceTokens={},this.settings=e}return e.prototype.createStorageInstance=async function(e){var a=(0,t.getPrimaryFieldOfPrimaryKey)(e.schema.primaryKey);(0,i.checkVersion)();var o=e.databaseInstanceToken,c=this;if(e.schema.attachments)throw new Error("The memory-synced plugin does not support attachments");if(e.schema.title===t.INTERNAL_STORE_SCHEMA_TITLE){var m=await this.settings.storage.createStorageInstance(e),d=m.bulkWrite.bind(m);return m.bulkWrite=async function(e,n){var a=await d(e,n),r=(0,t.getWrittenDocumentsFromBulkWriteResponse)("id",e,a).find((e=>e.id===t.STORAGE_TOKEN_DOCUMENT_ID));return r&&r.data.instanceToken===o&&(c.firstInstanceTokens[o]=new Set),a},m}if(e.schema.title===n.RX_LOCAL_DOCUMENT_SCHEMA.title)return await this.settings.storage.createStorageInstance(e);var u=(0,t.flatClone)(e);this.settings.keepIndexesOnParent||(u.schema=(0,t.flatClone)(u.schema),u.schema.indexes=[["_meta.lwt",a]]);var h=this.settings.storage.createStorageInstance(u),g=(0,t.flatClone)(e.schema);delete g.encrypted;var p,S=l.createStorageInstance(Object.assign({},Object.assign({},e,{multiInstance:!1,databaseInstanceToken:(0,t.randomCouchString)(10),schema:g}),{collectionName:e.collectionName+"-memory-synced-"+(0,t.randomCouchString)(12)})),y=l.createStorageInstance({databaseName:e.databaseName,collectionName:e.collectionName+"-meta-instance"+(0,t.randomCouchString)(12),schema:(0,t.getRxReplicationMetaInstanceSchema)(e.schema,!1),multiInstance:!1,databaseInstanceToken:(0,t.randomCouchString)(10),options:{},devMode:e.devMode}),[f,b,I]=await Promise.all([h,S,y]),x=new s.Subject,R=new s.Subject,v=R.pipe((0,s.shareReplay)(t.RXJS_SHARE_REPLAY_DEFAULTS)),T=new Map,k=Promise.all([S,y,h]).then((([e,n,a])=>{var r=(e,n)=>{var a=Symbol(),r=(async()=>{var r={id:(0,t.randomCouchString)(10),context:n,input:e},i=(0,s.firstValueFrom)(v.pipe((0,s.filter)((e=>e.id===r.id))));x.next(r);var o=await i;return T.delete(a),o.output})();return T.set(a,r),r},i=(0,t.rxStorageInstanceToReplicationHandler)(a,r,o);return(0,t.replicateRxStorageInstance)({identifier:"memorysyncedstorage+"+(0,t.randomCouchString)(10),pullBatchSize:this.settings.batchSize?this.settings.batchSize:50,pushBatchSize:this.settings.batchSize?this.settings.batchSize:50,replicationHandler:i,conflictHandler:r,forkInstance:e,metaInstance:n,waitBeforePersist:this.settings.waitBeforePersist,hashFunction:t.defaultHashSha256})}));return this.firstInstanceTokens[o]&&!this.firstInstanceTokens[o].has(e.collectionName)?(this.firstInstanceTokens[o].add(e.collectionName),p=S):p=k.then((e=>(0,t.awaitRxStorageReplicationFirstInSync)(e))),await h,new r.MemorySyncedRxStorageInstance(this,e.databaseName,e.collectionName,e.schema,{masterInstance:f,metaInstance:I,forkInstance:await S,initDonePromise:p,replicationStatePromise:k,conflictTasks$:x,resolvedConflictTasks$:R,openConflictResolutions:T},{})},e}();function d(e){return new m(e)}