Object.defineProperty(exports,"__esModule",{value:!0});var e={wrappedKeyEncryptionWebCryptoStorage:!0};exports.wrappedKeyEncryptionWebCryptoStorage=n;var t=require("rxdb/plugins/core"),r=require("rxdb/plugins/utils"),a=require("./helpers.js");function n(e){var n=e.salt?e.salt:(0,a.getDefaultSeed)();return Object.assign({},e.storage,{async createStorageInstance(c){var i,p;if(void 0!==c.password&&s(c.password),!(0,t.hasEncryption)(c.schema))return await e.storage.createStorageInstance(c);var d=(0,r.ensureNotFalsy)(c.schema.encrypted);if(!c.password)throw(0,t.newRxError)("EN3",{database:c.databaseName,collection:c.collectionName,schema:c.schema});var l=(0,r.clone)(c.schema);delete l.encrypted,l.attachments&&(l.attachments.encrypted=!1);var m=c.password,u=m.password,y=m.algorithm,[h,w]=await Promise.all([(0,a.getCryptoKey)(u,y,n),e.storage.createStorageInstance(Object.assign({},c,{schema:l}))]);function f(){return i||(i={decToEnc:new Map,encToDec:new Map},p=setTimeout((()=>{i=void 0}),2e4)),i}function g(e){var t=f().decToEnc.get(e);return t||(t=(0,a.encryptString)(h,y,e),f().decToEnc.set(e,t),t.then((()=>t=>f().encToDec.set(t,Promise.resolve(e))))),t}function v(e,t){if(!t)return(0,a.decryptString)(h,y,e);var r=f().encToDec.get(e);return r||(r=(0,a.decryptString)(h,y,e),f().encToDec.set(e,r),r.then((t=>f().decToEnc.set(t,Promise.resolve(e))))),r}async function b(e){if(e=o(e),await Promise.all(d.map((async t=>{var a=(0,r.getProperty)(e,t);if(void 0!==a){var n=JSON.stringify(a),o=await g(n);(0,r.setProperty)(e,t,o)}}))),c.schema.attachments&&c.schema.attachments.encrypted){var a={};await Promise.all(Object.entries(e._attachments).map((async([e,n])=>{var o=(0,r.flatClone)(n);if(o.data){var s=o.data,c=await g(s);o.data=(0,t.b64EncodeUnicode)(c)}a[e]=o}))),e._attachments=a}return e}async function E(e){return e=o(e),await Promise.all(d.map((async t=>{var a=(0,r.getProperty)(e,t);if(void 0!==a){var n=await v(a,!0),o=JSON.parse(n);(0,r.setProperty)(e,t,o)}}))),e}async function P(e){return c.schema.attachments&&c.schema.attachments.encrypted?await v((0,t.b64DecodeUnicode)(e),!1):e}var S=(0,t.wrapRxStorageInstance)(c.schema,w,b,E,P),T=S.remove.bind(S);S.remove=()=>(p&&clearTimeout(p),T());var N=S.close.bind(S);return S.close=()=>(p&&clearTimeout(p),N()),S}})}function o(e){var t=e._attachments;return delete(e=(0,r.flatClone)(e))._attachments,(e=(0,r.clone)(e))._attachments=t,e}function s(e){if("object"!=typeof e)throw(0,t.newRxTypeError)("EN4",{password:e});if(!e.algorithm||!e.password)throw(0,t.newRxTypeError)("EN1",{password:e});if(e.password.length<a.MINIMUM_PASSWORD_LENGTH)throw(0,t.newRxError)("EN2",{minPassLength:a.MINIMUM_PASSWORD_LENGTH,password:e})}Object.keys(a).forEach((function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(e,t)||t in exports&&exports[t]===a[t]||Object.defineProperty(exports,t,{enumerable:!0,get:function(){return a[t]}}))}));