Object.defineProperty(exports,"__esModule",{value:!0}),exports.TRANSACTION_SETTINGS=exports.RX_STORAGE_NAME_INDEXEDDB=exports.IndexedDBTransactionScope=exports.INDEXEDDB_DOCS_STORE_WAL_SUFFIX=exports.INDEXEDDB_DOCS_STORE_SUFFIX=exports.INDEXEDDB_DOCS_STORE_ATTACHMENTS_SUFFIX=void 0,exports.addStoresDuringOnUpgradeNeeded=x,exports.attachmentObjectId=i,exports.awaitCreationPromise=I,exports.closeIndexedDBDatabase=f,exports.countIndexedDBRows=R,exports.createTx=E,exports.ensureNotClosed=N,exports.ensureWalPersisted=T,exports.getDatabaseAddStoresCount=p,exports.getIndexedDB=_,exports.getIndexedDBKeys=y,exports.getIndexedDBState=m,exports.getStoreNamesForStorageInstance=D,exports.indexedDBHasAtLeastOneRow=g,exports.openStoresOnExistingDatabase=h,exports.runReadTask=v;var e=require("rxdb/plugins/core"),t=require("./indexeddb-index-helpers.js"),n=exports.INDEXEDDB_DOCS_STORE_SUFFIX="documents",r=exports.INDEXEDDB_DOCS_STORE_WAL_SUFFIX="wal",o=exports.INDEXEDDB_DOCS_STORE_ATTACHMENTS_SUFFIX="attachments",a=exports.TRANSACTION_SETTINGS={durability:"relaxed"},s=(exports.RX_STORAGE_NAME_INDEXEDDB="indexeddb",0);function i(e,t){return e+"||"+t}var c=new Map;function u(t,n){var r=(0,e.getFromMapOrCreate)(c,t,(()=>e.PROMISE_RESOLVE_VOID));return r=(0,e.ensureNotFalsy)(r).then((()=>n())),c.set(t,r),r}async function d(t,n,r){var o=s++,a=await _(t,r.indexedDB),i=async()=>(await(0,e.promiseWait)(0),u(t.databaseName,(()=>new Promise(((e,n)=>{var r=a.open(t.databaseName);r.onerror=function(e){console.error(o+": OPEN IDB DATABASE "+t.databaseName+" ERROR"),n(e)},r.onsuccess=function(t){var n=r.result;e(n),l(c,n)},x(c,r)}))))),c={indexedDB:a,debugId:o,closed:!1,storage:n,settings:r,refreshIDBDatabase:i,creationPromise:i(),name:t.databaseName,refCount:0,storesToOpen:[]};return c}function l(e,t){t.onversionchange=n=>{e.closed||(t.close(),e.creationPromise=e.refreshIDBDatabase())}}async function m(t,n,r,o){var a=await(0,e.getFromMapOrCreate)(t.indexedDBStates,r.databaseName,(()=>d(r,t,n)));return a.storesToOpen=a.storesToOpen.concat(o),a.refCount=a.refCount+1,a.creationPromise.then((()=>h((0,e.ensureNotFalsy)(a)))).then((()=>(0,e.ensureNotFalsy)(a)))}var S=0;function p(){return S}async function h(e){if(0!==e.storesToOpen.length)return e.creationPromise=e.creationPromise.then((async t=>{var n=new Set(Array.from(t.objectStoreNames));if(0===e.storesToOpen.filter((e=>!n.has(D(e.collectionName,e.schema).documentStore))).length)return t;S+=1;var r=t.version+1;return t.close(),u(e.name,(()=>new Promise((async(t,n)=>{var o=e.indexedDB.open(e.name,r);o.onerror=function(t){console.error(e.debugId+": ERROR openStoresOnExistingDatabase() openRequest: error "),n(t)},o.onsuccess=function(n){var r=o.result;l(e,r),t(r)},o.onblocked=e=>{},x(e,o)}))))})),e.creationPromise}function D(e,t){var a=t.version;return{documentStore:e+"-"+a+"-"+n,writeAheadStore:e+"-"+a+"-"+r,attachmentsStore:e+"-"+a+"-"+o}}function x(e,n){n.onupgradeneeded=function(r){var o=n.result;e.storesToOpen.forEach((e=>{var n=o.objectStoreNames,r=D(e.collectionName,e.schema);if(!n.contains(r.documentStore)){var a=o.createObjectStore(r.documentStore,{keyPath:"i",autoIncrement:!1});o.createObjectStore(r.writeAheadStore,{keyPath:"i",autoIncrement:!1}),(0,t.createIndexesOnStore)(a,e),e.schema.attachments&&o.createObjectStore(r.attachmentsStore,{keyPath:"docIdWithAttachmentId",autoIncrement:!1})}})),e.storesToOpen=[]}}async function f(e){if(!e.closed&&(e.refCount=e.refCount-1,0===e.refCount))return e.closed=!0,e.storage.indexedDBStates.delete(e.name),e.creationPromise.then((e=>e.close()))}async function I(e){for(;;){var t=e.creationPromise;if(await e.creationPromise,t===e.creationPromise)return e.creationPromise}}function N(e){if(e.closed)throw new Error("RxStorageInstanceIndexedDB is closed "+e.databaseName+"-"+e.collectionName)}async function T(e,n){var r=e.primaryPath,o=e.internals.indexIds.length,a=e.internals.getIndexableStringByIndexNumber,s=n.objectStore(e.internals.storeNames.writeAheadStore),i=await new Promise(((e,t)=>{var n=s.get("documents");n.onerror=t,n.onsuccess=t=>{var r=n.result;e(r?JSON.parse(r.docsData):void 0)}}));if(i&&i.length>0){for(var c,u=n.objectStore(e.internals.storeNames.documentStore),d=0;d<i.length;++d){var l=i[d],m=l[r],S=(0,t.toIndexRow)(o,a,m,l);c=u.put(S)}await new Promise(((e,t)=>{c.onerror=t,c.onsuccess=()=>e(!0)})),s.delete("documents")}return n}async function E(t){var n,r=[t.internals.storeNames.documentStore,t.internals.storeNames.writeAheadStore];t.schema.attachments&&r.push(t.internals.storeNames.attachmentsStore);for(var o=100;o>0;){var s=await t.internals.state.creationPromise;o-=1;try{n=s.transaction(r,"readwrite",a)}catch(e){if("InvalidStateError"!==e.name&&"NotFoundError"!==e.name||!(o>0))throw e;"NotFoundError"===e.name?await h(t.internals.state):t.internals.state.creationPromise=t.internals.state.refreshIDBDatabase()}}return await T(t,(0,e.ensureNotFalsy)(n)),(0,e.ensureNotFalsy)(n)}var O=exports.IndexedDBTransactionScope=function(){function e(e){this.allTasksRuns=[],this.instance=e,this.txPromise=E(this.instance).then((t=>T(e,t)))}return e.prototype.addTask=function(e){var t=this.txPromise.then((t=>e(t))),n=t.catch((()=>null));this.allTasksRuns.push(n);var r=this.allTasksRuns.length;return n.then((()=>Promise.all(this.allTasksRuns))).then((()=>{this.allTasksRuns.length===r&&(this.instance.openReadonlyTransaction=void 0)})),t.catch((t=>{if("TransactionInactiveError"===t.name)return this.instance.openReadonlyTransaction=void 0,v(this.instance,e);throw t}))},e}();function v(e,t){return e.openReadonlyTransaction||(e.openReadonlyTransaction=new O(e)),e.openReadonlyTransaction.addTask(t)}function R(e){var t=e.count();return new Promise((e=>{t.onsuccess=()=>{e(t.result)}}))}function g(t,n){var r=(t.settings.IDBKeyRange?t.settings.IDBKeyRange:IDBKeyRange).lowerBound(e.INDEX_MIN,!0),o=n.getKey(r);return new Promise((e=>{o.onsuccess=()=>{e(!!o.result)}}))}function y(e){var t=e.getAllKeys();return new Promise((e=>{t.onsuccess=()=>{e(t.result)}}))}function _(e,t){return"function"==typeof t?t(e):t}