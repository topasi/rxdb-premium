Object.defineProperty(exports,"__esModule",{value:!0}),exports.countIndexedDB=s,exports.queryIndexedDB=r,exports.runBatchedCursor=a;var e=require("rxdb/plugins/core"),t=require("./indexeddb-helpers.js"),n=require("./indexeddb-index-helpers.js");async function r(r,s){return(0,t.runReadTask)(r,(async t=>{var i=s.queryPlan,o=s.query,d=o.skip?o.skip:0,u=d+(o.limit?o.limit:1/0),c=r.internals.storeNames.documentStore,l=r.settings.batchSize?r.settings.batchSize:50,g=!1;i.selectorSatisfiedByIndex||(g=(0,e.getQueryMatcher)(r.schema,o));var y,m=i.index,v=!i.sortSatisfiedByIndex,x=m,I=i.startKeys,S=(0,e.getStartIndexStringFromLowerBound)(r.schema,x,I),h=i.endKeys,p=(0,e.getStartIndexStringFromUpperBound)(r.schema,x,h),f=[],B=t.objectStore(c),b=(0,n.getIndexId)(r.internals,x);y=B.index(b),g||s.query.limit||(l=1e5);var w=!1;if(await a(r,i,y,l,S,p,b,(e=>{for(var t=0;t<e.length;t++){var n=e[t].d;if(w||g&&!g(n)||f.push(n),!v&&f.length===u){w=!0;break}}return!w})),v){var K=(0,e.getSortComparator)(r.schema,o);f=f.sort(K)}return{documents:f=f.slice(d,u)}}))}async function a(t,n,r,a,s,i,o,d){var u=t.settings.IDBKeyRange?t.settings.IDBKeyRange:IDBKeyRange,c=t.internals.getIndexableStringByIndexId[o];if("function"==typeof r.getAll&&1!==a)for(var l,g=!0,y=!1,m=async function(){l&&(s=c(l.d));var t=u.bound(s,i,!g||!n.inclusiveStart,!n.inclusiveEnd);g=!1;var o=r.getAll(t,a);await new Promise(((t,n)=>{o.onerror=n,o.onsuccess=n=>{var r=n.target.result;(l=(0,e.lastOfArray)(r),0!==r.length)&&(!1===d(r)&&(y=!0));r.length<a&&(y=!0),t()}}))};!y;)await m();else{var v=u.bound(s,i,!n.inclusiveStart,!n.inclusiveEnd),x=r.openCursor(v);await new Promise((e=>{x.onsuccess=function(t){var n=t.target.result;if(n){var r=n.value;d([r])?n.continue():e()}else e()}}))}}async function s(r,a){return(0,t.runReadTask)(r,(async t=>{var s,i,o=a.queryPlan,d=r.internals.storeNames.documentStore,u=o.index,c=u,l=o.startKeys,g=(0,e.getStartIndexStringFromLowerBound)(r.schema,c,l),y=o.endKeys,m=(0,e.getStartIndexStringFromUpperBound)(r.schema,c,y),v=t.objectStore(d);i=1===u.length&&u[0]===r.primaryPath?(0,n.getIndexId)(r.internals,["_deleted",r.primaryPath]):(0,n.getIndexId)(r.internals,c),s=v.index(i);var x=(r.settings.IDBKeyRange?r.settings.IDBKeyRange:IDBKeyRange).bound(g,m,!o.inclusiveStart,!o.inclusiveEnd),I=s.count(x);return{count:await new Promise(((e,t)=>{I.onsuccess=function(){e(I.result)},I.onerror=t})),mode:"fast"}}))}