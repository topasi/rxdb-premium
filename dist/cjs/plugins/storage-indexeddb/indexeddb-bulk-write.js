Object.defineProperty(exports,"__esModule",{value:!0}),exports.bulkWrite=n;var e=require("rxdb/plugins/core"),t=require("./indexeddb-helpers.js"),a=require("./indexeddb-find-by-ids.js");async function n(n,r,o){var s=n.primaryPath,c=n.internals,d=n.internals.state;await d.creationPromise;var i=[c.storeNames.documentStore,c.storeNames.writeAheadStore];n.schema.attachments&&i.push(c.storeNames.attachmentsStore),(0,t.ensureNotClosed)(n);var m,h=await(0,t.createTx)(n),l=h.objectStore(c.storeNames.documentStore);m=0===n.internals.minKnownDocsAmount&&r.length>30&&!await(0,t.indexedDBHasAtLeastOneRow)(n,l)?new Map:await(0,a.indexedDBFindByIdsInternal)(s,l,r);for(var u=(0,e.categorizeBulkWriteRows)(n,s,m,r,o),v=u.errors,w=u.bulkInsertDocs,p=new Array(w.length),I=0;I<w.length;++I){var y=w[I].document;p[I]=y}for(var b=u.bulkUpdateDocs,g=0;g<b.length;++g){var S=b[g].document;p.push(S)}if(p.length>0){var f=h.objectStore(c.storeNames.writeAheadStore).put({i:"documents",docsData:JSON.stringify(p)});await new Promise(((e,t)=>{f.onerror=t,f.onsuccess=e})),n.handleWalIdlePromise||(0,e.promiseWait)(100).then((()=>(0,e.requestIdlePromiseNoQueue)())).then((async()=>{n.handleWalIdlePromise=void 0,n.closed||await(0,t.runReadTask)(n,(()=>e.PROMISE_RESOLVE_FALSE))}))}var D=void 0;if(n.schema.attachments){var N=h.objectStore(n.internals.storeNames.attachmentsStore);u.attachmentsAdd.forEach((e=>{D=N.put({docIdWithAttachmentId:(0,t.attachmentObjectId)(e.documentId,e.attachmentId),length:e.attachmentData.length,type:e.attachmentData.type,data:e.attachmentData.data})})),u.attachmentsUpdate.forEach((e=>{D=N.put({docIdWithAttachmentId:(0,t.attachmentObjectId)(e.documentId,e.attachmentId),length:e.attachmentData.length,type:e.attachmentData.type,data:e.attachmentData.data})})),u.attachmentsRemove.forEach((e=>{D=N.delete((0,t.attachmentObjectId)(e.documentId,e.attachmentId))}))}if(D&&await new Promise(((t,a)=>{(0,e.ensureNotFalsy)(D).onerror=a,(0,e.ensureNotFalsy)(D).onsuccess=t})),h.commit&&h.commit(),u.eventBulk.events.length>0){var k=(0,e.ensureNotFalsy)(u.newestRow).document;u.eventBulk.checkpoint={id:k[s],lwt:k._meta.lwt},u.eventBulk.endTime=(0,e.now)(),n.changes$.next(u.eventBulk)}return{error:v}}