Object.defineProperty(exports,"__esModule",{value:!0}),exports.RX_STORAGE_NAME_FILESYSTEM_NODE=exports.NodeFilesystemWritable=exports.NodeFilesystemFileSyncAccessHandle=exports.NodeFilesystemFileHandle=exports.NodeFilesystemDirectory=exports.NodeFilesystem=void 0,exports.getRxStorageFilesystemNode=l;var e=require("../storage-abstract-filesystem/index.js"),t=a(require("node:fs")),n=t,r=a(require("node:path")),i=a(require("web-locks")),s=require("../storage-abstract-filesystem/helpers.js");function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(o=function(e){return e?n:t})(e)}function a(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=o(t);if(n&&n.has(e))return n.get(e);var r={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&{}.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}var c=exports.RX_STORAGE_NAME_FILESYSTEM_NODE="filesystem-node";function l(t){return(0,e.getRxStorageAbstractFilesystem)({name:c,abstractFilesystem:new u(t.basePath),abstractLock:i.locks,inWorker:!1,jsonPositionSize:s.DEFAULT_DOC_JSON_POSITION_SIZE})}var u=exports.NodeFilesystem=function(){function e(e){this.basePath=e}return e.prototype.getDirectory=async function(){return Promise.resolve(new p(this.basePath))},e}(),p=exports.NodeFilesystemDirectory=function(){function e(e){this.dirPath=e}var i=e.prototype;return i.getDirectoryHandle=async function(n,i){var s=r.join(this.dirPath,n);return i.create&&await t.promises.mkdir(s,{recursive:!0}),new e(s)},i.getFileHandle=async function(e,t){var i=r.join(this.dirPath,e);return t.create&&!n.existsSync(i)&&await n.promises.writeFile(i,"","utf-8"),new f(e,i,t)},i.removeEntry=function(e){return t.promises.unlink(r.join(this.dirPath,e))},e}(),f=exports.NodeFilesystemFileHandle=function(){function e(e,t,n){this.name=e,this.filepath=t,this.options=n}return e.prototype.createAccessHandle=async function(){if(!this.options.create&&!n.existsSync(this.filepath))throw new Error("File does not exist "+this.filepath);var e=(this.options.create,"r+"),r=await t.promises.open(this.filepath,e);return new d(this,r)},e}(),d=exports.NodeFilesystemFileSyncAccessHandle=function(){function e(e,t){this.fileHandle=e,this.nodeOpenHandle=t}var t=e.prototype;return t.getWritable=function(){return new h(this)},t.read=async function(e,t){t||(t=await this.getSize());var n=new Uint8Array(t-e);return await this.nodeOpenHandle.read({buffer:n,offset:0,position:e}),n},t.truncate=function(e){return this.nodeOpenHandle.truncate(e)},t.getSize=async function(){return(await this.nodeOpenHandle.stat()).size},t.close=function(){return this.nodeOpenHandle.close()},e}(),h=exports.NodeFilesystemWritable=function(){function e(e){this.accessHandle=e}var t=e.prototype;return t.write=function(e,t){return this.accessHandle.nodeOpenHandle.write(e,0,e.length,t.at).then((()=>this.flush()))},t.flush=function(){return this.accessHandle.nodeOpenHandle.sync()},t.close=function(){this.accessHandle.nodeOpenHandle.close()},e}();