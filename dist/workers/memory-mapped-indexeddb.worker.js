(()=>{function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,n||"default");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==e(n)?n:n+""}function n(e,n){for(var r=0;r<n.length;r++){var o=n[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,t(o.key),o)}}function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function i(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(i=function(){return!!e})()}function s(e){var t="function"==typeof Map?new Map:void 0;return s=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(i())return Reflect.construct.apply(null,arguments);var o=[null];o.push.apply(o,t);var s=new(e.bind.apply(e,o));return n&&r(s,n.prototype),s}(e,arguments,o(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),r(n,e)},s(e)}var a={isDevMode:()=>!1,deepFreezeWhenDevMode:e=>e,tunnelErrorMessage:e=>"RxDB Error-Code "+e+".\n        Error messages are not included in RxDB core to reduce build size.\n        "};function c(e,t,n){return"RxError ("+t+"):\n"+e+"\n"+function(e){var t="";return 0===Object.keys(e).length?t:(t+="Given parameters: {\n",t+=Object.keys(e).map((t=>{var n="[object Object]";try{n="errors"===t?e[t].map((e=>JSON.stringify(e,Object.getOwnPropertyNames(e)))):JSON.stringify(e[t],(function(e,t){return void 0===t?null:t}),2)}catch(e){}return t+":"+n})).join("\n"),t+="}")}(n)}var u=function(e){function t(t,n,r={}){var o,i=c(n,t,r);return(o=e.call(this,i)||this).code=t,o.message=i,o.url=l(t),o.parameters=r,o.rxdb=!0,o}var o,i;return i=e,(o=t).prototype=Object.create(i.prototype),o.prototype.constructor=o,r(o,i),t.prototype.toString=function(){return this.message},function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(s(Error));function l(e){return"https://rxdb.info/errors.html?console=errors#"+e}function f(e){return"\n You can find out more about this error here: "+l(e)+" "}function d(e,t){return new u(e,a.tunnelErrorMessage(e)+f(e),t)}var h=/\./g,p="abcdefghijklmnopqrstuvwxyz";function m(e=10){for(var t="",n=0;n<e;n++)t+=p.charAt(Math.floor(Math.random()*p.length));return t}var v=e=>{var t=typeof e;return null!==e&&("object"===t||"function"===t)},y=new Set(["__proto__","prototype","constructor"]),b=new Set("0123456789");function g(e){var t=[],n="",r="start",o=!1;for(var i of e)switch(i){case"\\":if("index"===r)throw new Error("Invalid character in an index");if("indexEnd"===r)throw new Error("Invalid character after an index");o&&(n+=i),r="property",o=!o;break;case".":if("index"===r)throw new Error("Invalid character in an index");if("indexEnd"===r){r="property";break}if(o){o=!1,n+=i;break}if(y.has(n))return[];t.push(n),n="",r="property";break;case"[":if("index"===r)throw new Error("Invalid character in an index");if("indexEnd"===r){r="index";break}if(o){o=!1,n+=i;break}if("property"===r){if(y.has(n))return[];t.push(n),n=""}r="index";break;case"]":if("index"===r){t.push(Number.parseInt(n,10)),n="",r="indexEnd";break}if("indexEnd"===r)throw new Error("Invalid character after an index");default:if("index"===r&&!b.has(i))throw new Error("Invalid character in an index");if("indexEnd"===r)throw new Error("Invalid character after an index");"start"===r&&(r="property"),o&&(o=!1,n+="\\"),n+=i}switch(o&&(n+="\\"),r){case"property":if(y.has(n))return[];t.push(n);break;case"index":throw new Error("Index was not closed");case"start":t.push("")}return t}function w(e,t){if("number"!=typeof t&&Array.isArray(e)){var n=Number.parseInt(t,10);return Number.isInteger(n)&&e[n]===e[t]}return!1}function x(e){var t=e.split("."),n=t.length;return 1===n?t=>t[e]:e=>{for(var r=e,o=0;o<n;++o)if(void 0===(r=r[t[o]]))return r;return r}}function I(e){return Object.assign({},e)}var _=function e(t){if(!t)return t;if(null===t||"object"!=typeof t)return t;if(Array.isArray(t)){for(var n=new Array(t.length),r=n.length;r--;)n[r]=e(t[r]);return n}var o={};for(var i in t)o[i]=e(t[i]);return o};function S(e){return e[e.length-1]}function O(e){return Array.isArray(e)?e.slice(0):[e]}function E(e){return Array.isArray(e)}function k(e,t){var n=0,r=-1;for(var o of e){if(!t(o,r+=1))break;n+=1}return n}var P=1;function j(e,t){var n=function(e,t,n){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!v(e)||"string"!=typeof t)return void 0===n?e:n;var r=g(t);if(0===r.length)return n;for(var o=0;o<r.length;o++){var i=r[o];if(null==(e=w(e,i)?o===r.length-1?void 0:null:e[i])){if(o!==r.length-1)return n;break}}return void 0===e?n:e}(e,function(e){for(;"."===e.charAt(0);)e=e.substr(1);for(;"."===e.slice(-1);)e=e.slice(0,-1);return e}("properties."+t.replace(h,".properties.")));return n}function N(e){return"string"==typeof e?e:e.key}function C(e){var t=N((e=I(e)).primaryKey);e.properties=I(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=D,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var n=function(e){var t=Object.keys(e.properties).filter((t=>e.properties[t].final)),n=N(e.primaryKey);return t.push(n),"string"!=typeof e.primaryKey&&e.primaryKey.fields.forEach((e=>t.push(e))),t}(e);!function(e,t){var n=t.length;if(0!==n){var r=e.length;e.length=r+t.length;for(var o=0;o<n;++o)e[r+o]=t[o]}}(e.required,n),e.required=e.required.filter((e=>!e.includes("."))).filter(((e,t,n)=>n.indexOf(e)===t)),e.version=e.version||0;var r=e.indexes.map((e=>{var n=E(e)?e.slice(0):[e];return n.includes(t)||n.push(t),"_deleted"!==n[0]&&n.unshift("_deleted"),n}));0===r.length&&r.push(function(e){return["_deleted",e]}(t)),r.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map((e=>{r.push(e)}));var o=new Set;return r.filter((e=>{var t=e.join(",");return!o.has(t)&&(o.add(t),!0)})),e.indexes=r,e}var D={type:"object",properties:{lwt:{type:"number",minimum:P,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]},T=0;function A(){var e=Date.now();(e+=.01)<=T&&(e=T+.01);var t=parseFloat(e.toFixed(2));return T=t,t}function M(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var $={bufferSize:1,refCount:!0},L=String.fromCharCode(65535),B=Number.MIN_SAFE_INTEGER;function R(e,t){var n=t.selector,r=e.indexes?e.indexes.slice(0):[];t.index&&(r=[t.index]);var o=!!t.sort.find((e=>"desc"===Object.values(e)[0])),i=new Set;Object.keys(n).forEach((t=>{var r=j(e,t);r&&"boolean"===r.type&&Object.prototype.hasOwnProperty.call(n[t],"$eq")&&i.add(t)}));var s,a=t.sort.map((e=>Object.keys(e)[0])).filter((e=>!i.has(e))).join(","),c=-1;if(r.forEach((e=>{var r=!0,u=!0,l=e.map((e=>{var t=n[e],o=t?Object.keys(t):[],i={};return t&&o.length?o.forEach((e=>{if(K.has(e)){var n=function(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}(e,t[e]);i=Object.assign(i,n)}})):i={startKey:u?B:L,endKey:r?L:B,inclusiveStart:!0,inclusiveEnd:!0},void 0===i.startKey&&(i.startKey=B),void 0===i.endKey&&(i.endKey=L),void 0===i.inclusiveStart&&(i.inclusiveStart=!0),void 0===i.inclusiveEnd&&(i.inclusiveEnd=!0),u&&!i.inclusiveStart&&(u=!1),r&&!i.inclusiveEnd&&(r=!1),i})),f=l.map((e=>e.startKey)),d=l.map((e=>e.endKey)),h={index:e,startKeys:f,endKeys:d,inclusiveEnd:r,inclusiveStart:u,sortSatisfiedByIndex:!o&&a===e.filter((e=>!i.has(e))).join(","),selectorSatisfiedByIndex:z(e,t.selector,f,d)},p=function(e,t,n){var r=0,o=e=>{e>0&&(r+=e)},i=10,s=k(n.startKeys,(e=>e!==B&&e!==L));o(s*i);var a=k(n.startKeys,(e=>e!==L&&e!==B));o(a*i);var c=k(n.startKeys,((e,t)=>e===n.endKeys[t]));return o(c*i*1.5),o(n.sortSatisfiedByIndex?5:0),r}(0,0,h);(p>=c||t.index)&&(c=p,s=h)})),!s)throw d("SNH",{query:t});return s}var K=new Set(["$eq","$gt","$gte","$lt","$lte"]),q=new Set(["$eq","$gt","$gte"]),W=new Set(["$eq","$lt","$lte"]);function z(e,t,n,r){var o=Object.entries(t).find((([t,n])=>!e.includes(t)||Object.entries(n).find((([e,t])=>!K.has(e)))));if(o)return!1;if(t.$and||t.$or)return!1;var i=[],s=new Set;for(var[a,c]of Object.entries(t)){if(!e.includes(a))return!1;var u=Object.keys(c).filter((e=>q.has(e)));if(u.length>1)return!1;var l=u[0];if(l&&s.add(a),"$eq"!==l){if(i.length>0)return!1;i.push(l)}}var f=[],d=new Set;for(var[h,p]of Object.entries(t)){if(!e.includes(h))return!1;var m=Object.keys(p).filter((e=>W.has(e)));if(m.length>1)return!1;var v=m[0];if(v&&d.add(h),"$eq"!==v){if(f.length>0)return!1;f.push(v)}}var y=0;for(var b of e){for(var g of[s,d]){if(!g.has(b)&&g.size>0)return!1;g.delete(b)}if(n[y]!==r[y]&&s.size>0&&d.size>0)return!1;y++}return!0}function F(e,t){if(!t.sort)throw d("SNH",{query:t});return{query:t,queryPlan:R(e,t)}}class U extends Error{}const Q=Number.MAX_SAFE_INTEGER,J=Number.MIN_SAFE_INTEGER,V=Symbol("missing"),G=Object.freeze(new Error("mingo: cycle detected while processing object/array")),H=/^\[object ([a-zA-Z0-9]+)\]$/,Y=e=>{const t=Ne(e);let n=0,r=t.length;for(;r;)n=(n<<5)-n^t.charCodeAt(--r);return n>>>0},X=new Set(["null","undefined","boolean","number","string","date","regexp"]),Z={null:0,undefined:0,number:1,string:2,object:3,array:4,boolean:5,date:6,regexp:7,function:8},ee=(e,t)=>{e===V&&(e=void 0),t===V&&(t=void 0);const[n,r]=[e,t].map((e=>Z[ne(e).toLowerCase()]));return n!==r?n-r:1===n||2===n||6===n?e<t?-1:e>t?1:0:Pe(e,t)?0:e<t?-1:e>t?1:0};function te(e,t){if(!e)throw new U(t)}const ne=e=>H.exec(Object.prototype.toString.call(e))[1],re=e=>"boolean"==typeof e,oe=e=>"string"==typeof e,ie=e=>!isNaN(e)&&"number"==typeof e,se=Array.isArray,ae=e=>{if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||null===t)&&"[object Object]"===Object.prototype.toString.call(e)},ce=e=>e===Object(e),ue=e=>e instanceof Date,le=e=>e instanceof RegExp,fe=e=>"function"==typeof e,de=e=>null==e,he=(e,t)=>e.includes(t),pe=(e,t)=>!he(e,t),me=e=>de(e)||oe(e)&&!e||e instanceof Array&&0===e.length||ae(e)&&0===Object.keys(e).length,ve=e=>e===V,ye=e=>e instanceof Array?e:[e],be=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),ge=e=>"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e),we=[ue,le,ge],xe=(e,t)=>{if(de(e))return e;if(t.has(e))throw G;const n=e.constructor;if(we.some((t=>t(e))))return new n(e);try{if(t.add(e),se(e))return e.map((e=>xe(e,t)));if(ae(e)){const n={};for(const r in e)n[r]=xe(e[r],t);return n}}finally{t.delete(e)}return e},Ie=e=>xe(e,new Set),_e=(e,t)=>ae(e)&&ae(t)||se(e)&&se(t);function Se(e,t,n){if(n=n||{flatten:!1},ve(e)||de(e))return t;if(ve(t)||de(t))return e;if(!_e(e,t)){if(n.skipValidation)return t||e;throw Error("mismatched types. must both be array or object")}if(n.skipValidation=!0,se(e)){const r=e,o=t;if(n.flatten){let e=0,i=0;for(;e<r.length&&i<o.length;)r[e]=Se(r[e++],o[i++],n);for(;i<o.length;)r.push(t[i++])}else Ae(r,o)}else for(const r in t)e[r]=Se(e[r],t[r],n);return e}function Oe(e,t=Y){const n=new Map;return e.forEach(((r,o)=>{const i=Ce(r,t);n.has(i)?n.get(i).some((t=>Pe(e[t],r)))||n.get(i).push(o):n.set(i,[o])})),n}function Ee(e,t=Y){if(e.some((e=>0==e.length)))return[];if(1===e.length)return Array.from(e);const n=function(e,t,n=ee){if(me(e))return e;const r=new Array,o=new Array;for(let n=0;n<e.length;n++){const i=e[n],s=t(i,n);de(s)?o.push(i):r.push([s,i])}return r.sort(((e,t)=>n(e[0],t[0]))),Ae(o,r.map((e=>e[1])))}(e.map(((e,t)=>[t,e.length])),(e=>e[1])),r=e[n[0][0]],o=Oe(r,t),i=new Map,s=new Array;return o.forEach(((t,o)=>{const a=t.map((e=>r[e])),c=a.map((e=>0)),u=a.map((e=>[n[0][0],0]));let l=!1;for(let t=1;t<e.length;t++){const[r,s]=n[t],f=e[r];if(i.has(t)||i.set(t,Oe(f)),i.get(t).has(o)){const e=i.get(t).get(o).map((e=>f[e]));l=a.map(((n,s)=>e.some(((e,a)=>{const l=c[s];return Pe(n,e)&&(c[s]++,r<u[s][0]&&(u[s]=[r,i.get(t).get(o)[a]])),l<c[s]})))).some(Boolean)}if(!l)return}l&&Ae(s,c.map(((t,n)=>t===e.length-1?[a[n],u[n]]:V)).filter((e=>e!==V)))})),s.sort(((e,t)=>{const[n,[r,o]]=e,[i,[s,a]]=t,c=ee(r,s);return 0!==c?c:ee(o,a)})).map((e=>e[0]))}function ke(e,t=0){const n=new Array;return function e(t,r){for(let o=0,i=t.length;o<i;o++)se(t[o])&&(r>0||r<0)?e(t[o],Math.max(-1,r-1)):n.push(t[o])}(e,t),n}function Pe(e,t){if(e===t||Object.is(e,t))return!0;const n=!!e&&e.constructor||e;if(null===e||null===t||void 0===e||void 0===t||n!==t.constructor||n===Function)return!1;if(n===Array||n===Object){const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;if(new Set([...n,...r]).size!=n.length)return!1;for(const r of n)if(!Pe(e[r],t[r]))return!1;return!0}const r=Object.getPrototypeOf(e);return(ge(e)||r!==Object.prototype&&r!==Array.prototype&&Object.prototype.hasOwnProperty.call(r,"toString"))&&e.toString()===t.toString()}const je=(e,t)=>{if(null===e)return"null";if(void 0===e)return"undefined";const n=e.constructor;switch(n){case RegExp:case Number:case Boolean:case Function:case Symbol:return e.toString();case String:return JSON.stringify(e);case Date:return e.toISOString()}if(ge(e))return n.name+"["+e.toString()+"]";if(t.has(e))throw G;try{if(t.add(e),se(e))return"["+e.map((e=>je(e,t))).join(",")+"]";if(n===Object)return"{"+Object.keys(e).sort().map((n=>n+":"+je(e[n],t))).join(",")+"}";const r=Object.getPrototypeOf(e);if(r!==Object.prototype&&r!==Array.prototype&&Object.prototype.hasOwnProperty.call(r,"toString"))return n.name+"("+JSON.stringify(e.toString())+")";const[o,i]=(e=>{let[t,n]=[Object.getPrototypeOf(e),Object.getOwnPropertyNames(e)],r=t;for(;!n.length&&t!==Object.prototype&&t!==Array.prototype;)r=t,n=Object.getOwnPropertyNames(t),t=Object.getPrototypeOf(t);const o={};return n.forEach((t=>o[t]=e[t])),[o,r]})(e);return n.name+je(o,t)}finally{t.delete(e)}},Ne=e=>je(e,new Set);function Ce(e,t){return t=t||Y,de(e)?null:t(e).toString()}function De(e,t,n=Y){if(e.length<1)return new Map;const r=new Map,o=new Map;for(let i=0;i<e.length;i++){const s=e[i],a=t(s,i),c=Ce(a,n);if(null===c)o.has(null)?o.get(null).push(s):o.set(null,[s]);else{const e=r.has(c)?r.get(c).find((e=>Pe(e,a))):null;de(e)?(o.set(a,[s]),r.has(c)?r.get(c).push(a):r.set(c,[a])):o.get(e).push(s)}}return o}const Te=5e4;function Ae(e,...t){return e instanceof Array?t.reduce(((e,t)=>{let n=Math.ceil(t.length/Te),r=0;for(;n-- >0;)Array.prototype.push.apply(e,t.slice(r,r+Te)),r+=Te;return e}),e):t.filter(ce).reduce(((e,t)=>(Object.assign(e,t),e)),e)}function Me(e,t){return ce(e)?e[t]:void 0}function $e(e,t,n){let r=0;const o=X.has(ne(e).toLowerCase())?e:function e(t,n){let o=t;for(let t=0;t<n.length;t++){const i=n[t];if(null===/^\d+$/.exec(i)&&o instanceof Array){if(0===t&&r>0)break;r+=1;const i=n.slice(t);o=o.reduce(((t,n)=>{const r=e(n,i);return void 0!==r&&t.push(r),t}),[]);break}if(o=Me(o,i),void 0===o)break}return o}(e,t.split("."));return o instanceof Array&&n?.unwrapArray?function(e,t){if(t<1)return e;for(;t--&&1===e.length;)e=e[0];return e}(o,r):o}function Le(e,t,n){const r=t.split("."),o=r[0],i=r.slice(1).join("."),s=null!==/^\d+$/.exec(o),a=r.length>1;let c,u;if(e instanceof Array)if(s)c=Me(e,Number(o)),a&&(c=Le(c,i,n)),c=[c];else{c=[];for(const r of e)u=Le(r,t,n),n?.preserveMissing?(void 0===u&&(u=V),c.push(u)):void 0!==u&&c.push(u)}else{if(u=Me(e,o),a&&(u=Le(u,i,n)),void 0===u)return;c=n?.preserveKeys?{...e}:{},c[o]=u}return c}function Be(e){if(e instanceof Array)for(let t=e.length-1;t>=0;t--)e[t]===V?e.splice(t,1):Be(e[t]);else if(ae(e))for(const t in e)be(e,t)&&Be(e[t])}const Re=/^\d+$/;function Ke(e,t,n,r){const o=t.split("."),i=o[0],s=o.slice(1).join(".");if(1===o.length)(ae(e)||se(e)&&Re.test(i))&&n(e,i);else{r?.buildGraph&&de(e[i])&&(e[i]={});const t=e[i];if(!t)return;const a=!!(o.length>1&&Re.test(o[1]));t instanceof Array&&r?.descendArray&&!a?t.forEach((e=>Ke(e,s,n,r))):Ke(t,s,n,r)}}function qe(e,t,n){Ke(e,t,((e,t)=>{e[t]=fe(n)?n(e[t]):n}),{buildGraph:!0})}function We(e,t,n){Ke(e,t,((e,t)=>{if(e instanceof Array){if(/^\d+$/.test(t))e.splice(parseInt(t),1);else if(n&&n.descendArray)for(const n of e)ae(n)&&delete n[t]}else ae(e)&&delete e[t]}),n)}const ze=/^\$[a-zA-Z0-9_]+$/;function Fe(e){return ze.test(e)}function Ue(e){if(X.has(ne(e).toLowerCase()))return le(e)?{$regex:e}:{$eq:e};if(ce(e)){const t=e;if(!Object.keys(t).some(Fe))return{$eq:e};if(be(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var Qe=(e=>(e.CLONE_ALL="CLONE_ALL",e.CLONE_INPUT="CLONE_INPUT",e.CLONE_OUTPUT="CLONE_OUTPUT",e.CLONE_OFF="CLONE_OFF",e))(Qe||{});class Je{constructor(e,t,n,r=Date.now()){this._opts=e,this._root=t,this._local=n,this.timestamp=r,this.update(t,n)}static init(e,t,n){return e instanceof Je?new Je(e._opts,de(e.root)?t:e.root,Object.assign({},e.local,n)):new Je(e,t,n)}update(e,t){return this._root=e,this._local=t?Object.assign({},t,{variables:Object.assign({},this._local?.variables,t?.variables)}):t,this}getOptions(){return Object.freeze({...this._opts,context:He.from(this._opts.context)})}get root(){return this._root}get local(){return this._local}get idKey(){return this._opts.idKey}get collation(){return this._opts?.collation}get processingMode(){return this._opts?.processingMode||"CLONE_OFF"}get useStrictMode(){return this._opts?.useStrictMode}get scriptEnabled(){return this._opts?.scriptEnabled}get useGlobalContext(){return this._opts?.useGlobalContext}get hashFunction(){return this._opts?.hashFunction}get collectionResolver(){return this._opts?.collectionResolver}get jsonSchemaValidator(){return this._opts?.jsonSchemaValidator}get variables(){return this._opts?.variables}get context(){return this._opts?.context}}function Ve(e){return e instanceof Je?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:"CLONE_OFF",...e,context:e?.context?He.from(e?.context):He.init({})})}var Ge=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(Ge||{});class He{constructor(e){this.operators={accumulator:{},expression:{},pipeline:{},projection:{},query:{},window:{}};for(const[t,n]of Object.entries(e))this.addOperators(t,n)}static init(e={}){return new He(e)}static from(e){return new He(e.operators)}addOperators(e,t){for(const[n,r]of Object.entries(t))this.getOperator(e,n)||(this.operators[e][n]=r);return this}addAccumulatorOps(e){return this.addOperators("accumulator",e)}addExpressionOps(e){return this.addOperators("expression",e)}addQueryOps(e){return this.addOperators("query",e)}addPipelineOps(e){return this.addOperators("pipeline",e)}addProjectionOps(e){return this.addOperators("projection",e)}addWindowOps(e){return this.addOperators("window",e)}getOperator(e,t){return e in this.operators&&this.operators[e][t]||null}}const Ye=He.init();function Xe(e,t){for(const[n,r]of Object.entries(t)){te(fe(r)&&Fe(n),`'${n}' is not a valid operator`);const t=Ze(e,n,null);te(!t||r===t,`${n} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":Ye.addAccumulatorOps(t);break;case"expression":Ye.addExpressionOps(t);break;case"pipeline":Ye.addPipelineOps(t);break;case"projection":Ye.addProjectionOps(t);break;case"query":Ye.addQueryOps(t);break;case"window":Ye.addWindowOps(t)}}function Ze(e,t,n){const{context:r,useGlobalContext:o}=n||{},i=r?r.getOperator(e,t):null;return!i&&o?Ye.getOperator(e,t):i}const et={$$ROOT:(e,t,n)=>n.root,$$CURRENT:(e,t,n)=>e,$$REMOVE(e,t,n){},$$NOW:(e,t,n)=>new Date(n.timestamp)},tt={$$KEEP:(e,t,n)=>e,$$PRUNE(e,t,n){},$$DESCEND(e,t,n){if(!be(t,"$cond"))return e;let r;for(const[o,i]of Object.entries(e))if(ce(i)){if(i instanceof Array){const e=[];for(let r of i)ae(r)&&(r=rt(r,t,n.update(r))),de(r)||e.push(r);r=e}else r=rt(i,t,n.update(i));de(r)?delete e[o]:e[o]=r}return e}};function nt(e,t,n,r){const o=Je.init(r,e);if(Fe(n=n||"")){const i=Ze("expression",n,r);if(i)return i(e,t,o);const s=Ze("accumulator",n,r);if(s)return e instanceof Array||(e=nt(e,t,null,o),t=null),te(e instanceof Array,`'${n}' target must be an array.`),s(e,t,o.update(null,o.local));throw new U(`operator '${n}' is not registered`)}if(oe(t)&&t.length>0&&"$"===t[0]){if(be(tt,t))return t;let n=o.root;const r=t.split(".");if(be(et,r[0]))n=et[r[0]](e,null,o),t=t.slice(r[0].length+1);else if("$$"===r[0].slice(0,2)){n=Object.assign({},o.variables,{this:e},o.local?.variables);const i=r[0].slice(2);te(be(n,i),`Use of undefined variable: ${i}`),t=t.slice(2)}else t=t.slice(1);return""===t?n:$e(n,t)}if(se(t))return t.map((t=>nt(e,t,null,o)));if(ae(t)){const n={};for(const[i,s]of Object.entries(t))if(n[i]=nt(e,s,i,o),["expression","accumulator"].some((e=>!!Ze(e,i,r))))return te(1===Object.keys(t).length,"Invalid aggregation expression '"+JSON.stringify(t)+"'"),n[i];return n}return t}function rt(e,t,n){const r=nt(e,t,null,n);return be(tt,r)?tt[r](e,t,n):r}function ot(e){return e instanceof at?e:new at(e)}function it(e,t){const n=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,n)}const st=new Error;class at{constructor(e){let t;if(this.iteratees=[],this.yieldedValues=[],this.isDone=!1,e instanceof Function&&(e={next:e}),(n=e)&&"object"==typeof n&&n?.next instanceof Function){const n=e;t=()=>{const e=n.next();if(e.done)throw st;return e.value}}else if(e instanceof Array){const n=e,r=n.length;let o=0;t=()=>{if(o<r)return n[o++];throw st}}else if(!(e instanceof Function))throw new U("Lazy must be initialized with an array, generator, or function.");var n;this.getNext=function(e,t,n){let r=!1,o=-1,i=0;return function(s){try{e:for(;!r;){let a=e();o++;let c=-1;const u=t.length;let l=!1;for(;++c<u;){const e=t[c];switch(e.action){case 0:a=e.func(a,o);break;case 1:if(!e.func(a,o))continue e;break;case 2:--e.count,e.count||(l=!0);break;case 3:--e.count,e.count||it(t,c);continue e;default:break e}}if(r=l,!s)return{value:a,done:!1};n[i++]=a}}catch(e){if(e!==st)throw e}return r=!0,{done:r}}}(t,this.iteratees,this.yieldedValues)}push(e,t){return"function"==typeof t?this.iteratees.push({action:e,func:t}):"number"==typeof t&&this.iteratees.push({action:e,count:t}),this}next(){return this.getNext()}map(e){return this.push(0,e)}filter(e){return this.push(1,e)}take(e){return e>0?this.push(2,e):this}drop(e){return e>0?this.push(3,e):this}transform(e){const t=this;let n;return ot((()=>(n||(n=ot(e(t.value()))),n.next())))}value(){return this.isDone||(this.isDone=this.getNext(!0).done),this.yieldedValues}each(e){for(;;){const t=this.next();if(t.done)break;if(!1===e(t.value))return!1}return!0}reduce(e,t){let n=this.next();for(void 0!==t||n.done||(t=n.value,n=this.next());!n.done;)t=e(t,n.value),n=this.next();return t}size(){return this.reduce(((e,t)=>++e),0)}[Symbol.iterator](){return this}}class ct{constructor(e,t){this.pipeline=e,this.options=Ve(t)}stream(e){let t=ot(e);const n=this.options.processingMode;n!=Qe.CLONE_ALL&&n!=Qe.CLONE_INPUT||t.map(Ie);const r=new Array;if(!me(this.pipeline))for(const e of this.pipeline){const n=Object.keys(e),o=n[0],i=Ze(Ge.PIPELINE,o,this.options);te(1===n.length&&!!i,`invalid pipeline operator ${o}`),r.push(o),t=i(t,e[o],this.options)}return(n==Qe.CLONE_OUTPUT||n==Qe.CLONE_ALL&&Ee([["$group","$unwind"],r]).length)&&t.map(Ie),t}run(e){return this.stream(e).value()}}class ut{constructor(e,t,n,r){this.source=e,this.predicate=t,this.projection=n,this.options=r,this.operators=[],this.result=null,this.buffer=[]}fetch(){return this.result||(ae(this.projection)&&this.operators.push({$project:this.projection}),this.result=ot(this.source).filter(this.predicate),this.operators.length>0&&(this.result=new ct(this.operators,this.options).stream(this.result))),this.result}fetchAll(){const e=ot([...this.buffer]);return this.buffer=[],function(...e){let t=0;return ot((()=>{for(;t<e.length;){const n=e[t].next();if(!n.done)return n;t++}return{done:!0}}))}(e,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(e){return this.operators.push({$skip:e}),this}limit(e){return this.operators.push({$limit:e}),this}sort(e){return this.operators.push({$sort:e}),this}collation(e){return this.options={...this.options,collation:e},this}next(){if(this.buffer.length>0)return this.buffer.pop();const e=this.fetch().next();return e.done?void 0:e.value}hasNext(){if(this.buffer.length>0)return!0;const e=this.fetch().next();return!e.done&&(this.buffer.push(e.value),!0)}map(e){return this.all().map(e)}forEach(e){this.all().forEach(e)}[Symbol.iterator](){return this.fetchAll()}}class lt{constructor(e,t){this.condition=e,this.options=Ve(t),this.compiled=[],this.compile()}compile(){te(ae(this.condition),`query criteria must be an object: ${JSON.stringify(this.condition)}`);const e={};for(const[t,n]of Object.entries(this.condition)){if("$where"===t)Object.assign(e,{field:t,expr:n});else if(he(["$and","$or","$nor","$expr","$jsonSchema"],t))this.processOperator(t,t,n);else{te(!Fe(t),`unknown top level operator: ${t}`);for(const[e,r]of Object.entries(Ue(n)))this.processOperator(t,e,r)}e.field&&this.processOperator(e.field,e.field,e.expr)}}processOperator(e,t,n){const r=Ze(Ge.QUERY,t,this.options);if(!r)throw new U(`unknown query operator ${t}`);const o=r(e,n,this.options);this.compiled.push(o)}test(e){for(let t=0,n=this.compiled.length;t<n;t++)if(!this.compiled[t](e))return!1;return!0}find(e,t){return new ut(e,(e=>this.test(e)),t||{},this.options)}remove(e){return e.reduce(((e,t)=>(this.test(t)||e.push(t),e)),[])}}const ft=(e,t,n)=>{if(me(t)||!ae(t))return e;let r=ee;const o=n.collation;return ae(o)&&oe(o.locale)&&(r=function(e){const t={sensitivity:dt[e.strength||3],caseFirst:"off"===e.caseFirst?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:"shifted"===e.alternate};!0===(e.caseLevel||!1)&&("base"===t.sensitivity&&(t.sensitivity="case"),"accent"===t.sensitivity&&(t.sensitivity="variant"));const n=new Intl.Collator(e.locale,t);return(e,t)=>{if(!oe(e)||!oe(t))return ee(e,t);const r=n.compare(e,t);return r<0?-1:r>0?1:0}}(o)),e.transform((e=>{const o=Object.keys(t);for(const i of o.reverse()){const o=De(e,(e=>$e(e,i)),n.hashFunction),s=Array.from(o.keys()).sort(r);-1===t[i]&&s.reverse(),e=[],s.reduce(((e,t)=>Ae(e,o.get(t))),e)}return e}))},dt={1:"base",2:"accent",3:"variant"};function ht(e){const t=(t,n,r)=>{const o={unwrapArray:!0},i=Math.max(1,t.split(".").length-1);return s=>{const a=$e(s,t,o);return e(a,n,{...r,depth:i})}};return t.op="query",t}function pt(e){return(t,n,r)=>{const o=nt(t,n,null,r);return e(...o)}}function mt(e,t,n){if(Pe(e,t))return!0;if(de(e)&&de(t))return!0;if(e instanceof Array){const r=Pe.bind(null,t);return e.some(r)||ke(e,n?.depth).some(r)}return!1}function vt(e,t,n){return!mt(e,t,n)}function yt(e,t,n){return de(e)?t.some((e=>null===e)):Ee([ye(e),t],n?.hashFunction).length>0}function bt(e,t,n){return!yt(e,t,n)}function gt(e,t,n){return Nt(e,t,((e,t)=>ee(e,t)<0))}function wt(e,t,n){return Nt(e,t,((e,t)=>ee(e,t)<=0))}function xt(e,t,n){return Nt(e,t,((e,t)=>ee(e,t)>0))}function It(e,t,n){return Nt(e,t,((e,t)=>ee(e,t)>=0))}function _t(e){return Fe(e)&&-1===["$and","$or","$nor"].indexOf(e)}function St(e,t,n){if(se(e)&&!me(e)){let r=e=>e,o=t;Object.keys(t).every(_t)&&(o={temp:t},r=e=>({temp:e}));const i=new lt(o,n);for(let t=0,n=e.length;t<n;t++)if(i.test(r(e[t])))return!0}return!1}const Ot=e=>null===e,Et=e=>ie(e)&&e>=-2147483648&&e<=2147483647&&-1===e.toString().indexOf("."),kt=e=>ie(e)&&e>=J&&e<=Q&&-1===e.toString().indexOf("."),Pt={array:se,bool:re,boolean:re,date:ue,decimal:ie,double:ie,int:Et,long:kt,number:ie,null:Ot,object:ae,regex:le,regexp:le,string:oe,undefined:de,function:e=>{throw new U("unsupported type key `function`.")},1:ie,2:oe,3:ae,4:se,6:de,8:re,9:ue,10:Ot,11:le,16:Et,18:kt,19:ie};function jt(e,t,n){const r=Pt[t];return!!r&&r(e)}function Nt(e,t,n){return ye(e).some((e=>ne(e)===ne(t)&&n(e,t)))}pt(bt);const Ct=(e,t)=>(n,r,o)=>{te(se(r),`${e}: expression must be an array.`);const i=nt(n,r,null,o);return i.some(de)?null:(te(i.every(ie),`${e}: expression must evalue to array of numbers.`),t(i))};Ct("$bitAnd",(e=>e.reduce(((e,t)=>e&t),-1))),Ct("$bitOr",(e=>e.reduce(((e,t)=>e|t),0))),Ct("$bitXor",(e=>e.reduce(((e,t)=>e^t),0))),pt(mt),pt(xt),pt(It),pt(gt),pt(wt),pt(vt);const Dt=(e,t)=>{const n={};return e.split("").forEach(((e,r)=>n[e]=t*(r+1))),n};Dt("ABCDEFGHIKLM",1),Dt("NOPQRSTUVWXY",-1);const Tt={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function At(e,t=Tt){const n=Object.assign({},Tt,t),r=new Set(Object.keys(n));return(t,o,i)=>{const s=nt(t,o,null,i);if(r.has(`${s}`)){const t=n[`${s}`];if(t instanceof Error)throw new U(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return t}return e(s)}}At(Math.acos,{Infinity:1/0,0:new Error}),At(Math.acosh,{Infinity:1/0,0:new Error}),At(Math.asin),At(Math.asinh,{Infinity:1/0,"-Infinity":-1/0}),At(Math.atan),At(Math.atanh,{1:1/0,"-1":-1/0}),At(Math.cos),At(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const Mt=Math.PI/180,$t=(At((e=>e*Mt),{Infinity:1/0,"-Infinity":1/0}),180/Math.PI);At((e=>e*$t),{Infinity:1/0,"-Infinity":-1/0}),At(Math.sin),At(Math.sinh,{"-Infinity":-1/0,Infinity:1/0}),At(Math.tan);const Lt=(e,t,n)=>{if(me(t))return e;let r=Object.keys(t),o=!1;Rt(t,n);const i=n.idKey;if(he(r,i)){const e=t[i];0!==e&&!1!==e||(r=r.filter(pe.bind(null,[i])),o=0==r.length)}else r.push(i);const s=Je.init(n);return e.map((e=>Bt(e,t,s.update(e),r,o)))};function Bt(e,t,n,r,o){let i={},s=!1,a=!1;const c=[];o&&c.push(n.idKey);for(const o of r){let r;const u=t[o];if(o!==n.idKey&&he([0,!1],u)&&(a=!0),o===n.idKey&&me(u))r=e[o];else if(oe(u))r=nt(e,u,o,n);else if(he([1,!0],u));else if(u instanceof Array)r=u.map((t=>{const r=nt(e,t,null,n);return de(r)?null:r}));else{if(!ae(u)){c.push(o);continue}{const t=u,i=Object.keys(u),a=1==i.length?i[0]:"",c=Ze(Ge.PROJECTION,a,n);if(c)"$slice"===a?ye(t[a]).every(ie)?(r=c(e,t[a],o,n),s=!0):r=nt(e,t,o,n):r=c(e,t[a],o,n);else if(Fe(a))r=nt(e,t[a],a,n);else if(be(e,o)){Rt(t,n);let s=e[o];s instanceof Array?r=s.map((e=>Bt(e,t,n,i,!1))):(s=ae(s)?s:e,r=Bt(s,t,n,i,!1))}else r=nt(e,u,null,n)}}const l=Le(e,o,{preserveMissing:!0});void 0!==l&&Se(i,l,{flatten:!0}),pe([0,1,!1,!0],u)&&(void 0===r?We(i,o,{descendArray:!0}):qe(i,o,r))}if(Be(i),(s||a||o)&&(i=Ae({},e,i),c.length>0))for(const e of c)We(i,e,{descendArray:!0});return i}function Rt(e,t){const n=[!1,!1];for(const[r,o]of Object.entries(e)){if(r===t?.idKey)return;0===o||!1===o?n[0]=!0:1!==o&&!0!==o||(n[1]=!0),te(!(n[0]&&n[1]),"Projection cannot have a mix of inclusion and exclusion.")}}const Kt=(e,t,n)=>{te(se(t),"Invalid expression: $and expects value to be an Array.");const r=t.map((e=>new lt(e,n)));return e=>r.every((t=>t.test(e)))},qt=(e,t,n)=>{te(se(t),"Invalid expression. $or expects value to be an Array");const r=t.map((e=>new lt(e,n)));return e=>r.some((t=>t.test(e)))},Wt=(e,t,n)=>{te(se(t),"Invalid expression. $nor expects value to be an array.");const r=qt("$or",t,n);return e=>!r(e)},zt=(e,t,n)=>{const r={};r[e]=Ue(t);const o=new lt(r,n);return e=>!o.test(e)},Ft=ht(mt),Ut=ht(xt),Qt=ht(It),Jt=ht(yt),Vt=ht(gt),Gt=ht(wt),Ht=ht(vt),Yt=ht(bt),Xt=ht((function(e,t,n){return ye(e).some((e=>2===t.length&&e%t[0]===t[1]))})),Zt=ht((function(e,t,n){const r=ye(e),o=e=>oe(e)&&((e,t=!0)=>!!e||t&&""===e)(t.exec(e),n?.useStrictMode);return r.some(o)||ke(r,1).some(o)}));ht((function(e,t,n){if(!(se(e)&&se(t)&&e.length&&t.length))return!1;let r=!0;for(const o of t){if(!r)break;r=ae(o)&&he(Object.keys(o),"$elemMatch")?St(e,o.$elemMatch,n):o instanceof RegExp?e.some((e=>"string"==typeof e&&o.test(e))):e.some((e=>Pe(o,e)))}return r}));const en=ht(St),tn=ht((function(e,t,n){return Array.isArray(e)&&e.length===t})),nn=ht((function(e,t,n){return(!1===t||0===t)&&void 0===e||(!0===t||1===t)&&void 0!==e})),rn=ht((function(e,t,n){return Array.isArray(t)?t.findIndex((t=>jt(e,t)))>=0:jt(e,t)}));var on=!1;function sn(e,t){var n=N(e.primaryKey);t=I(t);var r=_(t);if("number"!=typeof r.skip&&(r.skip=0),r.selector?(r.selector=r.selector,Object.entries(r.selector).forEach((([e,t])=>{"object"==typeof t&&null!==t||(r.selector[e]={$eq:t})}))):r.selector={},r.index){var o=O(r.index);o.includes(n)||o.push(n),r.index=o}if(r.sort){var i=r.sort.find((e=>{return t=e,Object.keys(t)[0]===n;var t}));i||(r.sort=r.sort.slice(0),r.sort.push({[n]:"asc"}))}else if(r.index)r.sort=r.index.map((e=>({[e]:"asc"})));else{if(e.indexes){var s=new Set;Object.entries(r.selector).forEach((([e,t])=>{("object"!=typeof t||null===t||Object.keys(t).find((e=>K.has(e))))&&s.add(e)}));var a,c=-1;e.indexes.forEach((e=>{var t=E(e)?e:[e],n=t.findIndex((e=>!s.has(e)));n>0&&n>c&&(c=n,a=t)})),a&&(r.sort=a.map((e=>({[e]:"asc"}))))}r.sort||(r.sort=[{[n]:"asc"}])}return r}function an(e,t){if(!t.sort)throw d("SNH",{query:t});var n=[];return t.sort.forEach((e=>{var t=Object.keys(e)[0],r=Object.values(e)[0];n.push({key:t,direction:r,getValueFn:x(t)})})),(e,t)=>{for(var r=0;r<n.length;++r){var o=n[r],i=o.getValueFn(e),s=o.getValueFn(t);if(i!==s)return"asc"===o.direction?ee(i,s):ee(s,i)}}}function cn(e,t){if(!t.sort)throw d("SNH",{query:t});var n,r=(n=t.selector,on||(Xe(Ge.PIPELINE,{$sort:ft,$project:Lt}),Xe(Ge.QUERY,{$and:Kt,$eq:Ft,$elemMatch:en,$exists:nn,$gt:Ut,$gte:Qt,$in:Jt,$lt:Vt,$lte:Gt,$ne:Ht,$nin:Yt,$mod:Xt,$nor:Wt,$not:zt,$or:qt,$regex:Zt,$size:tn,$type:rn}),on=!0),new lt(n));return e=>r.test(e)}async function un(e,t){return(await e.findDocumentsById([t],!1))[0]||void 0}function ln(e,t,n,r,o,i,s){for(var a,c=!!e.schema.attachments,u=[],l=[],f=[],h={id:m(10),events:[],checkpoint:null,context:o,startTime:A(),endTime:0},p=h.events,v=[],y=[],b=[],g=n.size>0,w=r.length,x=function(){var e,o=r[I],h=o.document,m=o.previous,w=h[t],x=h._deleted,_=m&&m._deleted,S=void 0;if(g&&(S=n.get(w)),S){var O=S._rev;if(!m||m&&O!==m._rev){var E={isError:!0,status:409,documentId:w,writeRow:o,documentInDb:S};return f.push(E),1}var k=c?fn(o):o;c&&(x?m&&Object.keys(m._attachments).forEach((e=>{y.push({documentId:w,attachmentId:e,digest:M(m)._attachments[e].digest})})):(Object.entries(h._attachments).find((([t,n])=>((m?m._attachments[t]:void 0)||n.data||(e={documentId:w,documentInDb:S,isError:!0,status:510,writeRow:o,attachmentId:t}),!0))),e||Object.entries(h._attachments).forEach((([e,t])=>{var n=m?m._attachments[e]:void 0;if(n){var r=k.document._attachments[e].digest;t.data&&n.digest!==r&&b.push({documentId:w,attachmentId:e,attachmentData:t,digest:t.digest})}else v.push({documentId:w,attachmentId:e,attachmentData:t,digest:t.digest})})))),e?f.push(e):(c?(l.push(fn(k)),s&&s(h)):(l.push(k),s&&s(h)),a=k);var P=null,j=null,N=null;if(_&&!x)N="INSERT",P=c?dn(h):h;else if(!m||_||x){if(!x)throw d("SNH",{args:{writeRow:o}});N="DELETE",P=M(h),j=m}else N="UPDATE",P=c?dn(h):h,j=m;var C={documentId:w,documentData:P,previousDocumentData:j,operation:N};p.push(C)}else{var D=!!x;if(c&&Object.entries(h._attachments).forEach((([t,n])=>{n.data?v.push({documentId:w,attachmentId:t,attachmentData:n,digest:n.digest}):(e={documentId:w,isError:!0,status:510,writeRow:o,attachmentId:t},f.push(e))})),e||(c?(u.push(fn(o)),i&&i(h)):(u.push(o),i&&i(h)),a=o),!D){var T={documentId:w,operation:"INSERT",documentData:c?dn(h):h,previousDocumentData:c&&m?dn(m):m};p.push(T)}}},I=0;I<w;I++)x();return{bulkInsertDocs:u,bulkUpdateDocs:l,newestRow:a,errors:f,eventBulk:h,attachmentsAdd:v,attachmentsRemove:y,attachmentsUpdate:b}}function fn(e){return{previous:e.previous,document:dn(e.document)}}function dn(e){if(!e._attachments||0===Object.keys(e._attachments).length)return e;var t=I(e);return t._attachments={},Object.entries(e._attachments).forEach((([e,n])=>{var r,o,i;t._attachments[e]=(i=(r=n).data)?{length:(o=i,atob(o).length),digest:r.digest,type:r.type}:r})),t}function hn(e){return Object.assign({},e,{_meta:I(e._meta)})}var pn=new WeakMap;function mn(e){if(e.schema.keyCompression)throw d("UT5",{args:{params:e}});if((t=e.schema).encrypted&&t.encrypted.length>0||t.attachments&&t.attachments.encrypted)throw d("UT6",{args:{params:e}});var t;if(e.schema.attachments&&e.schema.attachments.compression)throw d("UT7",{args:{params:e}})}async function vn(e,t,n){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,n);var r=N(e.schema.primaryKey),o=F(e.schema,function(e,t,n){var r=N(e.schema.primaryKey),o=n?n.lwt:P,i=n?n.id:"";return sn(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:o}},{"_meta.lwt":{$eq:o},[r]:{$gt:n?i:""}}],"_meta.lwt":{$gte:o}},sort:[{"_meta.lwt":"asc"},{[r]:"asc"}],skip:0,limit:t})}(e,t,n)),i=(await e.query(o)).documents,s=S(i);return{documents:i,checkpoint:s?{id:s[r],lwt:s._meta.lwt}:n||{id:"",lwt:0}}}function yn(e,t,n){var r=pn.get(n);if(r)return r;var o=[];if(n.error.length>0){for(var i=new Set,s=0;s<n.error.length;s++){var a=n.error[s];i.add(a.documentId)}for(var c=0;c<t.length;c++){var u=t[c].document;i.has(u[e])||o.push(dn(u))}}else{o.length=t.length-n.error.length;for(var l=0;l<t.length;l++){var f=t[l].document;o[l]=dn(f)}}return o}var bn="15.30.2",gn="15.30.2";function wn(){}function xn(e,t){var n=e.get(t);if(void 0===n)throw new Error("missing value from map "+t);return n}function In(e,t,n,r){var o=e.get(t);return void 0===o?(o=n(),e.set(t,o)):r&&r(o),o}function _n(e=0){return new Promise((t=>setTimeout(t,e)))}var Sn=Promise.resolve(!0),On=Promise.resolve(!1),En=(Promise.resolve(null),Promise.resolve());function kn(e=1e4){return"function"==typeof requestIdleCallback?new Promise((t=>{requestIdleCallback((()=>t()),{timeout:e})})):_n(0)}function Pn(e,t){var n=t.map((t=>{var n=j(e,t);if(!n)throw new Error("not in schema: "+t);var r,o=n.type;"number"!==o&&"integer"!==o||(r=Nn(n));var i,s=x(t),a=n.maxLength?n.maxLength:0;return i="string"===o?e=>{var t=s(e);return t||(t=""),t.padEnd(a," ")}:"boolean"===o?e=>s(e)?"1":"0":e=>{var t=s(e);return Cn(r,t)},{fieldName:t,schemaPart:n,parsedLengths:r,getValue:s,getIndexStringPart:i}}));return n}function jn(e,t){var n=Pn(e,t),r=n.length,o=n.map((e=>e.getIndexStringPart));return function(e){for(var t="",n=0;n<r;++n)t+=o[n](e);return t}}function Nn(e){var t=Math.floor(e.minimum),n=Math.ceil(e.maximum),r=e.multipleOf,o=(n-t).toString().length,i=r.toString().split("."),s=0;return i.length>1&&(s=i[1].length),{minimum:t,maximum:n,nonDecimals:o,decimals:s,roundedMinimum:t}}function Cn(e,t){void 0===t&&(t=0),t<e.minimum&&(t=e.minimum),t>e.maximum&&(t=e.maximum);var n=(Math.floor(t)-e.roundedMinimum).toString().padStart(e.nonDecimals,"0");if(e.decimals>0){var r=t.toString().split(".");n+=(r.length>1?r[1]:"0").padEnd(e.decimals,"0")}return n}function Dn(e,t,n){var r="";return t.forEach(((t,o)=>{var i=j(e,t),s=n[o],a=i.type;switch(a){case"string":var c=M(i.maxLength,"maxLength not set");r+="string"==typeof s?s.padEnd(c," "):"".padEnd(c," ");break;case"boolean":r+=null===s||s===B?"0":s===L||s?"1":"0";break;case"number":case"integer":var u=Nn(i);if(null===s||s===B)r+="0".repeat(u.nonDecimals+u.decimals);else if(s===L)r+=Cn(u,u.maximum);else{var l=Cn(u,s);r+=l}break;default:throw new Error("unknown index type "+a)}})),r}function Tn(e,t,n){var r="";return t.forEach(((t,o)=>{var i=j(e,t),s=n[o],a=i.type;switch(a){case"string":var c=M(i.maxLength,"maxLength not set");r+="string"==typeof s&&s!==L?s.padEnd(c," "):"".padEnd(c,s===B?" ":L);break;case"boolean":r+=null===s||s?"1":"0";break;case"number":case"integer":var u=Nn(i);r+=null===s||s===L?"9".repeat(u.nonDecimals+u.decimals):s===B?"0".repeat(u.nonDecimals+u.decimals):Cn(u,s);break;default:throw new Error("unknown index type "+a)}})),r}function An(e){return e.join("||")}function Mn(e,t){var n=An(t);return xn(e.indexIdByName,n)}var $n={locale:null,unique:!1};function Ln(e,t,n,r){for(var o={i:n,d:r,i0:void 0,i1:void 0,i2:void 0,i3:void 0,i4:void 0,i5:void 0,i6:void 0,i7:void 0},i=0;i<e;++i){var s=(0,t[i])(r);o["i"+i]=s}return o}var Bn=["_deleted","_meta.lwt"];An(Bn);var Rn="documents",Kn="wal",qn="attachments",Wn={durability:"relaxed"},zn="indexeddb",Fn=0;function Un(e,t){return e+"||"+t}var Qn=new Map;function Jn(e,t){var n=In(Qn,e,(()=>En));return n=M(n).then((()=>t())),Qn.set(e,n),n}function Vn(e,t){t.onversionchange=n=>{e.closed||(t.close(),e.creationPromise=e.refreshIDBDatabase())}}async function Gn(e,t,n,r){var o=await In(e.indexedDBStates,n.databaseName,(()=>async function(e,t,n){var r=Fn++,o=await function(e,t){return"function"==typeof t?t(e):t}(e,n.indexedDB),i=async()=>(await _n(0),Jn(e.databaseName,(()=>new Promise(((t,n)=>{var i=o.open(e.databaseName);i.onerror=function(t){console.error(r+": OPEN IDB DATABASE "+e.databaseName+" ERROR"),n(t)},i.onsuccess=function(e){var n=i.result;t(n),Vn(s,n)},Xn(s,i)}))))),s={indexedDB:o,debugId:r,closed:!1,storage:t,settings:n,refreshIDBDatabase:i,creationPromise:i(),name:e.databaseName,refCount:0,storesToOpen:[]};return s}(n,e,t)));return o.storesToOpen=o.storesToOpen.concat(r),o.refCount=o.refCount+1,o.creationPromise.then((()=>Hn(M(o)))).then((()=>M(o)))}async function Hn(e){if(0!==e.storesToOpen.length)return e.creationPromise=e.creationPromise.then((async t=>{var n=new Set(Array.from(t.objectStoreNames));if(0===e.storesToOpen.filter((e=>!n.has(Yn(e.collectionName,e.schema).documentStore))).length)return t;var r=t.version+1;return t.close(),Jn(e.name,(()=>new Promise((async(t,n)=>{var o=e.indexedDB.open(e.name,r);o.onerror=function(t){console.error(e.debugId+": ERROR openStoresOnExistingDatabase() openRequest: error "),n(t)},o.onsuccess=function(n){var r=o.result;Vn(e,r),t(r)},o.onblocked=e=>{},Xn(e,o)}))))})),e.creationPromise}function Yn(e,t){var n=t.version;return{documentStore:e+"-"+n+"-"+Rn,writeAheadStore:e+"-"+n+"-"+Kn,attachmentsStore:e+"-"+n+"-"+qn}}function Xn(e,t){t.onupgradeneeded=function(n){var r=t.result;e.storesToOpen.forEach((e=>{var t=r.objectStoreNames,n=Yn(e.collectionName,e.schema);if(!t.contains(n.documentStore)){var o=r.createObjectStore(n.documentStore,{keyPath:"i",autoIncrement:!1});r.createObjectStore(n.writeAheadStore,{keyPath:"i",autoIncrement:!1}),function(e,t){t.indexIds.forEach((t=>{e.createIndex(t,t,$n)}))}(o,e),e.schema.attachments&&r.createObjectStore(n.attachmentsStore,{keyPath:"docIdWithAttachmentId",autoIncrement:!1})}})),e.storesToOpen=[]}}function Zn(e){if(e.closed)throw new Error("RxStorageInstanceIndexedDB is closed "+e.databaseName+"-"+e.collectionName)}async function er(e,t){var n=e.primaryPath,r=e.internals.indexIds.length,o=e.internals.getIndexableStringByIndexNumber,i=t.objectStore(e.internals.storeNames.writeAheadStore),s=await new Promise(((e,t)=>{var n=i.get("documents");n.onerror=t,n.onsuccess=t=>{var r=n.result;e(r?JSON.parse(r.docsData):void 0)}}));if(s&&s.length>0){for(var a,c=t.objectStore(e.internals.storeNames.documentStore),u=0;u<s.length;++u){var l=s[u],f=Ln(r,o,l[n],l);a=c.put(f)}await new Promise(((e,t)=>{a.onerror=t,a.onsuccess=()=>e(!0)})),i.delete("documents")}return t}async function tr(e){var t,n=[e.internals.storeNames.documentStore,e.internals.storeNames.writeAheadStore];e.schema.attachments&&n.push(e.internals.storeNames.attachmentsStore);for(var r=100;r>0;){var o=await e.internals.state.creationPromise;r-=1;try{t=o.transaction(n,"readwrite",Wn)}catch(t){if("InvalidStateError"!==t.name&&"NotFoundError"!==t.name||!(r>0))throw t;"NotFoundError"===t.name?await Hn(e.internals.state):e.internals.state.creationPromise=e.internals.state.refreshIDBDatabase()}}return await er(e,M(t)),M(t)}var nr=function(){function e(e){this.allTasksRuns=[],this.instance=e,this.txPromise=tr(this.instance).then((t=>er(e,t)))}return e.prototype.addTask=function(e){var t=this.txPromise.then((t=>e(t))),n=t.catch((()=>null));this.allTasksRuns.push(n);var r=this.allTasksRuns.length;return n.then((()=>Promise.all(this.allTasksRuns))).then((()=>{this.allTasksRuns.length===r&&(this.instance.openReadonlyTransaction=void 0)})),t.catch((t=>{if("TransactionInactiveError"===t.name)return this.instance.openReadonlyTransaction=void 0,rr(this.instance,e);throw t}))},e}();function rr(e,t){return e.openReadonlyTransaction||(e.openReadonlyTransaction=new nr(e)),e.openReadonlyTransaction.addTask(t)}var or=function(e,t){return or=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},or(e,t)};function ir(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}or(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function sr(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function ar(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function cr(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ur(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function lr(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function fr(e){return this instanceof fr?(this.v=e,this):new fr(e)}function dr(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,o=n.apply(e,t||[]),i=[];return r={},s("next"),s("throw"),s("return",(function(e){return function(t){return Promise.resolve(t).then(e,u)}})),r[Symbol.asyncIterator]=function(){return this},r;function s(e,t){o[e]&&(r[e]=function(t){return new Promise((function(n,r){i.push([e,t,n,r])>1||a(e,t)}))},t&&(r[e]=t(r[e])))}function a(e,t){try{(n=o[e](t)).value instanceof fr?Promise.resolve(n.value.v).then(c,u):l(i[0][2],n)}catch(e){l(i[0][3],e)}var n}function c(e){a("next",e)}function u(e){a("throw",e)}function l(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}}function hr(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=cr(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,o){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,o,(t=e[n](t)).done,t.value)}))}}}function pr(e){return"function"==typeof e}function mr(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var vr=mr((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function yr(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var br=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,o;if(!this.closed){this.closed=!0;var i=this._parentage;if(i)if(this._parentage=null,Array.isArray(i))try{for(var s=cr(i),a=s.next();!a.done;a=s.next())a.value.remove(this)}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}else i.remove(this);var c=this.initialTeardown;if(pr(c))try{c()}catch(e){o=e instanceof vr?e.errors:[e]}var u=this._finalizers;if(u){this._finalizers=null;try{for(var l=cr(u),f=l.next();!f.done;f=l.next()){var d=f.value;try{xr(d)}catch(e){o=null!=o?o:[],e instanceof vr?o=lr(lr([],ur(o)),ur(e.errors)):o.push(e)}}}catch(e){n={error:e}}finally{try{f&&!f.done&&(r=l.return)&&r.call(l)}finally{if(n)throw n.error}}}if(o)throw new vr(o)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)xr(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&yr(t,e)},e.prototype.remove=function(t){var n=this._finalizers;n&&yr(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),gr=br.EMPTY;function wr(e){return e instanceof br||e&&"closed"in e&&pr(e.remove)&&pr(e.add)&&pr(e.unsubscribe)}function xr(e){pr(e)?e():e.unsubscribe()}var Ir={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},_r={setTimeout:function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=_r.delegate;return(null==o?void 0:o.setTimeout)?o.setTimeout.apply(o,lr([e,t],ur(n))):setTimeout.apply(void 0,lr([e,t],ur(n)))},clearTimeout:function(e){var t=_r.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function Sr(e){_r.setTimeout((function(){var t=Ir.onUnhandledError;if(!t)throw e;t(e)}))}function Or(){}var Er=kr("C",void 0,void 0);function kr(e,t,n){return{kind:e,value:t,error:n}}var Pr=null;function jr(e){if(Ir.useDeprecatedSynchronousErrorHandling){var t=!Pr;if(t&&(Pr={errorThrown:!1,error:null}),e(),t){var n=Pr,r=n.errorThrown,o=n.error;if(Pr=null,r)throw o}}else e()}var Nr=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,wr(t)&&t.add(n)):n.destination=Lr,n}return ir(t,e),t.create=function(e,t,n){return new Ar(e,t,n)},t.prototype.next=function(e){this.isStopped?$r(function(e){return kr("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?$r(kr("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?$r(Er,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(br),Cr=Function.prototype.bind;function Dr(e,t){return Cr.call(e,t)}var Tr=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){Mr(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){Mr(e)}else Mr(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){Mr(e)}},e}(),Ar=function(e){function t(t,n,r){var o,i,s=e.call(this)||this;return pr(t)||!t?o={next:null!=t?t:void 0,error:null!=n?n:void 0,complete:null!=r?r:void 0}:s&&Ir.useDeprecatedNextContext?((i=Object.create(t)).unsubscribe=function(){return s.unsubscribe()},o={next:t.next&&Dr(t.next,i),error:t.error&&Dr(t.error,i),complete:t.complete&&Dr(t.complete,i)}):o=t,s.destination=new Tr(o),s}return ir(t,e),t}(Nr);function Mr(e){var t;Ir.useDeprecatedSynchronousErrorHandling?(t=e,Ir.useDeprecatedSynchronousErrorHandling&&Pr&&(Pr.errorThrown=!0,Pr.error=t)):Sr(e)}function $r(e,t){var n=Ir.onStoppedNotification;n&&_r.setTimeout((function(){return n(e,t)}))}var Lr={closed:!0,next:Or,error:function(e){throw e},complete:Or},Br="function"==typeof Symbol&&Symbol.observable||"@@observable";function Rr(e){return e}function Kr(e){return 0===e.length?Rr:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var qr=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,o=this,i=(r=e)&&r instanceof Nr||function(e){return e&&pr(e.next)&&pr(e.error)&&pr(e.complete)}(r)&&wr(r)?e:new Ar(e,t,n);return jr((function(){var e=o,t=e.operator,n=e.source;i.add(t?t.call(i,n):n?o._subscribe(i):o._trySubscribe(i))})),i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=Wr(t))((function(t,r){var o=new Ar({next:function(t){try{e(t)}catch(e){r(e),o.unsubscribe()}},error:r,complete:t});n.subscribe(o)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[Br]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Kr(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=Wr(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function Wr(e){var t;return null!==(t=null!=e?e:Ir.Promise)&&void 0!==t?t:Promise}var zr=mr((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),Fr=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return ir(t,e),t.prototype.lift=function(e){var t=new Ur(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new zr},t.prototype.next=function(e){var t=this;jr((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var o=cr(t.currentObservers),i=o.next();!i.done;i=o.next())i.value.next(e)}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;jr((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;jr((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=this,r=n.hasError,o=n.isStopped,i=n.observers;return r||o?gr:(this.currentObservers=null,i.push(e),new br((function(){t.currentObservers=null,yr(i,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,o=t.isStopped;n?e.error(r):o&&e.complete()},t.prototype.asObservable=function(){var e=new qr;return e.source=this,e},t.create=function(e,t){return new Ur(e,t)},t}(qr),Ur=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return ir(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:gr},t}(Fr);function Qr(e){return function(t){if(function(e){return pr(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}var Jr=Array.isArray;function Vr(e,t,n,r,o){return new Gr(e,t,n,r,o)}var Gr=function(e){function t(t,n,r,o,i,s){var a=e.call(this,t)||this;return a.onFinalize=i,a.shouldUnsubscribe=s,a._next=n?function(e){try{n(e)}catch(e){t.error(e)}}:e.prototype._next,a._error=o?function(e){try{o(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,a._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,a}return ir(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(Nr),Hr=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function Yr(e){return pr(null==e?void 0:e.then)}function Xr(e){return pr(e[Br])}function Zr(e){return Symbol.asyncIterator&&pr(null==e?void 0:e[Symbol.asyncIterator])}function eo(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var to="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function no(e){return pr(null==e?void 0:e[to])}function ro(e){return dr(this,arguments,(function(){var t,n,r;return ar(this,(function(o){switch(o.label){case 0:t=e.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,fr(t.read())];case 3:return n=o.sent(),r=n.value,n.done?[4,fr(void 0)]:[3,5];case 4:return[2,o.sent()];case 5:return[4,fr(r)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function oo(e){return pr(null==e?void 0:e.getReader)}function io(e){if(e instanceof qr)return e;if(null!=e){if(Xr(e))return o=e,new qr((function(e){var t=o[Br]();if(pr(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(Hr(e))return r=e,new qr((function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()}));if(Yr(e))return n=e,new qr((function(e){n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,Sr)}));if(Zr(e))return so(e);if(no(e))return t=e,new qr((function(e){var n,r;try{for(var o=cr(t),i=o.next();!i.done;i=o.next()){var s=i.value;if(e.next(s),e.closed)return}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}e.complete()}));if(oo(e))return so(ro(e))}var t,n,r,o;throw eo(e)}function so(e){return new qr((function(t){(function(e,t){var n,r,o,i;return sr(this,void 0,void 0,(function(){var s,a;return ar(this,(function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),n=hr(e),c.label=1;case 1:return[4,n.next()];case 2:if((r=c.sent()).done)return[3,4];if(s=r.value,t.next(s),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),o={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),r&&!r.done&&(i=n.return)?[4,i.call(n)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function ao(e,t,n,r,o){void 0===r&&(r=0),void 0===o&&(o=!1);var i=t.schedule((function(){n(),o?e.add(this.schedule(null,r)):this.unsubscribe()}),r);if(e.add(i),!o)return i}function co(e,t,n){return void 0===n&&(n=1/0),pr(t)?co((function(n,r){return function(e,t){return Qr((function(n,r){var o=0;n.subscribe(Vr(r,(function(n){r.next(e.call(t,n,o++))})))}))}((function(e,o){return t(n,e,r,o)}))(io(e(n,r)))}),n):("number"==typeof t&&(n=t),Qr((function(t,r){return function(e,t,n,r,o,i,s,a){var c=[],u=0,l=0,f=!1,d=function(){!f||c.length||u||t.complete()},h=function(e){return u<r?p(e):c.push(e)},p=function(e){i&&t.next(e),u++;var a=!1;io(n(e,l++)).subscribe(Vr(t,(function(e){null==o||o(e),i?h(e):t.next(e)}),(function(){a=!0}),void 0,(function(){if(a)try{u--;for(var e=function(){var e=c.shift();s?ao(t,s,(function(){return p(e)})):p(e)};c.length&&u<r;)e();d()}catch(e){t.error(e)}})))};return e.subscribe(Vr(t,h,(function(){f=!0,d()}))),function(){null==a||a()}}(t,r,e,n)})))}function uo(e){return e[e.length-1]}function lo(e){return(t=uo(e))&&pr(t.schedule)?e.pop():void 0;var t}function fo(e,t){return void 0===t&&(t=0),Qr((function(n,r){n.subscribe(Vr(r,(function(n){return ao(r,e,(function(){return r.next(n)}),t)}),(function(){return ao(r,e,(function(){return r.complete()}),t)}),(function(n){return ao(r,e,(function(){return r.error(n)}),t)})))}))}function ho(e,t){return void 0===t&&(t=0),Qr((function(n,r){r.add(e.schedule((function(){return n.subscribe(r)}),t))}))}function po(e,t){if(!e)throw new Error("Iterable cannot be null");return new qr((function(n){ao(n,t,(function(){var r=e[Symbol.asyncIterator]();ao(n,t,(function(){r.next().then((function(e){e.done?n.complete():n.next(e.value)}))}),0,!0)}))}))}function mo(e,t){if(null!=e){if(Xr(e))return function(e,t){return io(e).pipe(ho(t),fo(t))}(e,t);if(Hr(e))return function(e,t){return new qr((function(n){var r=0;return t.schedule((function(){r===e.length?n.complete():(n.next(e[r++]),n.closed||this.schedule())}))}))}(e,t);if(Yr(e))return function(e,t){return io(e).pipe(ho(t),fo(t))}(e,t);if(Zr(e))return po(e,t);if(no(e))return function(e,t){return new qr((function(n){var r;return ao(n,t,(function(){r=e[to](),ao(n,t,(function(){var e,t,o;try{t=(e=r.next()).value,o=e.done}catch(e){return void n.error(e)}o?n.complete():n.next(t)}),0,!0)})),function(){return pr(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(oo(e))return function(e,t){return po(ro(e),t)}(e,t)}throw eo(e)}function vo(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=lo(e),r=function(e,t){return"number"==typeof uo(e)?e.pop():t}(e,1/0);return e=function(e){return 1===e.length&&Jr(e[0])?e[0]:e}(e),Qr((function(t,o){(function(e){return void 0===e&&(e=1/0),co(Rr,e)})(r)(function(e,t){return t?mo(e,t):io(e)}(lr([t],ur(e)),n)).subscribe(o)}))}Promise.resolve(!1);var yo=Promise.resolve(!0),bo=Promise.resolve();function go(e,t){return e||(e=0),new Promise((function(n){return setTimeout((function(){return n(t)}),e)}))}function wo(){return Math.random().toString(36).substring(2)}var xo=0;function Io(){var e=1e3*Date.now();return e<=xo&&(e=xo+1),xo=e,e}var _o={create:function(e){var t={time:Io(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),bo}catch(e){return Promise.reject(e)}},canBeUsed:function(){if("undefined"!=typeof globalThis&&globalThis.Deno&&globalThis.Deno.args)return!0;if("undefined"==typeof window&&"undefined"==typeof self||"function"!=typeof BroadcastChannel)return!1;if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0},type:"native",averageResponseTime:function(){return 150},microSeconds:Io};class So{ttl;map=new Map;_to=!1;constructor(e){this.ttl=e}has(e){return this.map.has(e)}add(e){this.map.set(e,Oo()),this._to||(this._to=!0,setTimeout((()=>{this._to=!1,function(e){const t=Oo()-e.ttl,n=e.map[Symbol.iterator]();for(;;){const r=n.next().value;if(!r)return;const o=r[0];if(!(r[1]<t))return;e.map.delete(o)}}(this)}),0))}clear(){this.map.clear()}}function Oo(){return Date.now()}function Eo(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var ko="pubkey.broadcast-channel-0-",Po="messages",jo={durability:"relaxed"};function No(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function Co(e){e.commit&&e.commit()}function Do(e,t){var n=e.transaction(Po,"readonly",jo),r=n.objectStore(Po),o=[],i=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var s=r.getAll(i);return new Promise((function(e,t){s.onerror=function(e){return t(e)},s.onsuccess=function(t){e(t.target.result)}}))}return new Promise((function(e,s){var a=function(){try{return i=IDBKeyRange.bound(t+1,1/0),r.openCursor(i)}catch(e){return r.openCursor()}}();a.onerror=function(e){return s(e)},a.onsuccess=function(r){var i=r.target.result;i?i.value.id<t+1?i.continue(t+1):(o.push(i.value),i.continue()):(Co(n),e(o))}}))}function To(e){return(t=e.db,n=e.options.idb.ttl,r=Date.now()-n,o=t.transaction(Po,"readonly",jo),i=o.objectStore(Po),s=[],new Promise((function(e){i.openCursor().onsuccess=function(t){var n=t.target.result;if(n){var i=n.value;i.time<r?(s.push(i),n.continue()):(Co(o),e(s))}else e(s)}}))).then((function(t){return function(e,t){if(e.closed)return Promise.resolve([]);var n=e.db.transaction(Po,"readwrite",jo).objectStore(Po);return Promise.all(t.map((function(e){var t=n.delete(e);return new Promise((function(e){t.onsuccess=function(){return e()}}))})))}(e,t.map((function(e){return e.id})))}));var t,n,r,o,i,s}function Ao(e){e.closed||Mo(e).then((function(){return go(e.options.idb.fallbackInterval)})).then((function(){return Ao(e)}))}function Mo(e){return e.closed?bo:e.messagesCallback?Do(e.db,e.lastCursorId).then((function(t){var n=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return n.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),bo})):bo}var $o={create:function(e,t){return t=Eo(t),function(e){var t=No(),n=ko+e,r=t.open(n);return r.onupgradeneeded=function(e){e.target.result.createObjectStore(Po,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){r.onerror=function(e){return t(e)},r.onsuccess=function(){e(r.result)}}))}(e).then((function(n){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:wo(),eMIs:new So(2*t.idb.ttl),writeBlockPromise:bo,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},Ao(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,Mo(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,t,n){var r={uuid:t,time:Date.now(),data:n},o=e.transaction([Po],"readwrite",jo);return new Promise((function(e,t){o.oncomplete=function(){return e()},o.onerror=function(e){return t(e)},o.objectStore(Po).add(r),Co(o)}))}(e.db,e.uuid,t)})).then((function(){var t,n;0===(t=0,n=10,Math.floor(Math.random()*(n-t+1)+t))&&To(e)})),e.writeBlockPromise},canBeUsed:function(){return!!No()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:Io},Lo="pubkey.broadcastChannel-";function Bo(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function Ro(e){return Lo+e}function Ko(){var e=Bo();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}var qo,Wo={create:function(e,t){if(t=Eo(t),!Ko())throw new Error("BroadcastChannel: localstorage cannot be used");var n=wo(),r=new So(t.localstorage.removeTimeout),o={channelName:e,uuid:n,eMIs:r};return o.listener=function(e,t){var n=Ro(e),r=function(e){e.key===n&&t(JSON.parse(e.newValue))};return window.addEventListener("storage",r),r}(e,(function(e){o.messagesCallback&&e.uuid!==n&&e.token&&!r.has(e.token)&&(e.data.time&&e.data.time<o.messagesCallbackTime||(r.add(e.token),o.messagesCallback(e.data)))})),o},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){go().then((function(){var r=Ro(e.channelName),o={token:wo(),time:Date.now(),data:t,uuid:e.uuid},i=JSON.stringify(o);Bo().setItem(r,i);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=r,s.newValue=i,window.dispatchEvent(s),n()}))}))},canBeUsed:Ko,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:Io},zo=Io,Fo=new Set,Uo={create:function(e){var t={time:zo(),name:e,messagesCallback:null};return Fo.add(t),t},close:function(e){Fo.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){return setTimeout((function(){Array.from(Fo).forEach((function(n){n.name===e.name&&n!==e&&n.messagesCallback&&n.time<t.time&&n.messagesCallback(t)})),n()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:zo},Qo=[_o,$o,Wo],Jo=new Set,Vo=0,Go=function(e,t){var n,r,o;this.id=Vo++,Jo.add(this),this.name=e,qo&&(t=qo),this.options=Eo(t),this.method=function(e){var t=[].concat(e.methods,Qo).filter(Boolean);if(e.type){if("simulate"===e.type)return Uo;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No usable method found in "+JSON.stringify(Qo.map((function(e){return e.type}))))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,(o=r=(n=this).method.create(n.name,n.options))&&"function"==typeof o.then?(n._prepP=r,r.then((function(e){n._state=e}))):n._state=r};function Ho(e,t,n){var r={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:bo).then((function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function Yo(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function Xo(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&Yo(e)){var t=function(t){e._addEL[t.type].forEach((function(e){t.time>=e.time&&e.fn(t.data)}))},n=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,n)})):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function Zo(e,t,n){e._addEL[t]=e._addEL[t].filter((function(e){return e!==n})),function(e){if(e._iL&&!Yo(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}Go._pubkey=!0,Go.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return Ho(this,"message",e)},postInternal:function(e){return Ho(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};Zo(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,Xo(this,"message",t)):this._onML=null},addEventListener:function(e,t){Xo(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){Zo(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){Jo.delete(this),this.closed=!0;var t=this._prepP?this._prepP:bo;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};var ei=new Map;function ti(e,t){var n=ei.get(e);if(n)return n.refs.delete(t),0===n.refs.size?(ei.delete(e),n.bc.close()):void 0}function ni(e,t,n,r){if(t.multiInstance){var o=r||function(e,t,n,r){var o=ei.get(t);return o||(o={bc:new Go(["RxDB:",e,n].join("|")),refs:new Set},ei.set(t,o)),o.refs.add(r),o.bc}(e,t.databaseInstanceToken,n.databaseName,n),i=new Fr,s=n=>{n.storageName===e&&n.databaseName===t.databaseName&&n.collectionName===t.collectionName&&n.version===t.schema.version&&i.next(n.eventBulk)};o.addEventListener("message",s);var a=n.changeStream(),c=!1,u=a.subscribe((n=>{c||o.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:n})}));n.changeStream=function(){return i.asObservable().pipe(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return vo.apply(void 0,lr([],ur(e)))}(a))};var l=n.close.bind(n);n.close=async function(){return c=!0,u.unsubscribe(),o.removeEventListener("message",s),r||await ti(t.databaseInstanceToken,n),l()};var f=n.remove.bind(n);n.remove=async function(){return c=!0,u.unsubscribe(),o.removeEventListener("message",s),r||await ti(t.databaseInstanceToken,n),f()}}}async function ri(e,t){return rr(e,(async n=>{var r=t.queryPlan,o=t.query,i=o.skip?o.skip:0,s=i+(o.limit?o.limit:1/0),a=e.internals.storeNames.documentStore,c=e.settings.batchSize?e.settings.batchSize:50,u=!1;r.selectorSatisfiedByIndex||(u=cn(e.schema,o));var l,f=r.index,d=!r.sortSatisfiedByIndex,h=f,p=r.startKeys,m=Dn(e.schema,h,p),v=r.endKeys,y=Tn(e.schema,h,v),b=[],g=n.objectStore(a),w=Mn(e.internals,h);l=g.index(w),u||t.query.limit||(c=1e5);var x=!1;if(await async function(e,t,n,r,o,i,s,a){var c=e.settings.IDBKeyRange?e.settings.IDBKeyRange:IDBKeyRange,u=e.internals.getIndexableStringByIndexId[s];if("function"==typeof n.getAll&&1!==r)for(var l,f=!0,d=!1,h=async function(){l&&(o=u(l.d));var e=c.bound(o,i,!f||!t.inclusiveStart,!t.inclusiveEnd);f=!1;var s=n.getAll(e,r);await new Promise(((e,t)=>{s.onerror=t,s.onsuccess=t=>{var n=t.target.result;l=S(n),0!==n.length&&!1===a(n)&&(d=!0),n.length<r&&(d=!0),e()}}))};!d;)await h();else{var p=c.bound(o,i,!t.inclusiveStart,!t.inclusiveEnd),m=n.openCursor(p);await new Promise((e=>{m.onsuccess=function(t){var n=t.target.result;if(n){var r=n.value;a([r])?n.continue():e()}else e()}}))}}(e,r,l,c,m,y,w,(e=>{for(var t=0;t<e.length;t++){var n=e[t].d;if(x||u&&!u(n)||b.push(n),!d&&b.length===s){x=!0;break}}return!x})),d){var I=an(e.schema,o);b=b.sort(I)}return{documents:b=b.slice(i,s)}}))}async function oi(e,t,n){var r=e.primaryPath,o=e.internals,i=e.internals.state;await i.creationPromise;var s=[o.storeNames.documentStore,o.storeNames.writeAheadStore];e.schema.attachments&&s.push(o.storeNames.attachmentsStore),Zn(e);var a,c=await tr(e),u=c.objectStore(o.storeNames.documentStore);a=0===e.internals.minKnownDocsAmount&&t.length>30&&!await function(e,t){var n=(e.settings.IDBKeyRange?e.settings.IDBKeyRange:IDBKeyRange).lowerBound(B,!0),r=t.getKey(n);return new Promise((e=>{r.onsuccess=()=>{e(!!r.result)}}))}(e,u)?new Map:await function(e,t,n){var r=n.length,o=new Map;if(0===r)return Promise.resolve(o);for(var i=new Array(r),s=0;s<r;s++){var a=n[s].document[e],c=t.get(a);i[s]=c}var u=M(S(i));return new Promise(((t,n)=>{u.onerror=n,u.onsuccess=()=>{for(var n=0;n<r;n++){var s=i[n].result;if(s){var a=s.d,c=a[e];o.set(c,a)}}t(o)}}))}(r,u,t);for(var l=ln(e,r,a,t,n),f=l.errors,d=l.bulkInsertDocs,h=new Array(d.length),p=0;p<d.length;++p){var m=d[p].document;h[p]=m}for(var v=l.bulkUpdateDocs,y=0;y<v.length;++y){var b=v[y].document;h.push(b)}if(h.length>0){var g=c.objectStore(o.storeNames.writeAheadStore).put({i:"documents",docsData:JSON.stringify(h)});await new Promise(((e,t)=>{g.onerror=t,g.onsuccess=e})),e.handleWalIdlePromise||_n(100).then((()=>kn())).then((async()=>{e.handleWalIdlePromise=void 0,e.closed||await rr(e,(()=>On))}))}var w=void 0;if(e.schema.attachments){var x=c.objectStore(e.internals.storeNames.attachmentsStore);l.attachmentsAdd.forEach((e=>{w=x.put({docIdWithAttachmentId:Un(e.documentId,e.attachmentId),length:e.attachmentData.length,type:e.attachmentData.type,data:e.attachmentData.data})})),l.attachmentsUpdate.forEach((e=>{w=x.put({docIdWithAttachmentId:Un(e.documentId,e.attachmentId),length:e.attachmentData.length,type:e.attachmentData.type,data:e.attachmentData.data})})),l.attachmentsRemove.forEach((e=>{w=x.delete(Un(e.documentId,e.attachmentId))}))}if(w&&await new Promise(((e,t)=>{M(w).onerror=t,M(w).onsuccess=e})),c.commit&&c.commit(),l.eventBulk.events.length>0){var I=M(l.newestRow).document;l.eventBulk.checkpoint={id:I[r],lwt:I._meta.lwt},l.eventBulk.endTime=A(),e.changes$.next(l.eventBulk)}return{error:f}}var ii=A(),si=function(){function e(e,t,n,r,o,i,s){this.changes$=new Fr,this.instanceId=ii++,this.storage=e,this.databaseName=t,this.collectionName=n,this.schema=r,this.internals=o,this.options=i,this.settings=s,this.primaryPath=N(this.schema.primaryKey)}var t=e.prototype;return t.updateMinKnownDocs=function(e){this.internals.minKnownDocsAmount<e&&(this.internals.minKnownDocsAmount=e)},t.bulkWrite=async function(e,t){var n=await oi(this,e,t);return this.updateMinKnownDocs(e.length-n.error.length),n},t.findDocumentsById=async function(e,t){Zn(this);var n=await rr(this,(async n=>function(e,t,n){var r=t.length;if(0===r)return Promise.resolve([]);for(var o=new Array,i=0;i<r;i++){var s=t[i];o.push(e.get(s))}var a=[],c=M(S(o));return new Promise(((e,t)=>{c.onerror=t,c.onsuccess=()=>{for(var t=0;t<r;t++){var i=o[t].result;if(i){var s=i.d;!n&&s._deleted||a.push(s)}}e(a)}}))}(n.objectStore(this.internals.storeNames.documentStore),e,t)));return this.updateMinKnownDocs(n.length),n},t.query=async function(e){await this.internals.state.creationPromise,Zn(this);var t=await ri(this,e);return this.updateMinKnownDocs(t.documents.length),t},t.count=async function(e){if(e.queryPlan.selectorSatisfiedByIndex){var t=await async function(e,t){return rr(e,(async n=>{var r,o,i=t.queryPlan,s=e.internals.storeNames.documentStore,a=i.index,c=a,u=i.startKeys,l=Dn(e.schema,c,u),f=i.endKeys,d=Tn(e.schema,c,f),h=n.objectStore(s);o=1===a.length&&a[0]===e.primaryPath?Mn(e.internals,["_deleted",e.primaryPath]):Mn(e.internals,c),r=h.index(o);var p=(e.settings.IDBKeyRange?e.settings.IDBKeyRange:IDBKeyRange).bound(l,d,!i.inclusiveStart,!i.inclusiveEnd),m=r.count(p);return{count:await new Promise(((e,t)=>{m.onsuccess=function(){e(m.result)},m.onerror=t})),mode:"fast"}}))}(this,e);return this.updateMinKnownDocs(t.count),t}var n=await ri(this,e);return this.updateMinKnownDocs(n.documents.length),{count:n.documents.length,mode:"slow"}},t.changeStream=function(){return this.changes$.asObservable()},t.cleanup=async function(e){var t=this.internals.state;await t.creationPromise;var n=this.settings.IDBKeyRange;return Zn(this),rr(this,(async t=>{var r=t.objectStore(this.internals.storeNames.documentStore),o=this.settings.batchSize,i=A()-e,s=Mn(this.internals,Bn),a=r.index(s),c=Dn(this.schema,Bn,[!0,1]),u=Tn(this.schema,Bn,[!0,i]),l=n.bound(c,u,!0,!0),f=await new Promise(((e,t)=>{var n=a.getAll(l,o);n.onerror=t,n.onsuccess=function(t){e(t.target.result)}}));return await Promise.all(f.map((e=>new Promise(((t,n)=>{var o=e.i,i=r.delete(o);i.onerror=n,i.onsuccess=()=>t()}))))),f.length<o}))},t.remove=async function(){var e=this.internals.state;return await e.creationPromise,Zn(this),rr(this,(async e=>{var t=[e.objectStore(this.internals.storeNames.documentStore),e.objectStore(this.internals.storeNames.writeAheadStore)];return this.schema.attachments&&t.push(e.objectStore(this.internals.storeNames.attachmentsStore)),await Promise.all(t.map((e=>new Promise(((t,n)=>{var r=e.clear();r.onerror=n,r.onsuccess=t}))))),this.close()}))},t.getAttachmentData=async function(e,t){var n=this.internals.state;return await n.creationPromise,Zn(this),rr(this,(n=>{var r=n.objectStore(this.internals.storeNames.attachmentsStore),o=Un(e,t);return new Promise(((n,i)=>{var s=r.get(o);s.onsuccess=()=>{var r=s.result;r?n(r.data):i("attachment missing documentId: "+e+" attachmentId: "+t)}}))}))},t.close=async function(){return this.closed||(this.closed=(async()=>(await this.internals.state.creationPromise,await rr(this,(async e=>{})),this.changes$.complete(),async function(e){if(!e.closed&&(e.refCount=e.refCount-1,0===e.refCount))return e.closed=!0,e.storage.indexedDBStates.delete(e.name),e.creationPromise.then((e=>e.close()))}(this.internals.state)))()),this.closed},t.conflictResultionTasks=function(){return(new Fr).asObservable()},t.resolveConflictResultionTask=function(e){return En},e}();async function ai(e,t,n){var r=function(e){var t={},n=e.indexes?e.indexes.map((e=>Array.isArray(e)?e.slice(0):[e])):[];n.push(Bn);var r=new Map;return n.forEach(((n,o)=>{var i="i"+o,s=An(n);if(r.has(s))throw new Error("duplicate index "+s);r.set(s,i),t[i]=jn(e,n)})),{indexIdByName:r,monadByIndexId:t}}(t.schema),o=Array.from(r.indexIdByName.values()),i=await Gn(e,n,t,[{collectionName:t.collectionName,schema:t.schema,indexIds:o}]);await i.creationPromise;var s={state:i,storeNames:Yn(t.collectionName,t.schema),getIndexableStringByIndexId:r.monadByIndexId,getIndexableStringByIndexNumber:Object.values(r.monadByIndexId),indexIdByName:r.indexIdByName,indexNames:Object.keys(r),indexIds:o,minKnownDocsAmount:0},a=new si(e,t.databaseName,t.collectionName,t.schema,s,t.options,n);return await ni(zn,t,a),a}var ci=function(){function e(e){this.name=zn,this.rxdbVersion=gn,this.indexedDBStates=new Map,this.settings=e}return e.prototype.createStorageInstance=function(e){return mn(e),wn(),ai(this,e,Object.assign({},this.settings,e.options))},e}(),ui="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?function(e){process.on("exit",(function(){return e()})),process.on("beforeExit",(function(){return e().then((function(){return process.exit()}))})),process.on("SIGINT",(function(){return e().then((function(){return process.exit()}))})),process.on("uncaughtException",(function(t){return e().then((function(){console.trace(t),process.exit(101)}))}))}:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}},li=new Set,fi=!1;function di(e){if(fi||(fi=!0,ui(hi)),"function"!=typeof e)throw new Error("Listener is no function");return li.add(e),{remove:function(){return li.delete(e)},run:function(){return li.delete(e),e()}}}function hi(){var e=[];return li.forEach((function(t){e.push(t()),li.delete(t)})),Promise.all(e)}function pi(e,t){var n={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(n)}function mi(e){e.isLeader=!0,e._hasLeader=!0;var t=di((function(){return e.die()}));e._unl.push(t);var n=function(t){"leader"===t.context&&"apply"===t.action&&pi(e,"tell"),"leader"!==t.context||"tell"!==t.action||e._dpLC||(e._dpLC=!0,e._dpL(),pi(e,"tell"))};return e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n),pi(e,"tell")}var vi=function(e,t){var n=this;this.broadcastChannel=e,e._befC.push((function(){return n.die()})),this._options=t,this.isLeader=!1,this.isDead=!1,this.token=wo(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+e.method.type+"||"+e.name};vi.prototype={hasLeader:function(){var e=this;return navigator.locks.query().then((function(t){var n=t.held?t.held.filter((function(t){return t.name===e.lN})):[];return!!(n&&n.length>0)}))},awaitLeadership:function(){var e=this;if(!this._wLMP){this._wKMC.c=new AbortController;var t=new Promise((function(t,n){e._wKMC.res=t,e._wKMC.rej=n}));this._wLMP=new Promise((function(n){navigator.locks.request(e.lN,{signal:e._wKMC.c.signal},(function(){return e._wKMC.c=void 0,mi(e),n(),t})).catch((function(){}))}))}return this._wLMP},set onduplicate(e){},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),pi(this,"death")}};var yi=function(e,t){var n=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=wo(),this._aplQ=bo,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(e){"leader"===e.context&&("death"===e.action&&(n._hasLeader=!1),"tell"===e.action&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};function bi(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=function(e,t){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}(t,e);var n="undefined"!=typeof navigator&&void 0!==navigator.locks&&"function"==typeof navigator.locks.request?new vi(e,t):new yi(e,t);return e._befC.push((function(){return n.die()})),e._leaderElector=n,n}function gi(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;var n,r;if(Array.isArray(e)){if((n=e.length)!==t.length)return!1;for(r=n;0!=r--;)if(!gi(e[r],t[r]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var o=Object.keys(e);if((n=o.length)!==Object.keys(t).length)return!1;for(r=n;0!=r--;)if(!Object.prototype.hasOwnProperty.call(t,o[r]))return!1;for(r=n;0!=r--;){var i=o[r];if(!gi(e[i],t[i]))return!1}return!0}return e!=e&&t!=t}function wi(e,t,n,r,o){for(var i=o+1;r<=o;){var s=r+o>>>1,a=e[s];(void 0!==n?n(a,t):a-t)>=0?(i=s,o=s-1):r=s+1}return i}function xi(e,t,n,r,o){for(var i=o+1;r<=o;){var s=r+o>>>1,a=e[s];(void 0!==n?n(a,t):a-t)>0?(i=s,o=s-1):r=s+1}return i}function Ii(e,t,n,r,o){for(var i=r-1;r<=o;){var s=r+o>>>1,a=e[s];(void 0!==n?n(a,t):a-t)<0?(i=s,r=s+1):o=s-1}return i}function _i(e,t,n,r,o){for(var i=r-1;r<=o;){var s=r+o>>>1,a=e[s];(void 0!==n?n(a,t):a-t)<=0?(i=s,r=s+1):o=s-1}return i}function Si(e,t,n,r,o){for(;r<=o;){var i=r+o>>>1,s=e[i],a=void 0!==n?n(s,t):s-t;if(0===a)return i;a<=0?r=i+1:o=i-1}return-1}function Oi(e,t,n,r,o,i){return i(e,t,n,void 0===r?0:0|r,void 0===o?e.length-1:0|o)}function Ei(e,t,n,r,o){return Oi(e,t,n,r,o,wi)}function ki(e,t,n,r,o){return Oi(e,t,n,r,o,xi)}function Pi(e,t,n,r,o){return Oi(e,t,n,r,o,Ii)}function ji(e,t,n,r,o){return Oi(e,t,n,r,o,_i)}function Ni(e,t,n,r,o){return Oi(e,t,n,r,o,Si)}function Ci(e,t,n,r){var o,i=e.length,s=i-1,a=0;if(0===i)return e.push(t),0;for(;r<=s;)n(o=e[a=r+(s-r>>1)],t)<=0?r=a+1:s=a-1;return n(o,t)<=0&&a++,e.splice(a,0,t),a}function Di(e,t,n){return[e,t,n].join("--memory--")}function Ti(e){if(e.internals.removed)throw new Error("removed")}function Ai(e,t){return e+"||"+t}function Mi(e,t){return e[0]<t[0]?-1:1}function $i(e,t,n,r,o){t.documents.set(e,r);for(var i=0;i<n.length;++i){var s=n[i],a=s.docsWithIndex,c=s.getIndexableString,u=c(r),l=Ci(a,[u,r,e],Mi,0);if(o){var f=c(o);if(f===u){var h=a[l-1];if(h&&h[2]===e)a.splice(l-1,1);else{if(a[l+1][2]!==e)throw d("SNH",{document:r,args:{byIndex:s}});a.splice(l+1,1)}}else{var p=Ni(a,[f],Bi);a.splice(p,1)}}}}function Li(e,t,n,r){var o=r[e];n.documents.delete(o),Object.values(n.byIndex).forEach((e=>{var t=e.docsWithIndex,n=Ni(t,[e.getIndexableString(r)],Bi);t.splice(n,1)}))}function Bi(e,t){var n=e[0],r=t[0];return n<r?-1:n===r?0:1}function Ri(e){return e.join(",")}yi.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(e){var t=this;return this.isLeader?go(0,!0):this.isDead?go(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return function(){if(t.isLeader)return yo;var n,r=!1,o=new Promise((function(e){n=function(){r=!0,e()}})),i=function(e){"leader"===e.context&&e.token!=t.token&&("apply"===e.action&&e.token>t.token&&n(),"tell"===e.action&&(n(),t._hasLeader=!0))};t.broadcastChannel.addEventListener("internal",i);var s=e?4*t._options.responseTime:t._options.responseTime;return pi(t,"apply").then((function(){return Promise.race([go(s),o.then((function(){return Promise.reject(new Error)}))])})).then((function(){return pi(t,"apply")})).then((function(){return Promise.race([go(s),o.then((function(){return Promise.reject(new Error)}))])})).catch((function(){})).then((function(){return t.broadcastChannel.removeEventListener("internal",i),!r&&mi(t).then((function(){return!0}))}))}()})).then((function(){t._aplQC=t._aplQC-1})),this._aplQ.then((function(){return t.isLeader})))},awaitLeadership:function(){return this._aLP||(this._aLP=function(e){return e.isLeader?bo:new Promise((function(t){var n=!1;function r(){n||(n=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then((function(){e.isLeader&&r()})),function t(){return go(e._options.fallbackInterval).then((function(){if(!e.isDead&&!n)return e.isLeader?void r():e.applyOnce(!0).then((function(){e.isLeader?r():t()}))}))}();var o=function(t){"leader"===t.context&&"death"===t.action&&(e._hasLeader=!1,e.applyOnce().then((function(){e.isLeader&&r()})))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)}))}(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,pi(this,"death")}};var Ki=new Set,qi=function(){function e(e,t,n,r,o,i,s,a){this.closed=!1,this.categorizedByWriteInput=new WeakMap,this.storage=e,this.databaseName=t,this.collectionName=n,this.schema=r,this.internals=o,this.options=i,this.settings=s,this.devMode=a,Ki.add(this),this.primaryPath=N(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=function(e,t){this.ensurePersistence(),Ti(this);var n=this.internals,r=this.internals.documents,o=this.primaryPath,i=ln(this,o,r,e,t),s=i.errors,a=Promise.resolve({error:s});if(this.categorizedByWriteInput.set(e,i),this.internals.ensurePersistenceTask=i,this.internals.ensurePersistenceIdlePromise||(this.internals.ensurePersistenceIdlePromise=kn().then((()=>{this.internals.ensurePersistenceIdlePromise=void 0,this.ensurePersistence()}))),i.eventBulk.events.length>0){var c=M(i.newestRow).document;i.eventBulk.checkpoint={id:c[o],lwt:c._meta.lwt},i.eventBulk.endTime=A(),n.changes$.next(i.eventBulk)}return a},t.ensurePersistence=function(){if(this.internals.ensurePersistenceTask){var e=this.internals,t=this.internals.documents,n=this.primaryPath,r=this.internals.ensurePersistenceTask;this.internals.ensurePersistenceTask=void 0;for(var o=Object.values(this.internals.byIndex),i=r.bulkInsertDocs,s=0;s<i.length;++s){var a=i[s].document;$i(a[n],e,o,a,void 0)}for(var c=r.bulkUpdateDocs,u=0;u<c.length;++u){var l=c[u].document,f=l[n];$i(f,e,o,l,t.get(f))}if(this.schema.attachments){var d=e.attachments;r.attachmentsAdd.forEach((e=>{d.set(Ai(e.documentId,e.attachmentId),{writeData:e.attachmentData,digest:e.digest})})),this.schema.attachments&&(r.attachmentsUpdate.forEach((e=>{d.set(Ai(e.documentId,e.attachmentId),{writeData:e.attachmentData,digest:e.digest})})),r.attachmentsRemove.forEach((e=>{d.delete(Ai(e.documentId,e.attachmentId))})))}}},t.findDocumentsById=function(e,t){this.ensurePersistence();var n=this.internals.documents,r=[];if(0===n.size)return Promise.resolve(r);for(var o=0;o<e.length;++o){var i=e[o],s=n.get(i);!s||s._deleted&&!t||r.push(s)}return Promise.resolve(r)},t.query=function(e){this.ensurePersistence();var t=e.queryPlan,n=e.query,r=n.skip?n.skip:0,o=r+(n.limit?n.limit:1/0),i=!1;t.selectorSatisfiedByIndex||(i=cn(this.schema,e.query));var s=t.index,a=!t.sortSatisfiedByIndex,c=s,u=t.startKeys,l=Dn(this.schema,c,u),f=t.endKeys,d=Tn(this.schema,c,f),h=Ri(c);if(!this.internals.byIndex[h])throw new Error("index does not exist "+h);for(var p=this.internals.byIndex[h].docsWithIndex,m=(t.inclusiveStart?Ei:ki)(p,[l],Bi),v=(t.inclusiveEnd?ji:Pi)(p,[d],Bi),y=[],b=!1;!b;){var g=p[m];if(!g||m>v)break;var w=g[1];i&&!i(w)||y.push(w),y.length>=o&&!a&&(b=!0),m++}if(a){var x=an(this.schema,e.query);y=y.sort(x)}return y=y.slice(r,o),Promise.resolve({documents:y})},t.count=async function(e){return this.ensurePersistence(),{count:(await this.query(e)).documents.length,mode:"fast"}},t.cleanup=function(e){this.ensurePersistence();for(var t=A()-e,n=["_deleted","_meta.lwt",this.primaryPath],r=Ri(n),o=this.internals.byIndex[r].docsWithIndex,i=ki(o,[Dn(this.schema,n,[!0,0,""])],Bi),s=!1;!s;){var a=o[i];!a||a[1]._meta.lwt>t?s=!0:(Li(this.primaryPath,this.schema,this.internals,a[1]),i++)}return Sn},t.getAttachmentData=function(e,t,n){this.ensurePersistence(),Ti(this);var r=Ai(e,t),o=this.internals.attachments.get(r);if(!n||!o||o.digest!==n)throw new Error("attachment does not exist: "+r);return Promise.resolve(o.writeData.data)},t.changeStream=function(){return Ti(this),this.internals.changes$.asObservable()},t.remove=async function(){if(this.closed)throw new Error("closed");this.ensurePersistence(),Ti(this),this.internals.removed=!0,this.storage.collectionStates.delete(Di(this.databaseName,this.collectionName,this.schema.version)),await this.close()},t.close=function(){return Ki.delete(this),this.ensurePersistence(),this.closed||(this.closed=!0,this.internals.refCount=this.internals.refCount-1),En},t.conflictResultionTasks=function(){return this.internals.conflictResultionTasks$.asObservable()},t.resolveConflictResultionTask=function(e){return En},e}();function Wi(e,t,n){var r,o,i,s,a=Di(t.databaseName,t.collectionName,t.schema.version),c=e.collectionStates.get(a);if(c){if(t.devMode&&!gi(c.schema,t.schema))throw new Error("storage was already created with a different schema");c.refCount=c.refCount+1}else c={id:m(5),schema:t.schema,removed:!1,refCount:1,documents:new Map,attachments:t.schema.attachments?new Map:void 0,byIndex:{},conflictResultionTasks$:new Fr,changes$:new Fr},r=c,i=N((o=t.schema).primaryKey),(s=o.indexes?o.indexes.map((e=>O(e))):[]).push(["_deleted","_meta.lwt",i]),s.forEach((e=>{r.byIndex[Ri(e)]={index:e,docsWithIndex:[],getIndexableString:jn(o,e)}})),e.collectionStates.set(a,c);var u=new qi(e,t.databaseName,t.collectionName,t.schema,c,t.options,n,t.devMode);return Promise.resolve(u)}var zi=new Map,Fi=12;async function Ui(e){var t=await e.internals.initDonePromise,n=((t.lastBlockId?parseInt(t.lastBlockId):0)+1+"").padStart(Fi,"0");return t.lastBlockId=n,n}async function Qi(e){return(await e.query(F(e.schema,sn(e.schema,{selector:{c:{$eq:!1},_deleted:{$eq:!1}},sort:[{id:"desc"}]})))).documents}function Ji(e,t){return(t?function(e){for(var t="",n=0;n<e.length;n++){var r=e[n];if("-"===r)return parseInt(t,10);t+=r}throw new Error("malformatted revision: "+e)}(t._rev)+1:1)+"-"+e}function Vi(e,t){return Qr((function(n,r){var o=0;n.subscribe(Vr(r,(function(n){return e.call(t,n,o++)&&r.next(n)})))}))}var Gi={now:function(){return(Gi.delegate||Date).now()},delegate:void 0},Hi=function(e){function t(t,n,r){void 0===t&&(t=1/0),void 0===n&&(n=1/0),void 0===r&&(r=Gi);var o=e.call(this)||this;return o._bufferSize=t,o._windowTime=n,o._timestampProvider=r,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,t),o._windowTime=Math.max(1,n),o}return ir(t,e),t.prototype.next=function(t){var n=this,r=n.isStopped,o=n._buffer,i=n._infiniteTimeWindow,s=n._timestampProvider,a=n._windowTime;r||(o.push(t),!i&&o.push(s.now()+a)),this._trimBuffer(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),n=this._infiniteTimeWindow,r=this._buffer.slice(),o=0;o<r.length&&!e.closed;o+=n?1:2)e.next(r[o]);return this._checkFinalizedStatuses(e),t},t.prototype._trimBuffer=function(){var e=this,t=e._bufferSize,n=e._timestampProvider,r=e._buffer,o=e._infiniteTimeWindow,i=(o?1:2)*t;if(t<1/0&&i<r.length&&r.splice(0,r.length-i),!o){for(var s=n.now(),a=0,c=1;c<r.length&&r[c]<=s;c+=2)a=c;a&&r.splice(0,a+1)}},t}(Fr);function Yi(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!0!==t){if(!1!==t){var o=new Ar({next:function(){o.unsubscribe(),e()}});return io(t.apply(void 0,lr([],ur(n)))).subscribe(o)}}else e()}function Xi(e,t,n){var r,o,i,s,a=!1;return e&&"object"==typeof e?(r=e.bufferSize,s=void 0===r?1/0:r,o=e.windowTime,t=void 0===o?1/0:o,a=void 0!==(i=e.refCount)&&i,n=e.scheduler):s=null!=e?e:1/0,function(e){void 0===e&&(e={});var t=e.connector,n=void 0===t?function(){return new Fr}:t,r=e.resetOnError,o=void 0===r||r,i=e.resetOnComplete,s=void 0===i||i,a=e.resetOnRefCountZero,c=void 0===a||a;return function(e){var t,r,i,a=0,u=!1,l=!1,f=function(){null==r||r.unsubscribe(),r=void 0},d=function(){f(),t=i=void 0,u=l=!1},h=function(){var e=t;d(),null==e||e.unsubscribe()};return Qr((function(e,p){a++,l||u||f();var m=i=null!=i?i:n();p.add((function(){0!=--a||l||u||(r=Yi(h,c))})),m.subscribe(p),!t&&a>0&&(t=new Ar({next:function(e){return m.next(e)},error:function(e){l=!0,f(),r=Yi(d,o,e),m.error(e)},complete:function(){u=!0,f(),r=Yi(d,s),m.complete()}}),io(e).subscribe(t))}))(e)}}({connector:function(){return new Hi(s,t,n)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}async function Zi(e){return await e.internals.initDonePromise,e.writeQueue=e.writeQueue.then((async()=>{var t=e.internals.blockMap,n=e.primaryPath;if(0===t.cleanup.size)return!1;var r=Array.from(t.cleanup.entries());t.cleanup.clear();var o=await e.internals.persistentInstancePromise,i=await Qi(o);if(!i[0])return!1;for(var s=async function(){var t=r[a],i=t[1],s=await un(o,t[0]);if(!s)return 0;var c=!1,u=s.d.filter((e=>{var t=e[n];return!i.has(t)||(c=!0,!1)}));if(!c)return 0;var l=hn(s);l.d=u,l._rev=Ji(e.databaseInstanceToken,l),l._meta.lwt=A(),await o.bulkWrite([{document:l,previous:s}],"memory-mapped-cleanup-blocks-single-block")},a=0;a<r.length;a++)await s();for(var c=[],u=new Set,l=[],f=0;f<i.length;f++){var d=i[f];l.push(d.id);for(var h=0;h<d.d.length;h++){var p=d.d[h],m=p[n];u.has(m)||(u.add(m),c.push(p))}}var v={id:await Ui(e),_deleted:!1,_attachments:{},_meta:{lwt:A()},s:l,_rev:Ji(e.databaseInstanceToken),c:!0,d:c};return await async function(e,t,n){var r=await e.bulkWrite([t],n);if(r.error.length>0)throw r.error[0];return yn(N(e.schema.primaryKey),[t],r)[0]}(o,{document:v},"memory-mapped-cleanup-blocks"),await o.bulkWrite(i.map((t=>{var n=hn(t);return n._rev=Ji(e.databaseInstanceToken,t),n._deleted=!0,n._meta.lwt=A(),n.c=!0,{previous:t,document:n}})),"memory-mapped-cleanup-blocks-old-ones"),!0})),e.writeQueue}var es,ts=function(){function e(e,t,n,r,o,i,s,a){if(this.closed=!1,this.writeQueue=En,this.writeTasks=[],this.storage=e,this.databaseName=t,this.collectionName=n,this.databaseInstanceToken=r,this.schema=o,this.internals=i,this.options=s,this.devMode=a,this.primaryPath=N(this.schema.primaryKey),o.attachments)throw new Error("Attachments are not supported in the memory-mapped storage because storing attachments in memory would have bad performance")}var t=e.prototype;return t.bulkWrite=async function(e,t){var n=this.primaryPath;await this.internals.initDonePromise;var r=this.internals.memoryInstance.bulkWrite(e,t);return this.writeTasks.push(r.then((t=>yn(n,e,t)))),this.writeQueue=this.writeQueue.then((async()=>{if(0!==this.writeTasks.length){this.storage.settings.awaitWritePersistence||await kn();var e=this.writeTasks;this.writeTasks=[];for(var r=await Promise.all(e),o=[],i=0;i<r.length;i++){var s=r[i];if(0===s.length)return;for(var a=await Ui(this),c=this.internals.blockMap,u=0;u<s.length;u++){var l=s[u][n];c.set(l,a)}o.push({document:{id:a,c:!1,s:[],d:s,_attachments:{},_deleted:!1,_meta:{lwt:A()},_rev:Ji(this.databaseInstanceToken)}})}var f=await this.internals.persistentInstancePromise;if(o.length>0){var d=await f.bulkWrite(o,t);if(d.error[0])throw d.error[0]}}})),this.storage.settings.awaitWritePersistence&&await this.writeQueue,r},t.findDocumentsById=async function(e,t){return await this.internals.initDonePromise,this.internals.memoryInstance.findDocumentsById(e,t)},t.query=async function(e){return await this.internals.initDonePromise,await this.internals.memoryInstance.query(e)},t.count=async function(e){return await this.internals.initDonePromise,this.internals.memoryInstance.count(e)},t.getAttachmentData=async function(e,t,n){return await this.internals.initDonePromise,this.internals.memoryInstance.getAttachmentData(e,t,n)},t.changeStream=function(){var e=!1;return this.internals.initDonePromise.then((()=>e=!0)),this.internals.memoryInstance.changeStream().pipe(Vi((()=>!!e)),Xi($))},t.cleanup=async function(e){if(await this.internals.initDonePromise,await Zi(this))return!1;var[t,n]=await Promise.all([this.internals.memoryInstance.cleanup(e),this.internals.persistentInstancePromise.then((t=>t.cleanup(e)))]);return t&&n},t.close=async function(){await this.internals.initDonePromise,await this.writeQueue,await Zi(this),this.internals.refCount=this.internals.refCount-1,0===this.internals.refCount&&(this.storage.openInstances.delete(this.internals.cacheKey),await Promise.all([this.internals.memoryInstance.close(),this.internals.persistentInstancePromise.then((e=>e.close()))]),this.internals.leaderElector&&(this.internals.leaderElector.die(),this.internals.leaderElector.broadcastChannel.close()))},t.remove=async function(){await this.internals.initDonePromise,this.storage.openInstances.delete(this.internals.cacheKey),await this.writeQueue,await Promise.all([this.internals.memoryInstance.remove(),this.internals.persistentInstancePromise.then((e=>e.remove()))]),this.internals.leaderElector&&(this.internals.leaderElector.die(),this.internals.leaderElector.broadcastChannel.close())},t.conflictResultionTasks=function(){return this.internals.conflictResultionTasks$.asObservable()},t.resolveConflictResultionTask=function(e){return En},e}(),ns=function(){function e(){this.map=new Map,this.cleanup=new Map}var t=e.prototype;return t.addCleanup=function(e,t){In(this.cleanup,t,(()=>new Set)).add(e)},t.add=function(e,t){this.map.set(e,t)},t.set=function(e,t){var n=this.map.get(e);return this.map.set(e,t),void 0===n||(In(this.cleanup,n,(()=>new Set)).add(e),!1)},e}(),rs=function(e={}){return{name:"memory",rxdbVersion:bn,collectionStates:zi,createStorageInstance(t){return mn(t),Wi(this,t,Object.assign({},e,t.options))}}}(),os=function(){function e(e){this.name="memory-mapped",this.rxdbVersion=gn,this.openInstances=new Map,this.settings=e}return e.prototype.createStorageInstance=async function(e){var t=[e.databaseName,e.collectionName,e.schema.version].join("-"+this.name+"-");if(this.openInstances.has(t)){var n=await xn(this.openInstances,t);return n.internals.refCount=n.internals.refCount+1,n}var r=void 0,o=(async()=>{if(wn(),e.devMode&&e.multiInstance){var n=t+"|"+this.settings.storage.name,o=new Go(n);if(r=bi(o),await Promise.race([_n(3e3).then((()=>!0)),r.awaitLeadership().then((()=>!1))]))throw this.openInstances.delete(t),r.die(),o.close(),new Error("The memory-mapped RxStorage cannot be instantiated multiple times. Instead either set multiInstance:false or use the storage inside of the SharedWorker RxStorage.  https://rxdb.info/rx-storage-shared-worker.html ")}var i=e.databaseInstanceToken,s=I(e);s.schema=function(e){var t=e.encrypted&&e.encrypted.length>0,n={title:"RxJsonSchemaMemoryMappedPersistenceBlock",primaryKey:"id",type:"object",version:e.version,keyCompression:e.keyCompression,properties:{id:{type:"string",maxLength:Fi,minLength:Fi},c:{type:"boolean"},s:{type:"array",items:{type:"string",maxLength:Fi,minLength:Fi}},d:{type:"array",minItems:1,items:{type:"object",properties:e.properties,required:e.required,additionalProperties:!1}}},required:["id","c","s","d"],encrypted:t?["d"]:void 0,indexes:[["c"]]};return t&&(n.properties.d={type:"string"}),C(n)}(e.schema),s.multiInstance=!1;var a=this.settings.storage.createStorageInstance(s),c=I(e.schema);delete c.encrypted;var u={databaseName:e.databaseName,collectionName:e.collectionName+"-memory-mapped-instance"+m(12),schema:c,multiInstance:!1,databaseInstanceToken:i,options:e.options,devMode:e.devMode},l=await rs.createStorageInstance(u),f=new ns,d={persistentInstancePromise:a,cacheKey:t,refCount:1,leaderElector:r,conflictResultionTasks$:new Fr,memoryInstance:l,blockMap:f,initDonePromise:is(await a,l,f)};return new ts(this,e.databaseName,e.collectionName,i,e.schema,d,e.options,e.devMode)})().catch((e=>{throw this.openInstances.delete(t),r&&r.broadcastChannel.close(),e}));return this.openInstances.set(t,o),o},e}();async function is(e,t,n){var r,o=N(t.schema.primaryKey),i=t.internals,s=i.documents,a=Object.values(i.byIndex),c=a.length,u=a.map((e=>e.docsWithIndex)),l=a.map((e=>e.getIndexableString)),f=new Map;function d(e,t){s.set(t,e);for(var n=0;n<c;++n){var r=l[n](e);u[n].push([r,e,t])}}for(var[h,p]=await Promise.all([(async()=>{var t=await Qi(e),i=t[0];i&&(!r||i.id>r)&&(r=i.id);for(var s=new Set,a=0;a<t.length;a++)for(var c=t[a],u=c.d,l=c.id,f=0;f<u.length;f++){var h=u[f],p=h[o];s.has(p)?n.addCleanup(p,l):(d(h,p),s.add(p),n.add(p,l))}return{docsInCleanup:s,nonCleanedBlocks:t}})(),(async()=>{var t=await e.query(F(e.schema,sn(e.schema,{selector:{c:{$eq:!0},_deleted:{$eq:!1}},sort:[{id:"asc"}]}))),n=S(t.documents);return n&&(!r||n.id>r)&&(r=n.id),t.documents})()]),m=h.docsInCleanup,v=0;v<p.length;v++)for(var y=p[v],b=y.d,g=y.id,w=0;w<b.length;w++){var x=b[w],I=x[o];m.has(I)?n.addCleanup(I,g):(n.add(I,g),d(x,I))}for(var _=0;_<c;++_){var O=a[_];O.docsWithIndex=O.docsWithIndex.sort(ss)}return{lastBlockId:r,toCleanupByBlockId:f}}function ss(e,t){return e[0]<t[0]?-1:1}function as(e,t){return{connectionId:e.connectionId,answerTo:e.requestId,method:e.method,error:(n=t,{name:n.name,message:n.message,rxdb:n.rxdb,parameters:n.parameters,extensions:n.extensions,code:n.code,url:n.url,stack:n.stack?n.stack.replace(/\n/g," \n "):void 0})};var n}function cs(e,t){return{connectionId:e.connectionId,answerTo:e.requestId,method:e.method,return:t}}!function(e){var t;console.log("exposeWorkerRxStorage()");var n=new Fr;if("undefined"!=typeof self&&"object"==typeof self.onconnect){var r=new Map;self.onconnect=e=>{var t=e.ports[0];t.onmessage=e=>{var o=e.data;r.set(o.connectionId,t),n.next(o)}},t={storage:e.storage,messages$:n,send(e){xn(r,e.connectionId).postMessage(e)}}}else addEventListener("message",(e=>{var t=e.data;n.next(t)})),t={storage:e.storage,messages$:n,send(e){self.postMessage(e)}};!function(e){var t=new Map;function n(t){if(e.storage)return e.storage.createStorageInstance(t);if(e.database){var n=Array.from(e.database.storageInstances),r=t.collectionName,o=n.find((e=>e.collectionName===r));if(!o)throw console.dir(n),new Error("storageInstance does not exist "+JSON.stringify({collectionName:r}));var i=t.schema;if(!gi(i,o.schema))throw new Error("Wrong schema "+JSON.stringify({schema:i,existingSchema:o.schema}));return Promise.resolve(o)}throw new Error("no base given")}e.messages$.pipe(Vi((e=>"custom"===e.method))).subscribe((async t=>{if(e.customRequestHandler)try{var n=await e.customRequestHandler(t.params);e.send(cs(t,n))}catch(n){e.send(as(t,n))}else e.send(as(t,new Error("Remote storage: cannot resolve custom request because settings.customRequestHandler is not set")))})),e.messages$.pipe(Vi((e=>"create"===e.method))).subscribe((async r=>{var o=r.connectionId;if(!Array.isArray(r.params)){var i=r.params,s=i.collectionName,a=[i.databaseName,i.collectionName,i.schema.version].join("|"),c=t.get(a);if(c){if(!gi(i.schema,c.params.schema))return void e.send(as(r,new Error("Remote storage: schema not equal to existing storage")))}else try{c={storageInstancePromise:n(i),connectionIds:new Set,params:i},t.set(a,c),await c.storageInstancePromise}catch(t){return void e.send(as(r,t))}c.connectionIds.add(r.connectionId);var u=[],l=await c.storageInstancePromise;u.push(l.changeStream().subscribe((t=>{var n={connectionId:o,answerTo:"changestream",method:"changeStream",return:t};e.send(n)}))),u.push(l.conflictResultionTasks().subscribe((t=>{var n={connectionId:o,answerTo:"conflictResultionTasks",method:"conflictResultionTasks",return:t};e.send(n)})));var f=!1;if(e.database){var d=e.database,h=d.collections[s];h?h.onDestroy.push((()=>p())):d.onDestroy.push((()=>p()))}u.push(e.messages$.pipe(Vi((e=>e.connectionId===o))).subscribe((async t=>{var n,r=t;if("create"!==r.method&&"custom"!==r.method&&Array.isArray(r.params))try{if("close"===r.method&&e.database)return void e.send(cs(r,null));if("close"===r.method&&M(c).connectionIds.size>1)return e.send(cs(r,null)),M(c).connectionIds.delete(o),void u.forEach((e=>e.unsubscribe()));n="getChangedDocumentsSince"!==r.method||l.getChangedDocumentsSince?await l[r.method](r.params[0],r.params[1],r.params[2],r.params[3]):await vn(l,r.params[0],r.params[1]),"close"!==r.method&&"remove"!==r.method||p(),e.send(cs(r,n))}catch(t){e.send(as(r,t))}}))),e.send(cs(r,"ok"))}function p(){f||(f=!0,u.forEach((e=>e.unsubscribe())),M(c).connectionIds.delete(o),t.delete(a))}}))}(t)}({storage:(es={storage:function(e={}){var t=e.IDBKeyRange?e.IDBKeyRange:IDBKeyRange,n=e.indexedDB?e.indexedDB:indexedDB,r=Object.assign({batchSize:300,transactionDurability:"relaxed"},e,{IDBKeyRange:t,indexedDB:n});return new ci(r)}({})},new os(es))})})();